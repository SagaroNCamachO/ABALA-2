<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABALA - Gesti√≥n de Campeonatos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.4em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-top: 5px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .data-section {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .data-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .data-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .data-item .info {
            font-size: 0.85em;
            color: #666;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .response {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state::before {
            content: "üìã";
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }
        
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .chip {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÄ ABALA</h1>
            <p style="font-size: 1.1em; opacity: 0.95;">Sistema de Gesti√≥n de Campeonatos de B√°squetbol</p>
        </div>
        
        <div class="main-grid">
            <!-- Panel Izquierdo: Crear/Gestionar -->
            <div class="card">
                <h2>‚öôÔ∏è Gesti√≥n</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('create')">Crear</button>
                    <button class="tab" onclick="switchTab('manage')">Gestionar</button>
                </div>
                
                <!-- Tab: Crear -->
                <div id="createTab" class="tab-content active">
                    <div class="form-group">
                        <label>Acci√≥n:</label>
                        <select id="actionSelect" onchange="updateForm()">
                            <option value="createChamp" selected>Crear Campeonato</option>
                            <option value="addCategory">Agregar Categor√≠a</option>
                        </select>
                    </div>
                    
                    <div id="dynamicForm"></div>
                    
                    <button class="btn" onclick="executeAction()">Ejecutar</button>
                    <button class="btn btn-secondary" onclick="loadData()">üîÑ Actualizar Datos</button>
                </div>
                
                <!-- Tab: Gestionar -->
                <div id="manageTab" class="tab-content">
                    <div class="form-group">
                        <label>Ver:</label>
                        <select id="viewSelect" onchange="loadView()">
                            <option value="standings">Tabla de Posiciones</option>
                            <option value="fixture">Fixture</option>
                            <option value="championship">Campeonato Completo</option>
                        </select>
                    </div>
                    
                    <div id="viewForm"></div>
                    <button class="btn" onclick="loadViewData()">Ver</button>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <h3 style="color: #667eea; font-size: 1.1em; margin-bottom: 15px;">üíæ Guardar y Exportar</h3>
                        
                        <div class="form-group">
                            <label>Campeonato:</label>
                            <select id="exportChampSelect">
                                <option value="">Selecciona campeonato</option>
                            </select>
                        </div>
                        
                        <button class="btn" onclick="saveChampionship()" style="background: #28a745; margin-bottom: 10px;">
                            üíæ Guardar Campeonato (JSON)
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadChampionship()" style="background: #17a2b8; margin-bottom: 10px;">
                            üìÇ Cargar Campeonato Guardado
                        </button>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <button class="btn btn-secondary" onclick="exportFixture()" style="background: #ffc107; color: #000; margin-bottom: 10px;">
                                üìÑ Exportar Fixture (PDF)
                            </button>
                            
                            <button class="btn btn-secondary" onclick="exportStandings()" style="background: #ffc107; color: #000;">
                                üìä Exportar Tabla de Posiciones (PDF)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Derecho: Datos Creados -->
            <div class="card">
                <h2>üìä Datos Creados</h2>
                
                <div class="tabs">
                    <button class="tab active" onclick="switchDataTab('championships')">Campeonatos</button>
                    <button class="tab" onclick="switchDataTab('categories')">Categor√≠as</button>
                </div>
                
                <div id="championshipsTab" class="tab-content active data-section">
                    <div id="championshipsList"></div>
                </div>
                
                <div id="categoriesTab" class="tab-content data-section">
                    <div id="categoriesList"></div>
                </div>
            </div>
        </div>
        
        <!-- Respuesta -->
        <div class="card" id="responseCard" style="display: none;">
            <h2>üì§ Respuesta</h2>
            <div id="response" class="response"></div>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin;
        let championshipsData = {};
        let categoriesData = {};
        
        // Cargar datos al iniciar
        window.onload = () => {
            loadData();
        };
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'create') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('createTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('manageTab').classList.add('active');
            }
        }
        
        function switchDataTab(tab) {
            document.querySelectorAll('#championshipsTab, #categoriesTab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach((t, i) => {
                if ((tab === 'championships' && i === 0) || (tab === 'categories' && i === 1)) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            if (tab === 'championships') {
                document.getElementById('championshipsTab').classList.add('active');
            } else {
                document.getElementById('categoriesTab').classList.add('active');
            }
        }
        
        async function loadData() {
            try {
                // Primero cargar desde localStorage
                loadFromLocalStorage();
                
                // Luego obtener la lista de campeonatos del servidor
                const res = await fetch(`${API_BASE}/api/championships`);
                const data = await res.json();
                
                if (data.success) {
                    const champList = data.championships || {};
                    
                    // Cargar datos completos de cada campeonato
                    const loadPromises = Object.keys(champList).map(async (id) => {
                        try {
                            const champRes = await fetch(`${API_BASE}/api/championships/${id}`);
                            const champData = await champRes.json();
                            
                            if (champData.success && champData.championship) {
                                championshipsData[id] = {
                                    name: champData.championship.name,
                                    rounds: champData.championship.rounds,
                                    points_per_win: champData.championship.points_per_win,
                                    points_per_loss: champData.championship.points_per_loss,
                                    categories: champData.championship.categories || {}
                                };
                                
                                // Extraer categor√≠as con equipos
                                if (champData.championship.categories) {
                                    categoriesData[id] = champData.championship.categories;
                                } else {
                                    categoriesData[id] = {};
                                } else {
                                    categoriesData[id] = {};
                                }
                                
                                // Guardar en localStorage
                                saveToLocalStorage(id, championshipsData[id]);
                            } else {
                                // Si falla, usar datos del resumen
                                championshipsData[id] = champList[id];
                                saveToLocalStorage(id, championshipsData[id]);
                            }
                        } catch (error) {
                            console.error(`Error cargando campeonato ${id}:`, error);
                            championshipsData[id] = champList[id];
                            saveToLocalStorage(id, championshipsData[id]);
                        }
                    });
                    
                    await Promise.all(loadPromises);
                    
                    renderChampionships();
                    renderCategories();
                    updateForm(); // Actualizar formularios con datos disponibles
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                // Si falla el servidor, cargar desde localStorage
                loadFromLocalStorage();
                renderChampionships();
                renderCategories();
                updateForm(); // Actualizar formularios con datos cargados
                showAlert('Cargando desde almacenamiento local (servidor no disponible)', 'warning');
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                Object.entries(saved).forEach(([id, champ]) => {
                    if (!championshipsData[id]) {
                        championshipsData[id] = champ;
                    }
                });
            } catch (error) {
                console.error('Error cargando desde localStorage:', error);
            }
        }
        
        function saveToLocalStorage(champId, champData) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                saved[champId] = {
                    ...champData,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('savedChampionships', JSON.stringify(saved));
            } catch (error) {
                console.error('Error guardando en localStorage:', error);
            }
        }
        
        function renderChampionships() {
            const list = document.getElementById('championshipsList');
            
            if (Object.keys(championshipsData).length === 0) {
                list.innerHTML = '<div class="empty-state">No hay campeonatos creados</div>';
                return;
            }
            
            list.innerHTML = Object.entries(championshipsData).map(([id, champ]) => `
                <div class="data-item" style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; cursor: pointer;" onclick="loadChampionshipDetails('${id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <strong style="font-size: 1.2em; color: #667eea;">${champ.name || id}</strong>
                            <div class="info" style="margin-top: 8px; color: #666; font-size: 0.9em;">
                                <div>ID: <code>${id}</code></div>
                                <div>Vueltas: ${champ.rounds || 'N/A'}</div>
                                <div>Categor√≠as: ${champ.categories ? Object.keys(champ.categories).length : 0}</div>
                                <div>Puntos por Victoria: ${champ.points_per_win || 2} | Derrota: ${champ.points_per_loss || 0}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; flex-direction: column;">
                            <button onclick="event.stopPropagation(); loadChampionshipDetails('${id}')" 
                                style="padding: 5px 10px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                                üëÅÔ∏è Ver
                            </button>
                            <button onclick="event.stopPropagation(); deleteChampionship('${id}')" 
                                style="padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.85em;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                    ${champ.categories ? `<div class="chips" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">${Object.keys(champ.categories).map(cat => `<span class="chip" style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${cat}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }
        
        async function loadChampionshipDetails(champId) {
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}`);
                const data = await res.json();
                
                if (data.success) {
                    // Mostrar detalles en el panel de respuesta
                    const responseCard = document.getElementById('responseCard');
                    const responseDiv = document.getElementById('response');
                    
                    responseCard.style.display = 'block';
                    responseDiv.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üìã Detalles del Campeonato: ${data.championship.name}</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>ID:</strong> <code>${champId}</code></p>
                                <p><strong>Vueltas:</strong> ${data.championship.rounds}</p>
                                <p><strong>Puntos por Victoria:</strong> ${data.championship.points_per_win}</p>
                                <p><strong>Puntos por Derrota:</strong> ${data.championship.points_per_loss}</p>
                            </div>
                            
                            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Categor√≠as:</h4>
                            ${Object.keys(data.championship.categories || {}).length > 0 
                                ? Object.entries(data.championship.categories || {}).map(([catName, cat]) => `
                                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                                        <strong>${catName}</strong>
                                        <div style="margin-top: 8px;">
                                            <strong>Equipos (${cat.teams?.length || 0}):</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                                ${cat.teams?.map(t => `<span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">${t.name || t}</span>`).join('') || 'Sin equipos'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                                : '<p style="color: #666;">No hay categor√≠as creadas</p>'
                            }
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button onclick="saveChampionshipToLocal('${champId}')" 
                                    style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üíæ Guardar Localmente
                                </button>
                                <button onclick="loadChampionshipFromLocal('${champId}')" 
                                    style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üìÇ Cargar desde Local
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Scroll a la respuesta
                    responseCard.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('Error al cargar detalles: ' + error.message, 'error');
            }
        }
        
        async function deleteChampionship(champId) {
            if (!confirm(`¬øEst√°s seguro de eliminar el campeonato "${championshipsData[champId]?.name || champId}"? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                // Eliminar del servidor
                const res = await fetch(`${API_BASE}/api/championships/${champId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success || res.status === 200) {
                    // Eliminar del localStorage PRIMERO
                    removeChampionshipFromLocal(champId);
                    
                    // Eliminar de memoria
                    delete championshipsData[champId];
                    delete categoriesData[champId];
                    
                    // Renderizar inmediatamente para actualizar la vista
                    renderChampionships();
                    renderCategories();
                    updateForm();
                    updateExportSelect();
                    
                    showAlert('Campeonato eliminado exitosamente', 'success');
                    
                    // Recargar datos despu√©s de un momento
                    setTimeout(() => loadData(), 500);
                } else {
                    showAlert(data.error || 'Error al eliminar', 'error');
                }
            } catch (error) {
                console.error('Error eliminando campeonato:', error);
                // Si falla el servidor, eliminar solo del localStorage
                removeChampionshipFromLocal(champId);
                delete championshipsData[champId];
                delete categoriesData[champId];
                
                // Renderizar inmediatamente
                renderChampionships();
                renderCategories();
                updateForm();
                updateExportSelect();
                
                showAlert('Campeonato eliminado del almacenamiento local (servidor no disponible)', 'warning');
                setTimeout(() => loadData(), 500);
            }
        }
        
        function saveChampionshipToLocal(champId) {
            try {
                const champ = championshipsData[champId];
                if (!champ) {
                    showAlert('Campeonato no encontrado', 'error');
                    return;
                }
                
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                saved[champId] = {
                    ...champ,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('savedChampionships', JSON.stringify(saved));
                showAlert('Campeonato guardado localmente', 'success');
            } catch (error) {
                showAlert('Error al guardar: ' + error.message, 'error');
            }
        }
        
        function loadChampionshipFromLocal(champId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                const champ = saved[champId];
                
                if (!champ) {
                    showAlert('Campeonato no encontrado en almacenamiento local', 'error');
                    return;
                }
            
                showAlert('Campeonato cargado desde almacenamiento local', 'success');
                // Los datos ya est√°n en championshipsData, solo recargamos la vista
                renderChampionships();
            } catch (error) {
                showAlert('Error al cargar: ' + error.message, 'error');
            }
        }
        
        function removeChampionshipFromLocal(champId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                if (saved[champId]) {
                    delete saved[champId];
                    localStorage.setItem('savedChampionships', JSON.stringify(saved));
                    console.log(`Campeonato ${champId} eliminado de localStorage`);
                }
            } catch (error) {
                console.error('Error al eliminar del localStorage:', error);
            }
        }
        
        function renderCategories() {
            const list = document.getElementById('categoriesList');
            
            if (Object.keys(categoriesData).length === 0) {
                list.innerHTML = '<div class="empty-state">No hay categor√≠as creadas</div>';
                return;
            }
            
            let html = '';
            for (const [champId, categories] of Object.entries(categoriesData)) {
                for (const [catName, cat] of Object.entries(categories)) {
                    html += `
                        <div class="data-item" onclick="selectCategory('${champId}', '${catName}')">
                            <strong>${catName}</strong>
                            <div class="info">
                                Campeonato: ${championshipsData[champId]?.name || champId}<br>
                                Equipos: ${cat.teams ? cat.teams.length : 0}<br>
                                Partidos: ${cat.matches ? cat.matches.length : 0}
                            </div>
                        </div>
                    `;
                }
            }
            list.innerHTML = html || '<div class="empty-state">No hay categor√≠as</div>';
        }
        
        function selectChampionship(id) {
            const champ = championshipsData[id];
            if (!champ) return;
            
            // Auto-rellenar formularios
            document.getElementById('champId')?.setAttribute('value', id);
            document.getElementById('champIdSelect')?.setAttribute('value', id);
            document.getElementById('champIdView')?.setAttribute('value', id);
            
            // Mostrar alerta
            showAlert(`Campeonato "${champ.name || id}" seleccionado`, 'success');
        }
        
        function selectCategory(champId, catName) {
            // Auto-rellenar formularios
            document.getElementById('categoryName')?.setAttribute('value', catName);
            document.getElementById('categorySelect')?.setAttribute('value', catName);
            document.getElementById('categoryView')?.setAttribute('value', catName);
            document.getElementById('champId')?.setAttribute('value', champId);
            
            showAlert(`Categor√≠a "${catName}" seleccionada`, 'success');
        }
        
        function updateForm() {
            const actionSelect = document.getElementById('actionSelect');
            if (!actionSelect) {
                console.error('actionSelect no encontrado');
                return;
            }
            
            const action = actionSelect.value || 'createChamp';
            const formDiv = document.getElementById('dynamicForm');
            
            if (!formDiv) {
                console.error('dynamicForm no encontrado');
                return;
            }
            
            let html = '';
            
            // Obtener IDs de campeonatos disponibles
            const champIds = Object.keys(championshipsData);
            const champOptions = champIds.length > 0 
                ? champIds.map(id => `<option value="${id}">${championshipsData[id].name || id}</option>`).join('')
                : '<option value="">No hay campeonatos</option>';
            
            switch(action) {
                case 'createChamp':
                    html = `
                        <div class="form-group">
                            <label>ID del Campeonato:</label>
                            <input type="text" id="champId" placeholder="champ1" value="champ${champIds.length + 1}">
                        </div>
                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" id="name" placeholder="Campeonato 2024" value="Campeonato ${new Date().getFullYear()}">
                        </div>
                        <div class="form-group">
                            <label>Vueltas:</label>
                            <input type="number" id="rounds" value="2" min="1">
                        </div>
                        <div class="form-group">
                            <label>Puntos por Victoria:</label>
                            <input type="number" id="pointsWin" value="2" min="0">
                        </div>
                        <div class="form-group">
                            <label>Puntos por Derrota:</label>
                            <input type="number" id="pointsLoss" value="0" min="0">
                        </div>
                    `;
                    break;
                case 'addCategory':
                    html = `
                        <div class="form-group">
                            <label>Campeonato:</label>
                            <select id="champIdSelect" onchange="loadCategoryTeams()">
                                ${champOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Nombre de la Categor√≠a:</label>
                            <input type="text" id="categoryName" placeholder="TC" list="categorySuggestions">
                            <datalist id="categorySuggestions">
                                <option value="TC">
                                <option value="Senior">
                                <option value="Super Senior">
                            </datalist>
                        </div>
                        <div class="form-group">
                            <label>Equipos (separados por comas):</label>
                            <input type="text" id="teams" placeholder="Equipo A, Equipo B, Equipo C">
                        </div>
                        <div class="form-group">
                            <label>O n√∫mero de equipos (nombres autom√°ticos):</label>
                            <input type="number" id="numTeams" placeholder="4" min="2">
                        </div>
                    `;
                    break;
            }
            
            formDiv.innerHTML = html;
        }
        
        function loadCategoryTeams() {
            const champId = document.getElementById('champIdSelect')?.value;
            if (!champId || !championshipsData[champId]) return;
            
            const categories = categoriesData[champId] || {};
            const categorySelect = document.getElementById('categorySelect');
            
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                    Object.keys(categories).map(cat => 
                        `<option value="${cat}">${cat}</option>`
                    ).join('');
                
                categorySelect.onchange = loadTeams;
            }
            
            loadTeams();
        }
        
        function loadTeams() {
            const champId = document.getElementById('champIdSelect')?.value;
            const category = document.getElementById('categorySelect')?.value;
            
            if (!champId || !category || !categoriesData[champId] || !categoriesData[champId][category]) {
                return;
            }
            
            const teams = categoriesData[champId][category].teams || [];
            const teamOptions = teams.map(team => 
                `<option value="${team.name || team}">${team.name || team}</option>`
            ).join('');
            
            ['teamA', 'teamB', 'teamSelect'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Selecciona equipo</option>' + teamOptions;
                }
            });
        }
        
        async function executeAction() {
            const action = document.getElementById('actionSelect').value;
            const responseDiv = document.getElementById('response');
            const responseCard = document.getElementById('responseCard');
            
            responseCard.style.display = 'block';
            responseDiv.innerHTML = '<pre>Cargando...</pre>';
            
            let url, options = {};
            
            try {
                switch(action) {
                    case 'createChamp':
                        url = `${API_BASE}/api/championships`;
                        options = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: document.getElementById('champId').value,
                                name: document.getElementById('name').value,
                                rounds: parseInt(document.getElementById('rounds').value),
                                points_per_win: parseInt(document.getElementById('pointsWin').value),
                                points_per_loss: parseInt(document.getElementById('pointsLoss').value)
                            })
                        };
                        break;
                    case 'addCategory':
                        const champId = document.getElementById('champIdSelect').value;
                        
                        if (!champId) {
                            showAlert('Por favor selecciona un campeonato', 'error');
                            return;
                        }
                        
                        const categoryName = document.getElementById('categoryName').value;
                        if (!categoryName) {
                            showAlert('Por favor ingresa el nombre de la categor√≠a', 'error');
                            return;
                        }
                        
                        url = `${API_BASE}/api/championships/${champId}/categories`;
                        const teamsInput = document.getElementById('teams').value;
                        const numTeams = document.getElementById('numTeams').value;
                        
                        const body = {
                            name: categoryName
                        };
                        
                        if (teamsInput && teamsInput.trim()) {
                            const teams = teamsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
                            if (teams.length > 0) {
                                body.teams = teams;
                            } else {
                                showAlert('Por favor ingresa al menos un equipo', 'error');
                                return;
                            }
                        } else if (numTeams && parseInt(numTeams) >= 2) {
                            body.num_teams = parseInt(numTeams);
                        } else {
                            showAlert('Debes proporcionar equipos (separados por comas) o un n√∫mero de equipos (m√≠nimo 2)', 'error');
                            return;
                        }
                        
                        options = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        };
                        break;
                }
                
                const res = await fetch(url, options);
                const data = await res.json();
                
                responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                if (data.success) {
                    showAlert('Operaci√≥n exitosa', 'success');
                    // Guardar en localStorage si se cre√≥ un campeonato
                    if (action === 'createChamp' && data.id) {
                        const champId = data.id;
                        setTimeout(async () => {
                            try {
                                const champRes = await fetch(`${API_BASE}/api/championships/${champId}`);
                                const champData = await champRes.json();
                                if (champData.success) {
                                    saveToLocalStorage(champId, {
                                        name: champData.championship.name,
                                        rounds: champData.championship.rounds,
                                        points_per_win: champData.championship.points_per_win,
                                        points_per_loss: champData.championship.points_per_loss,
                                        categories: champData.championship.categories || {}
                                    });
                                }
                            } catch (error) {
                                console.error('Error guardando en localStorage:', error);
                            }
                        }, 500);
                    }
                    // Recargar datos despu√©s de crear/modificar
                    if (action === 'createChamp' || action === 'addCategory') {
                        // Si se cre√≥ una categor√≠a, actualizar inmediatamente los datos del campeonato
                        if (action === 'addCategory' && data.success) {
                            const champId = document.getElementById('champIdSelect')?.value;
                            if (champId) {
                                // Cargar el campeonato completo para obtener la categor√≠a reci√©n creada
                                fetch(`${API_BASE}/api/championships/${champId}`)
                                    .then(res => res.json())
                                    .then(champData => {
                                        if (champData.success && champData.championship) {
                                            // Actualizar datos en memoria
                                            championshipsData[champId] = {
                                                name: champData.championship.name,
                                                rounds: champData.championship.rounds,
                                                points_per_win: champData.championship.points_per_win,
                                                points_per_loss: champData.championship.points_per_loss,
                                                categories: champData.championship.categories || {}
                                            };
                                            
                                            // Actualizar categoriesData
                                            if (champData.championship.categories) {
                                                categoriesData[champId] = champData.championship.categories;
                                            }
                                            
                                            // Guardar en localStorage
                                            saveToLocalStorage(champId, championshipsData[champId]);
                                            
                                            // Renderizar
                                            renderChampionships();
                                            renderCategories();
                                            updateForm();
                                        }
                                    })
                                    .catch(err => console.error('Error actualizando categor√≠a:', err));
                            }
                        }
                        
                        // Recargar datos despu√©s de un segundo
                        setTimeout(() => {
                            loadData();
                            renderChampionships();
                            renderCategories();
                            updateForm();
                        }, 1500);
                    }
                } else {
                    showAlert(data.error || 'Error en la operaci√≥n', 'error');
                }
            } catch (error) {
                responseDiv.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
                showAlert('Error de conexi√≥n', 'error');
            }
        }
        
        function loadView() {
            const view = document.getElementById('viewSelect').value;
            const formDiv = document.getElementById('viewForm');
            const champIds = Object.keys(championshipsData);
            const champOptions = champIds.map(id => `<option value="${id}">${championshipsData[id].name || id}</option>`).join('');
            
            let html = `
                <div class="form-group">
                    <label>Campeonato:</label>
                    <select id="champIdView" onchange="loadViewCategories()">
                        ${champOptions}
                    </select>
                </div>
            `;
            
            if (view === 'standings' || view === 'fixture') {
                html += `
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="categoryView">
                            <option value="">Selecciona categor√≠a</option>
                        </select>
                    </div>
                `;
                
                if (view === 'fixture') {
                    html += `
                        <div class="form-group">
                            <label>Vuelta (opcional):</label>
                            <input type="number" id="roundView" placeholder="Dejar vac√≠o para todas" min="1">
                        </div>
                    `;
                }
            }
            
            formDiv.innerHTML = html;
            if (champIds.length > 0) {
                setTimeout(() => loadViewCategories(), 100);
            }
        }
        
        function loadViewCategories() {
            const champId = document.getElementById('champIdView')?.value;
            if (!champId || !categoriesData[champId]) return;
            
            const categories = Object.keys(categoriesData[champId]);
            const categoryView = document.getElementById('categoryView');
            
            if (categoryView) {
                categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }
        }
        
        async function loadViewData() {
            const view = document.getElementById('viewSelect').value;
            const champId = document.getElementById('champIdView')?.value;
            const responseDiv = document.getElementById('response');
            const responseCard = document.getElementById('responseCard');
            
            if (!champId) {
                showAlert('Selecciona un campeonato', 'error');
                return;
            }
            
            responseCard.style.display = 'block';
            responseDiv.innerHTML = '<pre>Cargando...</pre>';
            
            try {
                let url;
                
                if (view === 'standings') {
                    const category = document.getElementById('categoryView').value;
                    if (!category) {
                        showAlert('Selecciona una categor√≠a', 'error');
                        return;
                    }
                    url = `${API_BASE}/api/championships/${champId}/standings/${category}`;
                } else if (view === 'fixture') {
                    const category = document.getElementById('categoryView').value;
                    if (!category) {
                        showAlert('Selecciona una categor√≠a', 'error');
                        return;
                    }
                    const round = document.getElementById('roundView').value;
                    url = `${API_BASE}/api/championships/${champId}/fixture/${category}`;
                    if (round) url += `?round=${round}`;
                    window.currentCategory = category; // Guardar para usar en renderFixture
                } else {
                    url = `${API_BASE}/api/championships/${champId}`;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data.success) {
                    showAlert(data.error || 'Error', 'error');
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    return;
                }
                
                // Renderizar seg√∫n el tipo de vista
                if (view === 'fixture' && data.matches) {
                    const category = document.getElementById('categoryView').value;
                    responseDiv.innerHTML = renderFixture(data.matches, category || 'Categor√≠a');
                } else if (view === 'standings' && data.standings) {
                    responseDiv.innerHTML = renderStandings(data.standings);
                } else {
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                responseDiv.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
                showAlert('Error de conexi√≥n', 'error');
            }
        }
        
        function renderFixture(matches, categoryName) {
            if (!matches || matches.length === 0) {
                return '<div class="empty-state">No hay partidos en el fixture</div>';
            }
            
            // Agrupar partidos por tipo (ida/vuelta) y luego por jornada
            const matchesByVuelta = {
                'ida': {},
                'vuelta': {}
            };
            
            matches.forEach(match => {
                const matchType = match.match_type || 'ida';
                const matchday = match.matchday || 1;
                
                if (!matchesByVuelta[matchType]) {
                    matchesByVuelta[matchType] = {};
                }
                if (!matchesByVuelta[matchType][matchday]) {
                    matchesByVuelta[matchType][matchday] = [];
                }
                matchesByVuelta[matchType][matchday].push(match);
            });
            
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            // Calcular total de partidos
            const totalPartidos = matches.length;
            const partidosJugados = matches.filter(m => m.played).length;
            const partidosPendientes = totalPartidos - partidosJugados;
            
            let html = `<div style="padding: 25px; font-size: 16px;">
                <h3 style="color: #667eea; margin-bottom: 20px; font-size: 2em; font-weight: 700;">üìÖ Fixture - ${categoryName}</h3>
                <div style="background: linear-gradient(135deg, #f0f8ff 0%, #e0e8f0 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="text-align: center;">
                        <div style="font-size: 3.5em; font-weight: bold; color: #667eea; margin-bottom: 8px;">${totalPartidos}</div>
                        <div style="font-size: 1.2em; color: #666; font-weight: 600;">Total Partidos</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3.5em; font-weight: bold; color: #28a745; margin-bottom: 8px;">${partidosJugados}</div>
                        <div style="font-size: 1.2em; color: #666; font-weight: 600;">Jugados</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 3.5em; font-weight: bold; color: #dc3545; margin-bottom: 8px;">${partidosPendientes}</div>
                        <div style="font-size: 1.2em; color: #666; font-weight: 600;">Pendientes</div>
                    </div>
                </div>
            `;
            
            // Mostrar Vuelta 1 (ida) y Vuelta 2 (vuelta)
            const vueltaOrder = ['ida', 'vuelta'];
            
            vueltaOrder.forEach((matchType, index) => {
                const vueltaNum = index + 1;
                const vueltaMatches = matchesByVuelta[matchType];
                
                if (!vueltaMatches || Object.keys(vueltaMatches).length === 0) {
                    return; // Saltar si no hay partidos de este tipo
                }
                
                html += `
                    <div style="margin-bottom: 40px; border: 3px solid #e0e0e0; border-radius: 20px; padding: 25px; background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%); box-shadow: 0 6px 20px rgba(0,0,0,0.1);">
                        <h4 style="color: #667eea; margin-bottom: 25px; font-size: 1.8em; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                            <span>Vuelta ${vueltaNum}</span>
                            <span style="font-size: 0.6em; color: #999; font-weight: normal; background: #e9ecef; padding: 6px 12px; border-radius: 10px;">(${matchType})</span>
                        </h4>
                `;
                
                // Ordenar jornadas
                const matchdays = Object.keys(vueltaMatches).sort((a, b) => parseInt(a) - parseInt(b));
                
                // Mostrar jornadas (exactamente 2 partidos por jornada)
                matchdays.forEach(matchday => {
                    const jornadaMatches = vueltaMatches[matchday];
                    
                    // Verificar que solo haya m√°ximo 2 partidos por jornada
                    if (jornadaMatches.length > 2) {
                        console.warn(`Jornada ${matchday} tiene m√°s de 2 partidos: ${jornadaMatches.length}`);
                    }
                    
                    html += `
                        <div style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #fdfdfd 0%, #f0f0f0 100%); border-radius: 15px; border-left: 6px solid #667eea; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <h5 style="color: #667eea; margin-bottom: 20px; font-size: 1.5em; font-weight: 700;">
                                Jornada ${matchday}
                                <span style="font-size: 0.6em; color: #999; font-weight: normal; background: #e9ecef; padding: 4px 10px; border-radius: 8px; margin-left: 10px;">(${jornadaMatches.length} partido${jornadaMatches.length > 1 ? 's' : ''})</span>
                            </h5>
                            <div style="display: grid; gap: 20px;">
                    `;
                    
                    // Mostrar solo los primeros 2 partidos de la jornada
                    jornadaMatches.slice(0, 2).forEach((match, idx) => {
                        const matchId = `match_${vueltaNum}_${matchType}_${matchday}_${idx}`;
                        const played = match.played;
                        const scoreA = match.score_a !== null ? match.score_a : '';
                        const scoreB = match.score_b !== null ? match.score_b : '';
                        const date = match.date || '';
                        const time = match.time || '';
                        
                        html += `
                            <div style="padding: 25px; background: white; border-radius: 12px; border-left: 6px solid ${played ? '#28a745' : '#667eea'}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 20px;">
                                    <div style="text-align: right;">
                                        <strong style="font-size: 1.3em; color: #1e3c72; font-weight: 700;">${match.team_a}</strong>
                                    </div>
                                    <div style="display: flex; gap: 15px; align-items: center;">
                                        <input type="number" id="${matchId}_scoreA" value="${scoreA}" 
                                            placeholder="0" min="0" 
                                            style="width: 90px; padding: 15px; text-align: center; border: 3px solid #e0e0e0; border-radius: 10px; font-size: 1.3em; font-weight: 700;"
                                            ${played ? 'readonly' : ''}>
                                        <span style="font-weight: bold; color: #666; font-size: 1.5em;">-</span>
                                        <input type="number" id="${matchId}_scoreB" value="${scoreB}" 
                                            placeholder="0" min="0" 
                                            style="width: 90px; padding: 15px; text-align: center; border: 3px solid #e0e0e0; border-radius: 10px; font-size: 1.3em; font-weight: 700;"
                                            ${played ? 'readonly' : ''}>
                                    </div>
                                    <div style="text-align: left;">
                                        <strong style="font-size: 1.3em; color: #1e3c72; font-weight: 700;">${match.team_b}</strong>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: center;">
                                    <div>
                                        <label style="font-size: 1em; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Fecha:</label>
                                        <input type="date" id="${matchId}_date" value="${date}" 
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <div>
                                        <label style="font-size: 1em; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Horario:</label>
                                        <input type="time" id="${matchId}_time" value="${time}" 
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <div>
                                        <button onclick="saveMatch('${champId}', '${category}', '${match.team_a}', '${match.team_b}', ${match.round_number}, ${match.matchday}, '${matchId}')" 
                                            style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; white-space: nowrap; font-size: 1em; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                            ${played ? 'Actualizar' : 'Guardar'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            });
            
            html += `</div>`;
            return html;
        }
        
        async function saveMatch(champId, category, teamA, teamB, roundNumber, matchday, matchId) {
            const scoreA = parseInt(document.getElementById(`${matchId}_scoreA`).value) || 0;
            const scoreB = parseInt(document.getElementById(`${matchId}_scoreB`).value) || 0;
            const date = document.getElementById(`${matchId}_date`).value;
            const time = document.getElementById(`${matchId}_time`).value;
            
            try {
                // Guardar fecha y horario
                if (date || time) {
                    const scheduleRes = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}/schedule`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team_a: teamA,
                            team_b: teamB,
                            round_number: roundNumber,
                            matchday: matchday,
                            date: date,
                            time: time
                        })
                    });
                    
                    if (!scheduleRes.ok) {
                        const error = await scheduleRes.json();
                        showAlert(error.error || 'Error al guardar fecha/horario', 'error');
                    }
                }
                
                // Guardar resultado si hay scores
                if (scoreA >= 0 && scoreB >= 0) {
                    const resultRes = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}/result`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team_a: teamA,
                            team_b: teamB,
                            round_number: roundNumber,
                            matchday: matchday,
                            score_a: scoreA,
                            score_b: scoreB
                        })
                    });
                    
                    const resultData = await resultRes.json();
                    if (resultData.success) {
                        showAlert('Partido guardado exitosamente', 'success');
                        // Recargar vista
                        setTimeout(() => loadViewData(), 1000);
                    } else {
                        showAlert(resultData.error || 'Error al guardar resultado', 'error');
                    }
                } else if (date || time) {
                    showAlert('Fecha y horario guardados', 'success');
                    setTimeout(() => loadViewData(), 1000);
                } else {
                    showAlert('Ingresa al menos fecha/horario o resultado', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function renderStandings(standings) {
            if (!standings || standings.length === 0) {
                return '<div class="empty-state">No hay datos en la tabla de posiciones</div>';
            }
            
            let html = `
                <div style="padding: 10px; overflow-x: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìä Tabla de Posiciones</h3>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px; text-align: left;">Pos</th>
                                <th style="padding: 12px; text-align: left;">Equipo</th>
                                <th style="padding: 12px; text-align: center;">PJ</th>
                                <th style="padding: 12px; text-align: center;">PG</th>
                                <th style="padding: 12px; text-align: center;">PP</th>
                                <th style="padding: 12px; text-align: center;">PF</th>
                                <th style="padding: 12px; text-align: center;">PC</th>
                                <th style="padding: 12px; text-align: center;">Dif</th>
                                <th style="padding: 12px; text-align: center; font-weight: bold;">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            standings.forEach((team, index) => {
                const position = index + 1;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                const rowColor = position <= 3 ? '#f0f8ff' : index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                
                html += `
                    <tr style="background: ${rowColor};">
                        <td style="padding: 12px; font-weight: bold; color: #667eea;">${position} ${medal}</td>
                        <td style="padding: 12px; font-weight: 600;">${team.name}</td>
                        <td style="padding: 12px; text-align: center;">${team.pj || 0}</td>
                        <td style="padding: 12px; text-align: center; color: #28a745;">${team.pg || 0}</td>
                        <td style="padding: 12px; text-align: center; color: #dc3545;">${team.pp || 0}</td>
                        <td style="padding: 12px; text-align: center;">${team.pf || 0}</td>
                        <td style="padding: 12px; text-align: center;">${team.pc || 0}</td>
                        <td style="padding: 12px; text-align: center; color: ${team.difference >= 0 ? '#28a745' : '#dc3545'};">${team.difference || 0}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea; font-size: 1.1em;">${team.points || 0}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '1000';
            alert.style.minWidth = '300px';
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.3s';
                setTimeout(() => alert.remove(), 300);
            }, 3000);
        }
        
        function updateExportSelect() {
            const select = document.getElementById('exportChampSelect');
            if (!select) return;
            
            const champIds = Object.keys(championshipsData);
            select.innerHTML = '<option value="">Selecciona campeonato</option>' +
                champIds.map(id => 
                    `<option value="${id}">${championshipsData[id].name || id}</option>`
                ).join('');
        }
        
        async function saveChampionship() {
            const champId = document.getElementById('exportChampSelect').value;
            if (!champId) {
                showAlert('Selecciona un campeonato', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}`);
                const data = await res.json();
                
                if (data.success) {
                    const jsonData = JSON.stringify(data.championship, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `campeonato_${champId}_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('Campeonato guardado exitosamente', 'success');
                } else {
                    showAlert('Error al obtener el campeonato', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function loadChampionship() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Crear campeonato desde JSON
                    const res = await fetch(`${API_BASE}/api/championships`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: data.name?.toLowerCase().replace(/\s+/g, '_') + '_imported',
                            name: data.name,
                            rounds: data.rounds,
                            points_per_win: data.points_per_win,
                            points_per_loss: data.points_per_loss
                        })
                    });
                    
                    const result = await res.json();
                    if (result.success) {
                        // Agregar categor√≠as
                        for (const [catName, category] of Object.entries(data.categories || {})) {
                            const teams = category.teams?.map(t => t.name || t) || [];
                            await fetch(`${API_BASE}/api/championships/${result.id}/categories`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: catName,
                                    teams: teams
                                })
                            });
                        }
                        
                        showAlert('Campeonato cargado exitosamente', 'success');
                        setTimeout(() => loadData(), 1000);
                    }
                } catch (error) {
                    showAlert('Error al cargar: ' + error.message, 'error');
                }
            };
            input.click();
        }
        
        async function exportFixture() {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a en la vista de Fixture', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}`);
                const data = await res.json();
                
                if (data.success) {
                    // Crear HTML para imprimir
                    const html = generateFixtureHTML(data.matches, category, champId);
                    printHTML(html, `Fixture_${category}_${champId}`);
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function exportStandings() {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a en la vista de Tabla de Posiciones', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}/standings/${category}`);
                const data = await res.json();
                
                if (data.success) {
                    // Crear HTML para imprimir
                    const html = generateStandingsHTML(data.standings, category, champId);
                    printHTML(html, `Tabla_Posiciones_${category}_${champId}`);
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function generateFixtureHTML(matches, categoryName, champId) {
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Agrupar por vuelta y jornada
            const matchesByVuelta = { 'ida': {}, 'vuelta': {} };
            matches.forEach(match => {
                const matchType = match.match_type || 'ida';
                const matchday = match.matchday || 1;
                if (!matchesByVuelta[matchType][matchday]) {
                    matchesByVuelta[matchType][matchday] = [];
                }
                matchesByVuelta[matchType][matchday].push(match);
            });
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Fixture - ${categoryName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; }
                        .vuelta { margin-bottom: 30px; page-break-inside: avoid; }
                        .jornada { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; }
                        .match { padding: 10px; border-bottom: 1px solid #eee; }
                        .match:last-child { border-bottom: none; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üìÖ Fixture - ${categoryName}</h1>
                    <p><strong>Campeonato:</strong> ${champName}</p>
                    <p><strong>Total Partidos:</strong> ${matches.length}</p>
                    <hr>
            `;
            
            ['ida', 'vuelta'].forEach((matchType, index) => {
                const vueltaNum = index + 1;
                const vueltaMatches = matchesByVuelta[matchType];
                if (!vueltaMatches || Object.keys(vueltaMatches).length === 0) return;
                
                html += `<div class="vuelta"><h2>Vuelta ${vueltaNum} (${matchType})</h2>`;
                
                Object.keys(vueltaMatches).sort((a, b) => parseInt(a) - parseInt(b)).forEach(matchday => {
                    const jornadaMatches = vueltaMatches[matchday];
                    html += `<div class="jornada"><h3>Vuelta ${vueltaNum}, Jornada ${matchday}</h3>`;
                    
                    jornadaMatches.slice(0, 2).forEach(match => {
                        const scoreA = match.score_a !== null ? match.score_a : '-';
                        const scoreB = match.score_b !== null ? match.score_b : '-';
                        const date = match.date || 'Por definir';
                        const time = match.time || 'Por definir';
                        const status = match.played ? '‚úì Jugado' : 'Pendiente';
                        
                        html += `
                            <div class="match">
                                <strong>${match.team_a}</strong> ${scoreA} - ${scoreB} <strong>${match.team_b}</strong><br>
                                <small>Fecha: ${date} | Horario: ${time} | ${status}</small>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            html += `
                    <hr>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        Generado el ${new Date().toLocaleDateString('es-ES')}
                    </p>
                </body>
                </html>
            `;
            
            return html;
        }
        
        function generateStandingsHTML(standings, categoryName, champId) {
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Tabla de Posiciones - ${categoryName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #667eea; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f8f9fa; }
                        .pos-1, .pos-2, .pos-3 { font-weight: bold; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üìä Tabla de Posiciones - ${categoryName}</h1>
                    <p><strong>Campeonato:</strong> ${champName}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Equipo</th>
                                <th>PJ</th>
                                <th>PG</th>
                                <th>PP</th>
                                <th>PF</th>
                                <th>PC</th>
                                <th>Dif</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            standings.forEach((team, index) => {
                const pos = index + 1;
                html += `
                    <tr class="pos-${pos <= 3 ? pos : ''}">
                        <td>${pos}</td>
                        <td><strong>${team.name}</strong></td>
                        <td>${team.pj || 0}</td>
                        <td>${team.pg || 0}</td>
                        <td>${team.pp || 0}</td>
                        <td>${team.pf || 0}</td>
                        <td>${team.pc || 0}</td>
                        <td>${team.difference || 0}</td>
                        <td><strong>${team.points || 0}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    <hr>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        Generado el ${new Date().toLocaleDateString('es-ES')}
                    </p>
                </body>
                </html>
            `;
            
            return html;
        }
        
        function printHTML(html, filename) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            
            // Esperar a que cargue y luego imprimir
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
        
        // Actualizar select de exportaci√≥n cuando se cargan datos
        const originalLoadData = loadData;
        loadData = async function() {
            await originalLoadData();
            updateExportSelect();
        };
        
        // Inicializar
        updateForm();
        loadData();
    </script>
</body>
</html>
