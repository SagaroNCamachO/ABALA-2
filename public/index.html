<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABALA - Gesti√≥n de Campeonatos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèÄ</text></svg>">
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- SheetJS para exportaci√≥n a Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- html2canvas para exportar a im√°genes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 18px; /* Tama√±o base m√°s grande para mejor legibilidad */
            transition: background 0.3s ease;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-mode .card {
            background: #2d3748;
            color: #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .card h2 {
            color: #90cdf4;
        }
        
        body.dark-mode .btn {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: #e2e8f0;
        }
        
        body.dark-mode .btn:hover {
            background: linear-gradient(135deg, #5a6578 0%, #3d4758 100%);
        }
        
        body.dark-mode input, 
        body.dark-mode select, 
        body.dark-mode textarea {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        
        body.dark-mode .tab {
            color: #cbd5e0;
        }
        
        body.dark-mode .tab.active {
            color: #90cdf4;
            border-bottom-color: #90cdf4;
        }
        
        body.dark-mode table {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        body.dark-mode table thead {
            background: #4a5568;
        }
        
        body.dark-mode table tbody tr:hover {
            background: #374151;
        }
        
        body.dark-mode table tbody tr {
            border-bottom: 1px solid #4a5568;
        }
        
        body.dark-mode .empty-state {
            color: #cbd5e0;
        }
        
        body.dark-mode .alert {
            background: #2d3748;
            color: #e2e8f0;
            border-left-color: #90cdf4;
        }
        
        body.dark-mode .alert-success {
            background: #22543d;
            color: #9ae6b4;
        }
        
        body.dark-mode .alert-error {
            background: #742a2a;
            color: #feb2b2;
        }
        
        body.dark-mode .alert-warning {
            background: #744210;
            color: #fbd38d;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        
        .header h1 {
            font-size: 3em; /* M√°s grande */
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.3em; /* Subt√≠tulo m√°s grande */
            opacity: 0.95;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* ============================================
           RESPONSIVE DESIGN - MEDIA QUERIES
           ============================================ */
        
        /* Tablets y pantallas medianas */
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .header p {
                font-size: 1.1em;
            }
            
            .card {
                padding: 20px;
            }
            
            .card h2 {
                font-size: 1.8em;
            }
        }
        
        /* M√≥viles grandes y tablets peque√±as */
        /* Men√∫ hamburguesa para m√≥viles */
        .mobile-menu-toggle {
            display: none;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }
        
        .mobile-menu {
            display: none;
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 80px 20px 20px;
            z-index: 1001;
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        
        .mobile-menu.active {
            left: 0;
        }
        
        .mobile-menu-overlay.active {
            display: block;
        }
        
        .mobile-menu-item {
            display: block;
            padding: 15px;
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .mobile-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Estilos para modales */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.3);
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 15px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        /* Modal de autenticaci√≥n m√°s compacto y menos intrusivo */
        #authModal {
            background-color: rgba(0,0,0,0.2);
            backdrop-filter: blur(3px);
        }
        
        #authModal .modal-content {
            max-width: 380px;
            margin: 3% auto;
            padding: 25px;
        }
        
        /* Permitir hacer clic fuera del modal para cerrarlo */
        #authModal .modal {
            cursor: pointer;
        }
        
        #authModal .modal-content {
            cursor: default;
        }
        
        /* Panel de usuario siempre oculto */
        #userPanel {
            display: none !important;
            visibility: hidden !important;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
        }
        
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .modal-content {
                margin: 5% auto;
                padding: 20px;
            }
        }
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 2em;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .header > div {
                flex-direction: column;
                gap: 15px;
            }
            
            #themeToggle {
                width: 100%;
                font-size: 1em;
            }
            
            .card {
                padding: 15px;
                border-radius: 10px;
            }
            
            .card h2 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab {
                padding: 12px 20px;
                font-size: 1.1em;
                min-height: 45px;
                flex: 1;
                min-width: calc(50% - 5px);
            }
            
            .form-group label {
                font-size: 1.1em;
            }
            
            .form-group input,
            .form-group select {
                padding: 15px;
                font-size: 16px; /* Evita zoom en iOS */
            }
            
            .btn {
                padding: 16px 30px;
                font-size: 1.1em;
                min-height: 55px;
            }
            
            .btn-large {
                padding: 18px 35px;
                font-size: 1.2em;
                min-height: 60px;
            }
            
            .help-text {
                padding: 15px;
                font-size: 1em;
            }
            
            .data-section {
                max-height: 500px;
            }
            
            .data-item {
                padding: 12px;
            }
            
            .data-item strong {
                font-size: 1.1em;
            }
            
            .alert {
                padding: 15px;
                font-size: 1em;
            }
            
            .response {
                padding: 12px;
                max-height: 400px;
            }
            
            /* Tablas responsive */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            table thead,
            table tbody,
            table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            
            table th,
            table td {
                padding: 10px 8px;
                font-size: 0.9em;
            }
            
            /* Fixture responsive */
            .fixture-container {
                padding: 15px !important;
                font-size: 14px !important;
            }
            
            .fixture-title {
                font-size: 1.5em !important;
                margin-bottom: 15px !important;
            }
            
            .fixture-stats {
                padding: 15px !important;
                gap: 15px !important;
                flex-direction: column !important;
            }
            
            .fixture-stat-number {
                font-size: 2.5em !important;
            }
            
            .fixture-stat-label {
                font-size: 1em !important;
            }
            
            .fixture-vuelta {
                padding: 15px !important;
                margin-bottom: 25px !important;
            }
            
            .fixture-vuelta-title {
                font-size: 1.4em !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            
            .fixture-jornada {
                padding: 15px !important;
                margin-bottom: 20px !important;
            }
            
            .fixture-jornada-title {
                font-size: 1.2em !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 5px !important;
            }
            
            .fixture-match {
                padding: 15px !important;
            }
            
            .fixture-match-teams {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                text-align: center !important;
            }
            
            .fixture-match-scores {
                flex-direction: column !important;
                gap: 10px !important;
                margin: 15px 0 !important;
            }
            
            .fixture-score-input {
                width: 100% !important;
                max-width: 120px !important;
                margin: 0 auto !important;
            }
            
            .fixture-match-actions {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .fixture-action-button {
                width: 100% !important;
                padding: 14px !important;
                font-size: 1em !important;
            }
        }
        
        /* M√≥viles peque√±os */
        @media (max-width: 480px) {
            body {
                padding: 8px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .card {
                padding: 12px;
            }
            
            .card h2 {
                font-size: 1.3em;
                margin-bottom: 12px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 1em;
                min-height: 40px;
                min-width: 100%;
            }
            
            .form-group label {
                font-size: 1em;
                margin-bottom: 8px;
            }
            
            .form-group input,
            .form-group select {
                padding: 12px;
                font-size: 16px;
            }
            
            .btn {
                padding: 14px 25px;
                font-size: 1em;
                min-height: 50px;
            }
            
            .btn-large {
                padding: 16px 30px;
                font-size: 1.1em;
                min-height: 55px;
            }
            
            .help-text {
                padding: 12px;
                font-size: 0.95em;
            }
            
            .data-item {
                padding: 10px;
            }
            
            .data-item strong {
                font-size: 1em;
            }
            
            .data-item .info {
                font-size: 0.8em;
            }
            
            .alert {
                padding: 12px;
                font-size: 0.95em;
            }
            
            table th,
            table td {
                padding: 8px 5px;
                font-size: 0.85em;
            }
            
            /* Botones en data-item en m√≥vil */
            .data-item > div:last-child {
                width: 100% !important;
                max-width: 100% !important;
                flex-direction: row !important;
            }
            
            .data-item button {
                padding: 10px 15px;
                font-size: 0.9em;
                flex: 1;
                min-height: 45px;
            }
            
            .data-item > div:first-child {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            /* Chips m√°s peque√±os */
            .chip {
                padding: 3px 8px;
                font-size: 0.75em;
            }
        }
        
        /* Pantallas muy peque√±as (menos de 360px) */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .card h2 {
                font-size: 1.2em;
            }
            
            .tab {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            
            .btn {
                font-size: 0.95em;
                padding: 12px 20px;
            }
        }
        
        /* Orientaci√≥n landscape en m√≥viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .data-section {
                max-height: 300px;
            }
        }
        
        /* Impresi√≥n */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header,
            .tabs,
            .btn,
            #themeToggle {
                display: none;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em; /* M√°s grande */
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        /* Instrucciones de ayuda */
        .help-text {
            background: #e7f3ff;
            border-left: 5px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-size: 1.15em;
            line-height: 1.7;
            color: #1565C0;
        }
        
        .help-text strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #0d47a1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 12px; /* M√°s espacio */
            color: #333;
            font-weight: 700;
            font-size: 1.2em; /* M√°s grande */
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 18px; /* M√°s padding para mejor toque */
            border: 3px solid #e0e0e0; /* Borde m√°s grueso */
            border-radius: 10px;
            font-size: 18px; /* M√°s grande */
            transition: all 0.3s;
            background: #fff;
        }
        
        /* Etiquetas de ayuda para campos */
        .field-help {
            font-size: 1em;
            color: #666;
            margin-top: 8px;
            font-style: italic;
            line-height: 1.5;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px; /* Botones m√°s grandes */
            border-radius: 10px;
            font-size: 1.2em; /* Texto m√°s grande */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
            min-height: 65px; /* Altura m√≠nima para mejor toque */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-large {
            padding: 24px 50px;
            font-size: 1.3em;
            min-height: 75px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-top: 5px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .data-section {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .data-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .data-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .data-item .info {
            font-size: 0.85em;
            color: #666;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 30px; /* M√°s grande */
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.3em; /* M√°s grande */
            color: #666;
            font-weight: 700;
            border-bottom: 4px solid transparent; /* M√°s grueso */
            transition: all 0.3s;
            min-height: 50px;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block !important;
        }
        
        /* Asegurar que el bot√≥n de exportaci√≥n sea siempre visible */
        #exportBothButton {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1001 !important;
        }
        
        #whatsappExportSection {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000 !important;
        }
        
        #manageTab.active #exportBothButton {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1001 !important;
        }
        
        #manageTab.active #whatsappExportSection {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000 !important;
        }
        
        /* Asegurar visibilidad incluso si el tab no est√° activo (para debugging) */
        #manageTab #exportBothButton {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1001 !important;
        }
        
        #manageTab #whatsappExportSection {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 1000 !important;
        }
        
        /* Forzar visibilidad del manageTab cuando est√° activo */
        #manageTab.active {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .response {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state::before {
            content: "üìã";
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }
        
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .chip {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .alert {
            padding: 20px; /* M√°s padding */
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2em; /* M√°s grande */
            line-height: 1.6;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    
    <!-- VERIFICACI√ìN: Si ves este comentario, el archivo se actualiz√≥ correctamente -->
    
    <!-- Modal de Login/Registro -->
    <div id="authModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            <h2 id="authModalTitle" style="color: #667eea; margin-bottom: 20px;">Iniciar Sesi√≥n</h2>
            <div id="authForm">
                <div class="form-group">
                    <label for="authUsername">Username:</label>
                    <input type="text" id="authUsername" name="username" autocomplete="username" placeholder="Ingresa tu username" required>
                </div>
                <div class="form-group">
                    <label for="authPassword">Password:</label>
                    <input type="password" id="authPassword" name="password" autocomplete="current-password" placeholder="Ingresa tu password" required>
                </div>
                <div class="form-group" id="authEmailGroup" style="display: none;">
                    <label for="authEmail">Email (opcional):</label>
                    <input type="email" id="authEmail" name="email" autocomplete="email" placeholder="tu@email.com">
                </div>
                <div id="authRoleInfo" style="display: none; padding: 10px; background: #f0f0f0; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em; color: #666;">
                    ‚ÑπÔ∏è Todos los usuarios nuevos se crean como <strong>Visualizadores</strong>. Solo puede haber un administrador en el sistema.
                </div>
                <button class="btn btn-large" onclick="handleAuth()" style="width: 100%; margin-top: 20px;">
                    Iniciar Sesi√≥n
                </button>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="toggleAuthMode(); return false;" style="color: #667eea; text-decoration: underline;">
                        ¬øNo tienes cuenta? Reg√≠strate
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Usuario (Oculto) -->
    <div id="userPanel" style="display: none !important; visibility: hidden !important;">
        <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); min-width: 200px;">
            <div style="font-weight: 700; color: #667eea; margin-bottom: 10px;" id="userInfo">Usuario</div>
            <button class="btn" onclick="showNotificationSettings()" style="width: 100%; margin-bottom: 5px; background: #17a2b8; color: white;">
                üîî Notificaciones
            </button>
            <button class="btn" onclick="logout()" style="width: 100%; background: #dc3545; color: white;">
                Cerrar Sesi√≥n
            </button>
        </div>
    </div>
    
    <!-- Modal de Configuraci√≥n de Notificaciones -->
    <div id="notificationSettingsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeNotificationSettings()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">üîî Configuraci√≥n de Notificaciones</h2>
            <div id="notificationSettingsContent">
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notifEnablePush" onchange="updateNotificationSettings()">
                        Activar notificaciones push del navegador
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notifEnableEmail" onchange="updateNotificationSettings()">
                        Activar notificaciones por email
                    </label>
                </div>
                <div class="form-group">
                    <label for="notifEmail">Email:</label>
                    <input type="email" id="notifEmail" name="notifEmail" autocomplete="email" placeholder="tu@email.com" onchange="updateNotificationSettings()">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notifUpcomingMatches" onchange="updateNotificationSettings()">
                        Notificar partidos pr√≥ximos (24h antes)
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notifMatchResults" onchange="updateNotificationSettings()">
                        Notificar resultados importantes
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notifWeeklySummary" onchange="updateNotificationSettings()">
                        Resumen semanal
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="notifUnprogrammed" onchange="updateNotificationSettings()">
                        Alertar sobre partidos sin fecha programada
                    </label>
                </div>
                <button class="btn btn-large" onclick="requestNotificationPermission()" style="width: 100%; margin-top: 20px; background: #28a745; color: white;">
                    üîî Solicitar Permiso de Notificaciones
                </button>
            </div>
        </div>
    </div>
    
    <!-- Men√∫ hamburguesa para m√≥viles -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Men√∫">
        ‚ò∞
    </button>
    <div class="mobile-menu-overlay" onclick="toggleMobileMenu()"></div>
    <div class="mobile-menu" id="mobileMenu">
        <a href="#" class="mobile-menu-item" onclick="switchTab('create'); toggleMobileMenu();">‚ûï Crear Nuevo</a>
        <a href="#" class="mobile-menu-item" onclick="switchTab('view'); toggleMobileMenu();">üëÅÔ∏è Ver y Gestionar</a>
        <a href="#" class="mobile-menu-item" onclick="switchTab('data'); toggleMobileMenu();">üìä Datos Creados</a>
        <a href="#" class="mobile-menu-item" onclick="switchTab('dashboard'); toggleMobileMenu();">üìà Dashboard</a>
    </div>
    
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 15px;">
                <h1 style="margin: 0;">üèÄ ABALA</h1>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <!-- B√∫squeda Global -->
                    <div style="position: relative;">
                        <input type="text" id="globalSearch" placeholder="üîç Buscar campeonatos, equipos, partidos..." 
                               style="padding: 10px 40px 10px 15px; border-radius: 8px; border: 2px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.2); color: white; font-size: 1em; min-width: 300px; max-width: 400px; backdrop-filter: blur(10px);"
                               onkeyup="performGlobalSearch(this.value)"
                               onfocus="showGlobalSearchResults()"
                               onblur="setTimeout(() => hideGlobalSearchResults(), 200)">
                        <div id="globalSearchResults" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-height: 400px; overflow-y: auto; z-index: 1000; margin-top: 5px; color: #333;"></div>
                    </div>
                    <button id="themeToggle" onclick="toggleTheme()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 700;">
                        üåô Modo Oscuro
                    </button>
                </div>
            </div>
            <p style="font-size: 1.4em; opacity: 0.95; margin-top: 10px;">Sistema Simple para Administrar Campeonatos de B√°squetbol</p>
        </div>
        
        <div class="main-grid">
            <!-- Panel Izquierdo: Crear/Gestionar -->
            <div class="card">
                <h2>‚öôÔ∏è Gesti√≥n del Campeonato</h2>
                
                <div class="help-text" id="helpContent">
                    <strong>üí° Bienvenido</strong>
                    <span id="helpText">Seleccione una opci√≥n en las pesta√±as de arriba para comenzar. Use "Crear" para crear nuevos campeonatos o categor√≠as, y "Gestionar" para ver la informaci√≥n existente.</span>
                </div>
                
                <div class="tabs">
                    <button class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')">üìä Dashboard</button>
                    <button class="tab" data-tab="create" onclick="switchTab('create')">‚ûï Crear Nuevo</button>
                    <button class="tab" data-tab="manage" onclick="switchTab('manage')">üëÅÔ∏è Ver y Gestionar</button>
                </div>
                <!-- Tab: Dashboard -->
                <div id="dashboardTab" class="tab-content active">
                    <div class="help-text">
                        <strong>üìä Resumen General</strong>
                        Vista general de todos los campeonatos, pr√≥ximos partidos y resultados recientes.
                    </div>
                    <button class="btn btn-large" onclick="if(typeof window.loadDashboard === 'function') { window.loadDashboard(); } else { alert('Cargando dashboard...'); setTimeout(() => { if(typeof window.loadDashboard === 'function') window.loadDashboard(); }, 500); }" style="width: 100%; margin-top: 20px;">
                        üîÑ Actualizar Dashboard
                    </button>
                    
                    
                    <div id="dashboardContent" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Tab: Crear -->
                <div id="createTab" class="tab-content">
                    <div class="form-group">
                        <label for="actionSelect">üìã ¬øQu√© desea crear?</label>
                        <select id="actionSelect" onchange="updateForm()" style="font-size: 1.1em; padding: 18px;">
                            <option value="createChamp" selected>üèÜ Crear un Nuevo Campeonato</option>
                            <option value="addCategory">üìÅ Agregar una Categor√≠a a un Campeonato</option>
                        </select>
                        <div class="field-help">Seleccione qu√© desea crear en el men√∫ de arriba</div>
                    </div>
                    
                    <div id="dynamicForm"></div>
                    
                    <button class="btn btn-large" onclick="executeAction()">‚úÖ Crear Ahora</button>
                    <button class="btn btn-secondary" onclick="loadData()">üîÑ Actualizar Lista</button>
                </div>
                
                <!-- Tab: Gestionar -->
                <div id="manageTab" class="tab-content">
                    <!-- Bot√≥n de Exportaci√≥n para WhatsApp - PRIMERO Y M√ÅS VISIBLE -->
                    <div id="whatsappExportSection" style="margin-bottom: 25px; padding: 25px; background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1000 !important;">
                        <h3 style="color: white; margin-bottom: 10px; font-size: 1.5em; font-weight: 700;">üì§ Exportar para WhatsApp</h3>
                        <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px; font-size: 1.1em; font-weight: 500;">Exporta el fixture y la tabla de posiciones como imagen para compartir en grupos de WhatsApp</p>
                        <button id="exportBothButton" onclick="if(typeof exportBothToImage === 'function') { exportBothToImage(); } else { alert('Error: La funci√≥n exportBothToImage no est√° disponible. Por favor, recarga la p√°gina.'); }" class="btn btn-large" style="background: white !important; color: #25d366 !important; padding: 18px 35px !important; border: 3px solid #128c7e !important; border-radius: 10px !important; cursor: pointer !important; font-weight: 700 !important; font-size: 1.3em !important; box-shadow: 0 6px 20px rgba(0,0,0,0.3) !important; width: 100% !important; min-height: 60px !important; display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; z-index: 1001 !important; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            üì§ Exportar Fixture y Tabla de Posiciones
                        </button>
                        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="exportStandingsToImage()" style="background: rgba(255,255,255,0.25); color: white; padding: 12px 24px; border: 2px solid white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
                                üìä Solo Tabla
                            </button>
                            <button onclick="exportCalendarToImage()" style="background: rgba(255,255,255,0.25); color: white; padding: 12px 24px; border: 2px solid white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
                                üìÖ Solo Fixture
                            </button>
                        </div>
                        <p style="color: rgba(255,255,255,0.85); margin-top: 15px; font-size: 0.95em; font-style: italic;">üí° Selecciona campeonato y categor√≠a abajo, luego haz clic en "Ver Informaci√≥n"</p>
                    </div>
                    
                    <div class="help-text">
                        <strong>üëÅÔ∏è Ver Informaci√≥n del Campeonato</strong>
                        Seleccione qu√© desea ver y el campeonato correspondiente. Luego haga clic en "Ver Informaci√≥n" para mostrar los datos.
                    </div>
                    
                    <div class="form-group">
                        <label for="viewSelect">üìä ¬øQu√© desea ver?</label>
                        <select id="viewSelect" onchange="loadView()" style="font-size: 1.1em; padding: 18px;">
                            <option value="standings">üìà Ver Tabla de Posiciones</option>
                            <option value="fixture">üìÖ Ver Calendario de Partidos (Fixture)</option>
                            <option value="calendar">üìÜ Vista de Calendario Mensual</option>
                            <option value="calendar-week">üìÖ Vista de Calendario Semanal</option>
                        </select>
                        <div class="field-help">Elija qu√© informaci√≥n desea ver del campeonato</div>
                    </div>
                    
                    <div id="viewForm"></div>
                    <button class="btn btn-large" onclick="loadViewData()">üëÅÔ∏è Ver Informaci√≥n</button>
                </div>
            </div>
            
            <!-- Panel Derecho: Datos Creados -->
            <div class="card">
                <h2>üìä Datos Creados</h2>
                
                <!-- Barra de b√∫squeda -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="üîç Buscar campeonatos..." 
                           style="width: 100%; padding: 12px; font-size: 1.1em; border-radius: 8px; border: 2px solid #667eea;"
                           onkeyup="filterChampionships()">
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="window.switchDataTab('championships')">Campeonatos</button>
                    <button class="tab" onclick="window.switchDataTab('categories')">Categor√≠as</button>
                    <button class="tab" onclick="window.switchDataTab('history')">üìú Historial</button>
                </div>
                
                <div id="championshipsTab" class="tab-content active data-section">
                    <div id="championshipsList"></div>
                </div>
                
                <div id="categoriesTab" class="tab-content data-section">
                    <div id="categoriesList"></div>
                </div>
                
                <div id="historyTab" class="tab-content data-section">
                    <div style="margin-bottom: 15px;">
                        <button class="btn" onclick="loadAuditLog()" style="background: #667eea; color: white; width: 100%;">
                            üîÑ Actualizar Historial
                        </button>
                    </div>
                    <div id="auditLogList" style="max-height: 500px; overflow-y: auto;">
                        <div class="empty-state">Cargando historial...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Respuesta -->
        <div class="card" id="responseCard" style="display: none;">
            <h2>üì§ Respuesta</h2>
            <div id="response" class="response"></div>
        </div>
    </div>
    
    <script>
        // Asegurar que las funciones est√©n en el scope global
        window.API_BASE = window.location.origin;
        const API_BASE = window.API_BASE;
        let championshipsData = {};
        let categoriesData = {};
        
        // Definir switchDataTab inmediatamente para que est√© disponible cuando se cargue el HTML
        function switchDataTab(tab) {
            document.querySelectorAll('#championshipsTab, #categoriesTab, #historyTab').forEach(t => t.classList.remove('active'));
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((t, i) => {
                if ((tab === 'championships' && i === 0) || 
                    (tab === 'categories' && i === 1) || 
                    (tab === 'history' && i === 2)) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            if (tab === 'championships') {
                const el = document.getElementById('championshipsTab');
                if (el) el.classList.add('active');
            } else if (tab === 'categories') {
                const el = document.getElementById('categoriesTab');
                if (el) el.classList.add('active');
            } else if (tab === 'history') {
                const el = document.getElementById('historyTab');
                if (el) el.classList.add('active');
                if (typeof loadAuditLog === 'function') {
                    loadAuditLog();
                }
            }
        }
        window.switchDataTab = switchDataTab;
        
        // Funci√≥n de utilidad para mostrar alertas
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 400px; font-size: 1.1em;';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Asegurar que showAlert est√© disponible globalmente
        window.showAlert = showAlert;
        
        // Sistema de temas (modo oscuro/claro)
        function initTheme() {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    updateThemeButton('dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    updateThemeButton('light');
                }
            } catch (error) {
                console.error('Error inicializando tema:', error);
            }
        }
        
        function toggleTheme() {
            try {
                const isDark = document.body.classList.contains('dark-mode');
                if (isDark) {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                    updateThemeButton('light');
                } else {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                    updateThemeButton('dark');
                }
            } catch (error) {
                console.error('Error cambiando tema:', error);
                showAlert('Error al cambiar el tema', 'error');
            }
        }
        
        function updateThemeButton(theme) {
            try {
                const button = document.getElementById('themeToggle');
                if (button) {
                    if (theme === 'dark') {
                        button.textContent = '‚òÄÔ∏è Modo Claro';
                        button.style.background = 'rgba(255,255,255,0.3)';
                    } else {
                        button.textContent = 'üåô Modo Oscuro';
                        button.style.background = 'rgba(255,255,255,0.2)';
                    }
                } else {
                    console.warn('Bot√≥n themeToggle no encontrado');
                }
            } catch (error) {
                console.error('Error actualizando bot√≥n de tema:', error);
            }
        }
        
        window.toggleTheme = toggleTheme;
        window.initTheme = initTheme;
        
        // Inicializar tema al cargar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTheme);
        } else {
            // DOM ya est√° cargado
            setTimeout(initTheme, 100);
        }
        
        
        // Asegurar que switchTab est√© disponible globalmente ANTES de cualquier otra cosa
        window.switchTab = function(tab) {
            try {
                console.log('üîµ switchTab llamado con:', tab);
                console.log('üîµ window.switchTab existe?', typeof window.switchTab);
                
                // Obtener el panel de Gesti√≥n espec√≠ficamente (primer .card dentro de .main-grid)
                const mainGrid = document.querySelector('.main-grid');
                if (!mainGrid) {
                    console.error('No se encontr√≥ .main-grid');
                    return;
                }
                
                const gestionCard = mainGrid.querySelector('.card:first-child');
                if (!gestionCard) {
                    console.error('No se encontr√≥ el panel de Gesti√≥n');
                    return;
                }
                
                const tabs = gestionCard.querySelectorAll('.tabs .tab');
                const tabContents = gestionCard.querySelectorAll('.tab-content');
                
                console.log('Pesta√±as encontradas:', tabs.length);
                
                // Remover active de todos
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Activar seg√∫n el tab seleccionado
                if (tab === 'dashboard') {
                    const dashboardTab = document.getElementById('dashboardTab');
                    if (dashboardTab && tabs[0]) {
                        tabs[0].classList.add('active');
                        dashboardTab.classList.add('active');
                        console.log('Dashboard activado');
                        setTimeout(() => loadDashboard(), 100); // Cargar autom√°ticamente al cambiar a dashboard
                    } else {
                        console.error('Dashboard tab no encontrado');
                    }
                } else if (tab === 'create') {
                    const createTab = document.getElementById('createTab');
                    if (createTab && tabs[1]) {
                        tabs[1].classList.add('active');
                        createTab.classList.add('active');
                        console.log('Crear tab activado');
                        // Asegurar que el formulario se actualice
                        setTimeout(() => {
                            try {
                                updateForm();
                            } catch (e) {
                                console.error('Error en updateForm:', e);
                            }
                        }, 100);
                    } else {
                        console.error('Create tab no encontrado');
                    }
                } else if (tab === 'manage') {
                    const manageTab = document.getElementById('manageTab');
                    if (manageTab && tabs[2]) {
                        tabs[2].classList.add('active');
                        manageTab.classList.add('active');
                        console.log('Gestionar tab activado');
                        
                        // Forzar visibilidad del manageTab
                        manageTab.style.display = 'block';
                        manageTab.style.visibility = 'visible';
                        manageTab.style.opacity = '1';
                        
                        
                        // Asegurar que el formulario de vista se actualice
                        setTimeout(() => {
                            try {
                                loadView();
                            } catch (e) {
                                console.error('Error en loadView:', e);
                            }
                        }, 100);
                    } else {
                        console.error('Manage tab no encontrado');
                    }
                }
            } catch (error) {
                console.error('Error en switchTab:', error);
                showAlert('Error al cambiar de pesta√±a: ' + error.message, 'error');
            }
        };
        
        // Asegurar que loadDashboard est√© disponible globalmente
        window.loadDashboard = async function() {
            const dashboardContent = document.getElementById('dashboardContent');
            if (!dashboardContent) {
                console.error('dashboardContent no encontrado');
                return;
            }
            
            dashboardContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div><div style="font-size: 1.2em;">Cargando dashboard...</div></div>';
            
            try {
                const res = await fetch(`${API_BASE}/api/dashboard`);
                
                if (!res.ok) {
                    throw new Error(`Error HTTP: ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data.success) {
                    dashboardContent.innerHTML = `<div class="alert alert-error">Error al cargar el dashboard: ${data.error || 'Error desconocido'}</div>`;
                    return;
                }
                
                if (!data.dashboard) {
                    dashboardContent.innerHTML = `<div class="alert alert-error">Error: Datos del dashboard no disponibles</div>`;
                    return;
                }
                
                const dashboard = data.dashboard;
                renderDashboard(dashboard);
                // Verificar notificaciones despu√©s de renderizar
                setTimeout(() => checkNotifications(dashboard), 500);
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                if (dashboardContent) {
                    dashboardContent.innerHTML = `<div class="alert alert-error">Error de conexi√≥n: ${error.message || 'Error desconocido'}. Por favor, intente nuevamente.</div>`;
                }
            }
        };
        
        function checkNotifications(dashboard) {
            const notifications = [];
            const now = new Date();
            
            // Verificar partidos pr√≥ximos (pr√≥ximas 24 horas)
            if (dashboard.upcoming_matches && dashboard.upcoming_matches.length > 0) {
                dashboard.upcoming_matches.forEach(match => {
                    if (match.date) {
                        try {
                            const matchDate = new Date(match.date + 'T' + (match.time || '20:00'));
                            const hoursUntil = (matchDate - now) / (1000 * 60 * 60);
                            if (hoursUntil > 0 && hoursUntil <= 24) {
                                notifications.push({
                                    type: 'upcoming',
                                    message: `‚è∞ Partido pr√≥ximo: ${match.team_a} vs ${match.team_b} en ${Math.round(hoursUntil)} horas`,
                                    match: match
                                });
                            }
                        } catch (e) {
                            console.error('Error procesando fecha de partido:', e);
                        }
                    }
                });
            }
            
            // Verificar partidos sin fecha programada
            if (dashboard.summary && dashboard.summary.matches_pending > 0) {
                const totalPending = dashboard.summary.matches_pending;
                if (totalPending > 5) {
                    notifications.push({
                        type: 'warning',
                        message: `‚ö†Ô∏è Hay ${totalPending} partidos pendientes sin fecha programada`
                    });
                }
            }
            
            // Mostrar notificaciones
            if (notifications.length > 0) {
                showNotifications(notifications);
            }
        }
        
        function showNotifications(notifications) {
            // Remover notificaciones anteriores
            const existing = document.getElementById('notifications');
            if (existing) existing.remove();
            
            const notificationDiv = document.createElement('div');
            notificationDiv.id = 'notifications';
            notificationDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
            
            let html = '';
            notifications.forEach((notif) => {
                const bgColor = notif.type === 'upcoming' ? '#ffc107' : '#ff9800';
                html += `
                    <div style="background: ${bgColor}; color: #000; padding: 15px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;">
                        <div style="font-weight: bold; margin-bottom: 5px; font-size: 1.1em;">${notif.message}</div>
                        ${notif.match && notif.match.date ? `<div style="font-size: 0.9em; opacity: 0.8;">${notif.match.date} a las ${notif.match.time || 'TBD'}</div>` : ''}
                    </div>
                `;
            });
            
            notificationDiv.innerHTML = html;
            document.body.appendChild(notificationDiv);
            
            // Auto-ocultar despu√©s de 10 segundos
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificationDiv.parentNode) {
                            notificationDiv.remove();
                        }
                    }, 300);
                }
            }, 10000);
        }
        
        function renderDashboard(dashboard) {
            const dashboardContent = document.getElementById('dashboardContent');
            if (!dashboardContent) {
                console.error('dashboardContent no encontrado en renderDashboard');
                return;
            }
            
            if (!dashboard) {
                dashboardContent.innerHTML = '<div class="alert alert-error">Error: Datos del dashboard no disponibles</div>';
                return;
            }
            
            const { summary, championships, upcoming_matches, recent_results, top_teams } = dashboard;
            
            // Guardar summary en una variable accesible para el gr√°fico
            window.dashboardSummary = summary;
            
            // Validar que los datos existan
            if (!summary) {
                dashboardContent.innerHTML = '<div class="alert alert-error">Error: Resumen no disponible</div>';
                return;
            }
            
            let html = `
                <!-- Resumen General -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 25px; font-size: 2em; text-align: center;">üìä Resumen General</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.total_championships || 0}</div>
                            <div style="font-size: 1.2em;">Campeonatos</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.total_teams || 0}</div>
                            <div style="font-size: 1.2em;">Equipos</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.total_matches || 0}</div>
                            <div style="font-size: 1.2em;">Partidos Totales</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.overall_progress || 0}%</div>
                            <div style="font-size: 1.2em;">Progreso General</div>
                        </div>
                    </div>
                    <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid rgba(255,255,255,0.3); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 2em; font-weight: bold; color: #28a745;">${summary.matches_played || 0}</div>
                            <div style="font-size: 1em; opacity: 0.9;">Jugados</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: bold; color: #ffc107;">${summary.matches_pending || 0}</div>
                            <div style="font-size: 1em; opacity: 0.9;">Pendientes</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: bold;">${summary.total_categories || 0}</div>
                            <div style="font-size: 1em; opacity: 0.9;">Categor√≠as</div>
                        </div>
                    </div>
                </div>
                
                <!-- Gr√°fico de Progreso y Top 5 Equipos -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <!-- Gr√°fico de Progreso -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #667eea; margin-bottom: 20px; font-size: 1.5em; font-weight: 700;">üìä Progreso del Campeonato</h4>
                        <canvas id="progressChart" style="max-height: 300px;"></canvas>
                    </div>
                    
                    <!-- Top 5 Equipos -->
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h4 style="color: #667eea; margin-bottom: 20px; font-size: 1.5em; font-weight: 700;">üèÜ Top 5 Equipos</h4>
                        ${top_teams && top_teams.length > 0 ? `
                            <div style="display: grid; gap: 15px;">
                                ${top_teams.map((team, index) => `
                                    <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: linear-gradient(135deg, ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#f0f0f0'} 0%, ${index < 3 ? '#fff' : '#f8f8f8'} 100%); border-radius: 10px; border-left: 5px solid ${index === 0 ? '#ffd700' : index === 1 ? '#c0c0c0' : index === 2 ? '#cd7f32' : '#667eea'};">
                                        <div style="font-size: 2em; font-weight: bold; color: ${index < 3 ? '#333' : '#667eea'}; min-width: 40px; text-align: center;">${index + 1}</div>
                                        <div style="flex: 1;">
                                            <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 5px;">${team.name}</div>
                                            <div style="font-size: 0.9em; color: #666;">${team.championship} - ${team.category}</div>
                                        </div>
                                        <div style="font-size: 2em; font-weight: bold; color: #28a745;">${team.points}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="empty-state">No hay equipos con puntos a√∫n</div>'}
                    </div>
                </div>
                
                <!-- Campeonatos -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.8em; font-weight: 700;">üèÜ Campeonatos Activos</h3>
                    <div style="display: grid; gap: 20px;">
            `;
            
            if (!championships || championships.length === 0) {
                html += '<div class="empty-state">No hay campeonatos creados</div>';
            } else {
                championships.forEach((champ) => {
                    html += `
                        <div style="background: white; padding: 25px; border-radius: 12px; border-left: 5px solid #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h4 style="color: #667eea; font-size: 1.5em; margin-bottom: 10px; font-weight: 700;">${champ.name || 'Sin nombre'}</h4>
                                    <div style="color: #666; font-size: 1.1em; line-height: 1.8;">
                                        <div>üìÅ <strong>Categor√≠as:</strong> ${champ.categories_count || 0}</div>
                                        <div>üë• <strong>Equipos:</strong> ${champ.teams_count || 0}</div>
                                        <div>üîÑ <strong>Vueltas:</strong> ${champ.rounds || 0}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 2.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;">${champ.progress_percentage || 0}%</div>
                                    <div style="color: #666; font-size: 0.9em;">Progreso</div>
                                </div>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; padding: 15px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-around; text-align: center;">
                                    <div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #28a745;">${champ.matches_played || 0}</div>
                                        <div style="font-size: 0.9em; color: #666;">Jugados</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #dc3545;">${champ.matches_pending || 0}</div>
                                        <div style="font-size: 0.9em; color: #666;">Pendientes</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${champ.matches_total || 0}</div>
                                        <div style="font-size: 0.9em; color: #666;">Total</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div></div>`;
            
            // Pr√≥ximos Partidos
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.8em; font-weight: 700;">üìÖ Pr√≥ximos Partidos</h3>
            `;
            
            if (!upcoming_matches || upcoming_matches.length === 0) {
                html += '<div class="empty-state">No hay partidos programados pr√≥ximamente</div>';
            } else {
                html += '<div style="display: grid; gap: 15px;">';
                upcoming_matches.forEach((match) => {
                    let dateStr = 'Fecha por definir';
                    if (match.date) {
                        try {
                            const dateObj = new Date(match.date);
                            dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) {
                            dateStr = match.date;
                        }
                    }
                    html += `
                        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #ffc107; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px; font-size: 1.1em;">${match.championship_name || 'Sin nombre'} - ${match.category || 'Sin categor√≠a'}</div>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${match.team_a || 'Equipo A'} <span style="color: #666;">vs</span> ${match.team_b || 'Equipo B'}
                                    </div>
                                    <div style="color: #666; font-size: 1em;">
                                        üìÖ ${dateStr} üïê ${match.time || 'Por definir'}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="background: #ffc107; color: #000; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                                        ${match.match_type === 'ida' ? 'Vuelta 1' : match.match_type === 'vuelta' ? 'Vuelta 2' : 'Vuelta'} - Jornada ${match.matchday || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `</div>`;
            
            // Resultados Recientes
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.8em; font-weight: 700;">‚öΩ Resultados Recientes</h3>
            `;
            
            if (!recent_results || recent_results.length === 0) {
                html += '<div class="empty-state">No hay resultados recientes</div>';
            } else {
                html += '<div style="display: grid; gap: 15px;">';
                recent_results.forEach((result) => {
                    let dateStr = 'Fecha no disponible';
                    if (result.date) {
                        try {
                            const dateObj = new Date(result.date);
                            dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) {
                            dateStr = result.date;
                        }
                    }
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #28a745; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">${result.championship_name || 'Sin nombre'} - ${result.category || 'Sin categor√≠a'}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 5px;">${result.team_a || 'Equipo A'}</div>
                                    <div style="font-size: 2em; font-weight: bold; color: ${result.winner === result.team_a ? '#28a745' : '#666'};">
                                        ${result.score_a !== null && result.score_a !== undefined ? result.score_a : '-'}
                                    </div>
                                </div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #666; margin: 0 20px;">-</div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 5px;">${result.team_b || 'Equipo B'}</div>
                                    <div style="font-size: 2em; font-weight: bold; color: ${result.winner === result.team_b ? '#28a745' : '#666'};">
                                        ${result.score_b !== null && result.score_b !== undefined ? result.score_b : '-'}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; color: #666; font-size: 0.95em; margin-top: 10px;">
                                üìÖ ${dateStr} | Ganador: <strong style="color: #28a745;">${result.winner || 'Empate'}</strong>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `</div>`;
            
            dashboardContent.innerHTML = html;
            
            // Crear gr√°fico de progreso
            setTimeout(() => {
                const ctx = document.getElementById('progressChart');
                if (ctx && typeof Chart !== 'undefined') {
                    const summaryData = window.dashboardSummary || summary || {};
                    const played = summaryData.matches_played || 0;
                    const pending = summaryData.matches_pending || 0;
                    const total = summaryData.total_matches || 0;
                    
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Jugados', 'Pendientes'],
                            datasets: [{
                                data: [played, pending],
                                backgroundColor: ['#28a745', '#ffc107'],
                                borderWidth: 3,
                                borderColor: '#fff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        font: {
                                            size: 14,
                                            weight: 'bold'
                                        },
                                        padding: 15
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.parsed || 0;
                                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                            return label + ': ' + value + ' (' + percentage + '%)';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }
        
        // switchDataTab ya est√° definida al inicio del script
        
        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        
        let currentUser = null;
        let authToken = null;
        
        // Verificar si hay sesi√≥n guardada
        window.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            if (savedToken && savedUser) {
                authToken = savedToken;
                currentUser = JSON.parse(savedUser);
                updateUserUI();
            }
            // No mostrar el modal autom√°ticamente - solo cuando se necesite autenticaci√≥n
        });
        
        function showAuthModal() {
            document.getElementById('authModal').style.display = 'block';
            document.getElementById('authModalTitle').textContent = 'Iniciar Sesi√≥n';
            document.getElementById('authEmailGroup').style.display = 'none';
            document.getElementById('authRoleInfo').style.display = 'none';
            document.querySelector('#authForm button').textContent = 'Iniciar Sesi√≥n';
            window.authMode = 'login';
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        
        // Cerrar modal al hacer clic fuera del contenido
        window.addEventListener('click', (event) => {
            const authModal = document.getElementById('authModal');
            if (event.target === authModal) {
                closeAuthModal();
            }
        });
        
        function toggleAuthMode() {
            const isLogin = window.authMode === 'login';
            window.authMode = isLogin ? 'register' : 'login';
            document.getElementById('authModalTitle').textContent = isLogin ? 'Registrarse' : 'Iniciar Sesi√≥n';
            document.getElementById('authEmailGroup').style.display = isLogin ? 'block' : 'none';
            document.getElementById('authRoleInfo').style.display = isLogin ? 'block' : 'none';
            document.querySelector('#authForm button').textContent = isLogin ? 'Registrarse' : 'Iniciar Sesi√≥n';
            document.querySelector('#authForm a').textContent = isLogin ? '¬øYa tienes cuenta? Inicia sesi√≥n' : '¬øNo tienes cuenta? Reg√≠strate';
        }
        
        async function handleAuth() {
            const username = document.getElementById('authUsername').value;
            const password = document.getElementById('authPassword').value;
            const email = document.getElementById('authEmail').value;
            if (!username || !password) {
                showAlert('Username y password son requeridos', 'error');
                return;
            }
            
            try {
                if (window.authMode === 'register') {
                    // No enviar 'role' - todos los usuarios nuevos son VIEWER por defecto
                    const res = await fetch(`${API_BASE}/api/auth/register`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, email })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showAlert('‚úÖ Registro exitoso. Ahora inicia sesi√≥n.', 'success');
                        toggleAuthMode();
                    } else {
                        showAlert(data.error || 'Error al registrarse', 'error');
                    }
                } else {
                    const res = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (data.success) {
                        currentUser = data.user;
                        authToken = data.token;
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        updateUserUI();
                        closeAuthModal();
                        showAlert(`‚úÖ Bienvenido, ${currentUser.username}!`, 'success');
                        // Cargar configuraci√≥n de notificaciones
                        loadNotificationSettings();
                    } else {
                        showAlert(data.error || 'Error al iniciar sesi√≥n', 'error');
                    }
                }
            } catch (error) {
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            updateUserUI();
            showAuthModal();
            showAlert('Sesi√≥n cerrada', 'success');
        }
        
        function updateUserUI() {
            // Panel de usuario siempre oculto
            const userPanel = document.getElementById('userPanel');
            const userInfo = document.getElementById('userInfo');
            if (userPanel) {
                userPanel.style.display = 'none';
                userPanel.style.visibility = 'hidden';
            }
            if (currentUser && userInfo) {
                userInfo.textContent = `${currentUser.username} (${currentUser.role})`;
            }
        }
        
        // ============================================
        // NOTIFICACIONES
        // ============================================
        
        let notificationSettings = null;
        
        async function loadNotificationSettings() {
            if (!authToken) return;
            
            try {
                const res = await fetch(`${API_BASE}/api/notifications/settings`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();
                if (data.success) {
                    notificationSettings = data.settings;
                    updateNotificationSettingsUI();
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n de notificaciones:', error);
            }
        }
        
        function showNotificationSettings() {
            document.getElementById('notificationSettingsModal').style.display = 'block';
            if (notificationSettings) {
                updateNotificationSettingsUI();
            }
        }
        
        function closeNotificationSettings() {
            document.getElementById('notificationSettingsModal').style.display = 'none';
        }
        
        function updateNotificationSettingsUI() {
            if (!notificationSettings) return;
            
            document.getElementById('notifEnablePush').checked = notificationSettings.enablePush || false;
            document.getElementById('notifEnableEmail').checked = notificationSettings.enableEmail || false;
            document.getElementById('notifEmail').value = notificationSettings.email || '';
            document.getElementById('notifUpcomingMatches').checked = notificationSettings.upcomingMatches || false;
            document.getElementById('notifMatchResults').checked = notificationSettings.matchResults || false;
            document.getElementById('notifWeeklySummary').checked = notificationSettings.weeklySummary || false;
            document.getElementById('notifUnprogrammed').checked = notificationSettings.unprogrammedMatches || false;
        }
        
        async function updateNotificationSettings() {
            if (!authToken) return;
            
            const settings = {
                enablePush: document.getElementById('notifEnablePush').checked,
                enableEmail: document.getElementById('notifEnableEmail').checked,
                email: document.getElementById('notifEmail').value,
                upcomingMatches: document.getElementById('notifUpcomingMatches').checked,
                matchResults: document.getElementById('notifMatchResults').checked,
                weeklySummary: document.getElementById('notifWeeklySummary').checked,
                unprogrammedMatches: document.getElementById('notifUnprogrammed').checked
            };
            
            try {
                const res = await fetch(`${API_BASE}/api/notifications/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(settings)
                });
                const data = await res.json();
                if (data.success) {
                    notificationSettings = data.settings;
                    showAlert('‚úÖ Configuraci√≥n guardada', 'success');
                }
            } catch (error) {
                showAlert('Error al guardar configuraci√≥n: ' + error.message, 'error');
            }
        }
        
        async function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showAlert('Tu navegador no soporta notificaciones', 'error');
                return;
            }
            
            if (Notification.permission === 'granted') {
                showAlert('‚úÖ Ya tienes permisos de notificaciones', 'success');
                await subscribeToPush();
                return;
            }
            
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showAlert('‚úÖ Permisos de notificaciones concedidos', 'success');
                    await subscribeToPush();
                } else {
                    showAlert('Permisos de notificaciones denegados', 'error');
                }
            }
        }
        
        async function subscribeToPush() {
            if (!authToken) return;
            
            try {
                // En producci√≥n, usar Service Worker y Push API
                // Por ahora solo actualizamos la configuraci√≥n
                const res = await fetch(`${API_BASE}/api/notifications/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ subscription: {} })
                });
                
                if (res.ok) {
                    showAlert('‚úÖ Suscrito a notificaciones push', 'success');
                }
            } catch (error) {
                console.error('Error suscribi√©ndose a push:', error);
            }
        }
        
        // Funci√≥n para cargar el historial de cambios
        async function loadAuditLog() {
            const auditLogList = document.getElementById('auditLogList');
            if (!auditLogList) return;
            
            try {
                auditLogList.innerHTML = '<div class="empty-state">Cargando historial...</div>';
                
                const res = await fetch(`${API_BASE}/api/audit-log?limit=50`);
                const data = await res.json();
                
                if (data.success && data.logs && data.logs.length > 0) {
                    let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    
                    data.logs.forEach(log => {
                        const date = new Date(log.timestamp);
                        const dateStr = date.toLocaleString('es-ES', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        let actionIcon = 'üìù';
                        let actionColor = '#667eea';
                        if (log.action === 'create') {
                            actionIcon = '‚ûï';
                            actionColor = '#28a745';
                        } else if (log.action === 'delete') {
                            actionIcon = 'üóëÔ∏è';
                            actionColor = '#dc3545';
                        } else if (log.action === 'register_result') {
                            actionIcon = '‚öΩ';
                            actionColor = '#17a2b8';
                        }
                        
                        html += `
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid ${actionColor}; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                    <div style="font-weight: 700; color: ${actionColor}; font-size: 1.1em;">
                                        ${actionIcon} ${log.action.replace('_', ' ').toUpperCase()}
                                    </div>
                                    <div style="color: #666; font-size: 0.9em;">${dateStr}</div>
                                </div>
                                <div style="margin-bottom: 5px;">
                                    <strong>Tipo:</strong> ${log.entity_type} | 
                                    <strong>Entidad:</strong> ${log.entity_name || log.entity_id}
                                </div>
                                ${log.metadata ? `
                                    <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                        ${JSON.stringify(log.metadata, null, 2).substring(0, 100)}${JSON.stringify(log.metadata).length > 100 ? '...' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    auditLogList.innerHTML = html;
                } else {
                    auditLogList.innerHTML = '<div class="empty-state">No hay registros en el historial</div>';
                }
            } catch (error) {
                auditLogList.innerHTML = `<div class="alert alert-error">Error al cargar historial: ${error.message}</div>`;
            }
        }
        
        // Asegurar que loadData est√© disponible globalmente
        window.loadData = async function() {
            try {
                console.log('üîÑ Cargando campeonatos desde el servidor (MongoDB)...');
                // Obtener la lista de campeonatos del servidor PRIMERO
                const res = await fetch(`${API_BASE}/api/championships`);
                const data = await res.json();
                
                if (data.success) {
                    const champList = data.championships || {};
                    console.log(`‚úÖ Encontrados ${Object.keys(champList).length} campeonato(s) en el servidor (MongoDB)`);
                    
                    // Limpiar datos de campeonatos que ya no existen en el servidor
                    const serverIds = new Set(Object.keys(champList));
                    const idsToRemove = [];
                    Object.keys(championshipsData).forEach(id => {
                        if (!serverIds.has(id)) {
                            console.log(`‚ö†Ô∏è  Campeonato ${id} ya no existe en el servidor, ser√° removido`);
                            idsToRemove.push(id);
                        }
                    });
                    
                    // Eliminar campeonatos que no existen
                    idsToRemove.forEach(id => {
                        delete championshipsData[id];
                        delete categoriesData[id];
                    });
                    
                    // Cargar datos completos de cada campeonato
                    // Filtrar solo los que realmente existen
                    const validChampIds = Object.keys(champList).filter(id => {
                        // Solo incluir si tiene datos b√°sicos v√°lidos
                        const champ = champList[id];
                        return champ && (champ.name || id);
                    });
                    
                    const loadPromises = validChampIds.map(async (id) => {
                        try {
                            const champRes = await fetch(`${API_BASE}/api/championships/${id}`);
                            
                            // Si el campeonato no existe (404), omitir silenciosamente
                            if (champRes.status === 404) {
                                // No loggear para evitar ruido en la consola
                                return; // No agregar a championshipsData
                            }
                            
                            // Si hay otro error HTTP, intentar continuar con datos del resumen
                            if (!champRes.ok && champRes.status !== 404) {
                                console.warn(`‚ö†Ô∏è  Error ${champRes.status} cargando campeonato ${id}, usando datos del resumen`);
                                const champ = champList[id];
                                if (champ && champ.name) {
                                    championshipsData[id] = champ;
                                }
                                return;
                            }
                            
                            const champData = await champRes.json();
                            
                            if (champData.success && champData.championship) {
                                championshipsData[id] = {
                                    name: champData.championship.name,
                                    rounds: champData.championship.rounds,
                                    points_per_win: champData.championship.points_per_win,
                                    points_per_loss: champData.championship.points_per_loss,
                                    categories: champData.championship.categories || {}
                                };
                                
                                // Extraer categor√≠as con equipos
                                if (champData.championship.categories) {
                                    categoriesData[id] = champData.championship.categories;
                                }
                                
                                console.log(`‚úÖ Cargado campeonato: ${champData.championship.name} (${id})`);
                            } else if (champList[id] && champList[id].name) {
                                // Si falla pero tenemos datos del resumen, usarlos
                                championshipsData[id] = champList[id];
                            }
                        } catch (error) {
                            // Solo loggear errores que no sean relacionados con 404
                            const is404Error = error.message && (
                                error.message.includes('404') || 
                                error.message.includes('Not Found') ||
                                error.message.includes('not found')
                            );
                            
                            if (!is404Error) {
                                console.error(`Error cargando campeonato ${id}:`, error);
                            }
                            
                            // Si tenemos datos del resumen, usarlos como fallback
                            if (champList[id] && champList[id].name) {
                                championshipsData[id] = champList[id];
                            }
                        }
                    });
                    
                    await Promise.all(loadPromises);
                    
                    // Filtrar solo campeonatos v√°lidos que existen en el servidor
                    const validChampionships = Object.entries(championshipsData).filter(([id, champ]) => {
                        // Verificar que el campeonato existe en la lista del servidor
                        const existsInServer = champList[id] && champList[id].name;
                        return champ && champ.name && id && existsInServer;
                    });
                    
                    // Actualizar championshipsData con solo los v√°lidos
                    championshipsData = Object.fromEntries(validChampionships);
                    
                    renderChampionships();
                    renderCategories();
                    updateForm(); // Actualizar formularios con datos disponibles
                    console.log(`‚úÖ Renderizados ${validChampionships.length} campeonato(s) v√°lido(s) en "üìä Datos Creados"`);
                } else {
                    console.warn('‚ö†Ô∏è El servidor no respondi√≥ con success');
                    // Si el servidor no responde, mostrar mensaje
                    renderChampionships();
                    renderCategories();
                    updateForm();
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                // Si falla el servidor, NO cargar desde localStorage para evitar mostrar campeonatos inexistentes
                // Solo mostrar si realmente no hay conexi√≥n al servidor
                championshipsData = {};
                categoriesData = {};
                renderChampionships();
                renderCategories();
                updateForm(); // Actualizar formularios con datos cargados
                showAlert('‚ö†Ô∏è No se pudo conectar al servidor. Solo se mostrar√°n campeonatos que existen en MongoDB.', 'warning');
            }
        }
        
        
        function renderChampionships() {
            const list = document.getElementById('championshipsList');
            
            if (!list) {
                console.error('championshipsList no encontrado');
                return;
            }
            
            // Filtrar solo campeonatos que realmente existen y tienen datos v√°lidos
            // Adem√°s, verificar que no sean solo datos de localStorage sin validar
            let validChampionships = Object.entries(championshipsData).filter(([id, champ]) => {
                // Verificar que tenga datos v√°lidos
                if (!champ || !champ.name || !id) {
                    return false;
                }
                // Verificar que no sea solo un objeto vac√≠o o con datos m√≠nimos
                if (typeof champ !== 'object' || Object.keys(champ).length === 0) {
                    return false;
                }
                return true;
            });
            
            // Actualizar championshipsData con solo los v√°lidos
            championshipsData = Object.fromEntries(validChampionships);
            
            // Aplicar b√∫squeda si hay t√©rmino de b√∫squeda
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.toLowerCase();
                validChampionships = validChampionships.filter(([id, champ]) => {
                    const name = (champ.name || '').toLowerCase();
                    const idLower = id.toLowerCase();
                    const categories = champ.categories ? Object.keys(champ.categories).join(' ').toLowerCase() : '';
                    return name.includes(searchTerm) || idLower.includes(searchTerm) || categories.includes(searchTerm);
                });
            }
            
            console.log(`Renderizando ${validChampionships.length} campeonatos:`, validChampionships.map(([id]) => id));
            
            if (validChampionships.length === 0) {
                const searchInput = document.getElementById('searchInput');
                const hasSearch = searchInput && searchInput.value.trim();
                list.innerHTML = `<div class="empty-state">${hasSearch ? 'No se encontraron campeonatos que coincidan con la b√∫squeda' : 'No hay campeonatos creados'}</div>`;
                return;
            }
            
            list.innerHTML = validChampionships.map(([id, champ]) => `
                <div class="data-item" style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; cursor: pointer; transition: all 0.3s;" 
                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';" 
                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"
                     onclick="loadChampionshipDetails('${id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <strong style="font-size: 1.2em; color: #667eea;">${champ.name || id}</strong>
                            <div class="info" style="margin-top: 8px; color: #666; font-size: 0.9em;">
                                <div>ID: <code>${id}</code></div>
                                <div>Vueltas: ${champ.rounds || 'N/A'}</div>
                                <div>Categor√≠as: ${champ.categories ? Object.keys(champ.categories).length : 0}</div>
                                <div>Puntos por Victoria: ${champ.points_per_win || 2} | Derrota: ${champ.points_per_loss || 0}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; flex-direction: column; width: 100%; max-width: 150px;">
                            <button onclick="event.stopPropagation(); loadChampionshipDetails('${id}')" 
                                style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; min-height: 40px;">
                                üëÅÔ∏è Ver
                            </button>
                            <button onclick="event.stopPropagation(); deleteChampionship('${id}')" 
                                style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; min-height: 40px;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                    ${champ.categories ? `<div class="chips" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">${Object.keys(champ.categories).map(cat => `<span class="chip" style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${cat}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }
        
        async function loadChampionshipDetails(champId) {
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}`);
                
                // Si el campeonato no existe, no mostrar nada
                if (res.status === 404) {
                    console.log(`‚ö†Ô∏è  Campeonato ${champId} no encontrado`);
                    showAlert(`Campeonato "${champId}" no encontrado`, 'warning');
                    return;
                }
                
                if (!res.ok) {
                    showAlert(`Error al cargar campeonato: ${res.status}`, 'error');
                    return;
                }
                
                const data = await res.json();
                
                if (data.success) {
                    // Mostrar detalles en el panel de respuesta
                    const responseCard = document.getElementById('responseCard');
                    const responseDiv = document.getElementById('response');
                    
                    responseCard.style.display = 'block';
                    responseDiv.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üìã Detalles del Campeonato: ${data.championship.name}</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>ID:</strong> <code>${champId}</code></p>
                                <p><strong>Vueltas:</strong> ${data.championship.rounds}</p>
                                <p><strong>Puntos por Victoria:</strong> ${data.championship.points_per_win}</p>
                                <p><strong>Puntos por Derrota:</strong> ${data.championship.points_per_loss}</p>
                            </div>
                            
                            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Categor√≠as:</h4>
                            ${Object.keys(data.championship.categories || {}).length > 0 
                                ? Object.entries(data.championship.categories || {}).map(([catName, cat]) => `
                                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                                        <strong>${catName}</strong>
                                        <div style="margin-top: 8px;">
                                            <strong>Equipos (${cat.teams?.length || 0}):</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                                ${cat.teams?.map(t => `<span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">${t.name || t}</span>`).join('') || 'Sin equipos'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                                : '<p style="color: #666;">No hay categor√≠as creadas</p>'
                            }
                            
                        </div>
                    `;
                    
                    // Scroll a la respuesta
                    responseCard.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('Error al cargar detalles: ' + error.message, 'error');
            }
        }
        
        async function deleteChampionship(champId) {
            // Confirmaci√≥n antes de eliminar
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar el campeonato "${champName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            if (!confirm(`¬øEst√°s seguro de eliminar el campeonato "${championshipsData[champId]?.name || champId}"? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                // Eliminar del servidor
                const res = await fetch(`${API_BASE}/api/championships/${champId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success || res.status === 200 || res.ok) {
                    // Eliminar de los datos en memoria
                    delete championshipsData[champId];
                    delete categoriesData[champId];
                    
                    console.log(`‚úÖ Campeonato ${champId} eliminado de memoria`);
                    console.log(`Campeonatos restantes:`, Object.keys(championshipsData));
                    
                    // Renderizar inmediatamente para actualizar la vista
                    renderChampionships();
                    renderCategories();
                    updateForm();
                    showAlert('Campeonato eliminado exitosamente', 'success');
                    
                    // NO recargar datos desde el servidor/localStorage porque podr√≠a restaurar el eliminado
                    // Solo sincronizar despu√©s de un delay m√°s largo si es necesario
                } else {
                    showAlert(data.error || 'Error al eliminar', 'error');
                }
            } catch (error) {
                console.error('Error eliminando campeonato:', error);
                // Eliminar de los datos en memoria
                delete championshipsData[champId];
                delete categoriesData[champId];
                
                console.log(`‚úÖ Campeonato ${champId} eliminado de memoria`);
                console.log(`Campeonatos restantes:`, Object.keys(championshipsData));
                
                // Renderizar inmediatamente
                renderChampionships();
                renderCategories();
                updateForm();
                showAlert('Campeonato eliminado del almacenamiento local (servidor no disponible)', 'warning');
                // NO recargar datos porque podr√≠a restaurar el eliminado
            }
        }
        
        function renderCategories() {
            const list = document.getElementById('categoriesList');
            
            if (Object.keys(categoriesData).length === 0) {
                list.innerHTML = '<div class="empty-state">No hay categor√≠as creadas</div>';
                return;
            }
            
            let html = '';
            for (const [champId, categories] of Object.entries(categoriesData)) {
                for (const [catName, cat] of Object.entries(categories)) {
                    html += `
                        <div class="data-item" style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; transition: all 0.3s;" 
                             onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';" 
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <strong style="font-size: 1.2em; color: #667eea;">${catName}</strong>
                                    <div class="info" style="margin-top: 8px; color: #666; font-size: 0.9em;">
                                        <div>Campeonato: <strong>${championshipsData[champId]?.name || champId}</strong></div>
                                        <div>Equipos: ${cat.teams ? cat.teams.length : 0}</div>
                                        <div>Partidos: ${cat.matches ? cat.matches.length : 0}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px; flex-direction: column; width: 100%; max-width: 150px;">
                                    <button onclick="event.stopPropagation(); selectCategory('${champId}', '${catName}')" 
                                        style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; min-height: 40px;">
                                        üëÅÔ∏è Ver
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteCategory('${champId}', '${catName}')" 
                                        style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; min-height: 40px;">
                                        üóëÔ∏è Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            list.innerHTML = html || '<div class="empty-state">No hay categor√≠as</div>';
        }
        
        function selectChampionship(id) {
            const champ = championshipsData[id];
            if (!champ) return;
            
            // Auto-rellenar formularios
            document.getElementById('champId')?.setAttribute('value', id);
            document.getElementById('champIdSelect')?.setAttribute('value', id);
            document.getElementById('champIdView')?.setAttribute('value', id);
            
            // Mostrar alerta
            showAlert(`Campeonato "${champ.name || id}" seleccionado`, 'success');
        }
        
        function selectCategory(champId, catName) {
            // Auto-rellenar formularios
            document.getElementById('categoryName')?.setAttribute('value', catName);
            document.getElementById('categorySelect')?.setAttribute('value', catName);
            document.getElementById('categoryView')?.setAttribute('value', catName);
            document.getElementById('champId')?.setAttribute('value', champId);
            
            showAlert(`Categor√≠a "${catName}" seleccionada`, 'success');
        }
        
        async function deleteCategory(champId, catName) {
            // Confirmaci√≥n antes de eliminar
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar la categor√≠a "${catName}" del campeonato "${champName}"?\n\nEsta acci√≥n eliminar√°:\n- La categor√≠a completa\n- Todos los equipos\n- Todos los partidos y resultados\n- Todas las estad√≠sticas\n\n‚ö†Ô∏è Esta acci√≥n NO se puede deshacer.`)) {
                return;
            }
            
            try {
                // Eliminar del servidor (MongoDB)
                const res = await fetch(`${API_BASE}/api/championships/${champId}/categories/${encodeURIComponent(catName)}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success || res.status === 200 || res.ok) {
                    // Eliminar de los datos en memoria
                    if (categoriesData[champId] && categoriesData[champId][catName]) {
                        delete categoriesData[champId][catName];
                        // Si no quedan categor√≠as, eliminar el campeonato del objeto
                        if (Object.keys(categoriesData[champId]).length === 0) {
                            delete categoriesData[champId];
                        }
                    }
                    
                    // Actualizar tambi√©n championshipsData
                    if (championshipsData[champId] && championshipsData[champId].categories) {
                        delete championshipsData[champId].categories[catName];
                    }
                    
                    console.log(`‚úÖ Categor√≠a ${catName} eliminada de memoria y MongoDB`);
                    
                    // Recargar datos y actualizar vista
                    loadData();
                    renderCategories();
                    updateForm();
                    
                    showAlert(`‚úÖ Categor√≠a "${catName}" eliminada exitosamente de MongoDB y la aplicaci√≥n`, 'success');
                } else {
                    showAlert(`‚ùå Error al eliminar: ${data.error || 'Error desconocido'}`, 'error');
                }
            } catch (error) {
                console.error('Error eliminando categor√≠a:', error);
                showAlert(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }
        
        // Hacer la funci√≥n globalmente accesible
        window.deleteCategory = deleteCategory;
        
        /**
         * Funci√≥n helper para obtener equipos de una categor√≠a (√∫til para recrear)
         */
        async function obtenerEquiposDeCategoria(champId, categoryName) {
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}`);
                
                // Si el campeonato no existe, no mostrar error
                if (res.status === 404) {
                    console.log(`‚ö†Ô∏è  Campeonato "${champId}" no encontrado`);
                    return null;
                }
                
                if (!res.ok) {
                    console.error(`Error ${res.status} obteniendo campeonato`);
                    return null;
                }
                
                const data = await res.json();
                
                if (data.success && data.championship && data.championship.categories && data.championship.categories[categoryName]) {
                    const cat = data.championship.categories[categoryName];
                    const teams = cat.teams.map(t => t.name || t);
                    console.log(`\nüìÇ Categor√≠a: ${categoryName}`);
                    console.log(`   Equipos (${teams.length}):`);
                    teams.forEach((team, i) => console.log(`   ${i + 1}. ${team}`));
                    console.log(`\n   Para recrear:`);
                    console.log(`   await recrearCategoria('${champId}', '${categoryName}', ${JSON.stringify(teams)});`);
                    return teams;
                } else {
                    console.log(`‚ùå Categor√≠a "${categoryName}" no encontrada en el campeonato`);
                    return null;
                }
            } catch (error) {
                // No mostrar errores 404 en la consola
                const is404Error = error.message && error.message.includes('404');
                if (!is404Error) {
                    console.error(`Error obteniendo equipos:`, error);
                }
                return null;
            }
        }
        
        /**
         * Funci√≥n helper para recrear una categor√≠a (eliminar y crear con nuevo algoritmo)
         */
        async function recrearCategoria(champId, categoryName, teams) {
            console.log(`\nüîÑ Recreando categor√≠a: ${categoryName}`);
            console.log(`   Campeonato: ${champId}`);
            console.log(`   Equipos: ${teams.join(', ')}`);
            
            // Paso 1: Eliminar
            console.log(`\n   1Ô∏è‚É£ Eliminando categor√≠a existente...`);
            try {
                const deleteRes = await fetch(`${API_BASE}/api/championships/${champId}/categories/${encodeURIComponent(categoryName)}`, {
                    method: 'DELETE'
                });
                const deleteData = await deleteRes.json();
                
                if (deleteData.success) {
                    console.log(`   ‚úÖ Categor√≠a eliminada`);
                } else {
                    console.log(`   ‚ö†Ô∏è  ${deleteData.error || 'No exist√≠a'}`);
                }
            } catch (error) {
                console.log(`   ‚ö†Ô∏è  Error al eliminar: ${error.message}`);
            }
            
            // Esperar un momento
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Paso 2: Crear
            console.log(`\n   2Ô∏è‚É£ Creando categor√≠a con nuevo algoritmo...`);
            try {
                const createRes = await fetch(`${API_BASE}/api/championships/${champId}/categories`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: categoryName,
                        teams: teams
                    })
                });
                const createData = await createRes.json();
                
                if (createData.success) {
                    console.log(`   ‚úÖ Categor√≠a creada exitosamente`);
                    console.log(`   üìÖ El nuevo fixture tiene 2 partidos por jornada`);
                    
                    // Recargar datos
                    if (typeof window.loadData === 'function') {
                        await window.loadData();
                    }
                    
                    return true;
                } else {
                    console.error(`   ‚ùå Error: ${createData.error}`);
                    return false;
                }
            } catch (error) {
                console.error(`   ‚ùå Error al crear: ${error.message}`);
                return false;
            }
        }
        
        /**
         * Funci√≥n helper para listar todas las categor√≠as con sus equipos
         */
        async function listarTodasLasCategorias() {
            console.log('üìã Obteniendo todas las categor√≠as...\n');
            
            try {
                const res = await fetch(`${API_BASE}/api/championships`);
                
                if (!res.ok) {
                    if (res.status === 404) {
                        console.log('‚ö†Ô∏è  No hay campeonatos en el servidor');
                        return [];
                    }
                    console.error(`‚ùå Error ${res.status} obteniendo campeonatos`);
                    return [];
                }
                
                const data = await res.json();
                
                if (data.success && data.championships && Object.keys(data.championships).length > 0) {
                    console.log('üìä CATEGOR√çAS ENCONTRADAS:\n');
                    console.log('='.repeat(80));
                    
                    const categoriasInfo = [];
                    const validChampIds = Object.keys(data.championships).filter(id => {
                        const champ = data.championships[id];
                        return champ && champ.name;
                    });
                    
                    for (const champId of validChampIds) {
                        const champ = data.championships[champId];
                        console.log(`\nüèÜ ${champ.name} (ID: ${champId})`);
                        
                        try {
                            // Obtener detalles completos
                            const champRes = await fetch(`${API_BASE}/api/championships/${champId}`);
                            
                            // Si el campeonato no existe, omitir
                            if (champRes.status === 404) {
                                console.log(`   ‚ö†Ô∏è  Este campeonato no existe en el servidor, omitiendo...`);
                                continue;
                            }
                            
                            if (!champRes.ok) {
                                console.log(`   ‚ö†Ô∏è  Error ${champRes.status} obteniendo detalles, omitiendo...`);
                                continue;
                            }
                            
                            const champData = await champRes.json();
                            
                            if (champData.success && champData.championship && champData.championship.categories) {
                                const categories = champData.championship.categories;
                                const categoryNames = Object.keys(categories);
                                
                                if (categoryNames.length === 0) {
                                    console.log(`   ‚ö†Ô∏è  No hay categor√≠as en este campeonato`);
                                    continue;
                                }
                                
                                for (const catName of categoryNames) {
                                    const cat = categories[catName];
                                    if (cat && cat.teams) {
                                        const teams = cat.teams.map(t => t.name || t);
                                        console.log(`\n   üìÇ ${catName}`);
                                        console.log(`      Equipos (${teams.length}): ${teams.join(', ')}`);
                                        
                                        categoriasInfo.push({
                                            champId: champId,
                                            champName: champ.name,
                                            categoryName: catName,
                                            teams: teams
                                        });
                                        
                                        console.log(`      \n      Para recrear:`);
                                        console.log(`      await recrearCategoria('${champId}', '${catName}', ${JSON.stringify(teams)});`);
                                    }
                                }
                            }
                        } catch (error) {
                            // Omitir errores silenciosamente para campeonatos que no existen
                            const is404Error = error.message && error.message.includes('404');
                            if (!is404Error) {
                                console.log(`   ‚ö†Ô∏è  Error obteniendo detalles del campeonato ${champId}`);
                            }
                            continue;
                        }
                    }
                    
                    if (categoriasInfo.length === 0) {
                        console.log('\n‚ö†Ô∏è  No se encontraron categor√≠as con equipos');
                    } else {
                        console.log('\n' + '='.repeat(80));
                        console.log(`\n‚úÖ Total: ${categoriasInfo.length} categor√≠a(s) encontrada(s)`);
                    }
                    
                    console.log('\nüí° Usa las funciones:');
                    console.log('   - obtenerEquiposDeCategoria(champId, categoryName)');
                    console.log('   - recrearCategoria(champId, categoryName, teams)');
                    console.log('   - listarTodasLasCategorias()');
                    
                    return categoriasInfo;
                } else {
                    console.log('‚ö†Ô∏è  No hay campeonatos en el servidor');
                    return [];
                }
            } catch (error) {
                // No mostrar errores 404
                const is404Error = error.message && error.message.includes('404');
                if (!is404Error) {
                    console.error('‚ùå Error:', error);
                }
                return [];
            }
        }
        
        // Hacer funciones globalmente accesibles
        window.obtenerEquiposDeCategoria = obtenerEquiposDeCategoria;
        window.recrearCategoria = recrearCategoria;
        window.listarTodasLasCategorias = listarTodasLasCategorias;
        
        console.log(`
üìã Funciones helper cargadas:

1. listarTodasLasCategorias()
   - Lista todas las categor√≠as con sus equipos
   - Muestra c√≥digo para recrear cada una

2. obtenerEquiposDeCategoria(champId, categoryName)
   - Obtiene los equipos de una categor√≠a espec√≠fica
   - Ejemplo: obtenerEquiposDeCategoria('champ1', 'TC')

3. recrearCategoria(champId, categoryName, teams)
   - Elimina y recrea una categor√≠a con el nuevo algoritmo
   - Ejemplo: recrearCategoria('champ1', 'TC', ['Equipo A', 'Equipo B', ...])

üí° Para recrear 3 categor√≠as:
   1. Ejecuta: listarTodasLasCategorias()
   2. Copia los equipos de cada categor√≠a
   3. Ejecuta: recrearCategoria(champId, 'NombreCategoria', [equipos])
`);
        
        // Asegurar que updateForm est√© disponible globalmente
        window.updateForm = function() {
            const action = document.getElementById('actionSelect').value;
            const formDiv = document.getElementById('dynamicForm');
            let html = '';
            
            // Obtener IDs de campeonatos disponibles
            const champIds = Object.keys(championshipsData);
            const champOptions = champIds.length > 0 
                ? champIds.map(id => `<option value="${id}">${championshipsData[id].name || id}</option>`).join('')
                : '<option value="">No hay campeonatos</option>';
            
            switch(action) {
                case 'createChamp':
                    html = `
                        <div class="help-text" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">
                            <strong>üìù Crear un Nuevo Campeonato</strong>
                            Complete todos los campos a continuaci√≥n. Todos los campos son obligatorios.
                        </div>
                        <div class="form-group">
                            <label for="champId">üîë C√≥digo del Campeonato (ID):</label>
                            <input type="text" id="champId" placeholder="champ1" value="champ${champIds.length + 1}" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Ingrese un c√≥digo √∫nico para identificar este campeonato (por ejemplo: champ1, torneo2024)</div>
                        </div>
                        <div class="form-group">
                            <label for="name">üìõ Nombre del Campeonato:</label>
                            <input type="text" id="name" placeholder="Campeonato 2024" value="Campeonato ${new Date().getFullYear()}" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Escriba el nombre completo del campeonato (por ejemplo: "Campeonato de B√°squetbol 2024")</div>
                        </div>
                        <div class="form-group">
                            <label for="rounds">üîÑ N√∫mero de Vueltas:</label>
                            <input type="number" id="rounds" value="2" min="1" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Ingrese cu√°ntas vueltas tendr√° el campeonato. Normalmente son 2 vueltas (ida y vuelta).</div>
                        </div>
                        <div class="form-group">
                            <label for="pointsWin">‚≠ê Puntos por Victoria:</label>
                            <input type="number" id="pointsWin" value="2" min="0" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Cuantos puntos gana un equipo cuando gana un partido (normalmente 2 puntos)</div>
                        </div>
                        <div class="form-group">
                            <label for="pointsLoss">üìâ Puntos por Derrota:</label>
                            <input type="number" id="pointsLoss" value="0" min="0" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Cuantos puntos gana un equipo cuando pierde un partido (normalmente 0 puntos)</div>
                        </div>
                    `;
                    // Actualizar texto de ayuda
                    document.getElementById('helpText').textContent = 'Complete todos los campos del formulario y luego haga clic en "Crear Ahora" para crear el campeonato.';
                    break;
                case 'addCategory':
                    html = `
                        <div class="help-text" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">
                            <strong>üìÅ Agregar una Categor√≠a</strong>
                            Primero seleccione el campeonato al que desea agregar la categor√≠a, luego complete los datos de la categor√≠a.
                        </div>
                        <div class="form-group">
                            <label for="champIdSelect">üèÜ Seleccione el Campeonato:</label>
                            <select id="champIdSelect" onchange="loadCategoryTeams()" style="font-size: 1.1em; padding: 18px;">
                                ${champOptions}
                            </select>
                            <div class="field-help">Elija el campeonato al que desea agregar esta categor√≠a</div>
                        </div>
                        <div class="form-group">
                            <label for="categoryName">üìõ Nombre de la Categor√≠a:</label>
                            <input type="text" id="categoryName" placeholder="TC" list="categorySuggestions" style="font-size: 1.1em; padding: 18px;">
                            <datalist id="categorySuggestions">
                                <option value="TC">
                                <option value="Senior">
                                <option value="Super Senior">
                            </datalist>
                            <div class="field-help">Escriba el nombre de la categor√≠a (por ejemplo: TC, Senior, Super Senior)</div>
                        </div>
                        <div class="form-group">
                            <label for="teams">üë• Nombres de los Equipos (separados por comas):</label>
                            <input type="text" id="teams" placeholder="Equipo A, Equipo B, Equipo C" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Escriba los nombres de los equipos separados por comas. Ejemplo: "Los Leones, Los Tigres, Los Osos"</div>
                        </div>
                        <div class="form-group">
                            <label for="numTeams">üî¢ O ingrese el n√∫mero de equipos (se crear√°n nombres autom√°ticos):</label>
                            <input type="number" id="numTeams" placeholder="4" min="2" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Si prefiere, puede ingresar solo el n√∫mero de equipos y se crear√°n nombres autom√°ticos (Equipo 1, Equipo 2, etc.)</div>
                        </div>
                    `;
                    // Actualizar texto de ayuda
                    document.getElementById('helpText').textContent = 'Seleccione el campeonato y complete los datos de la categor√≠a. Puede ingresar los nombres de los equipos o solo el n√∫mero de equipos.';
                    break;
            }
            
            formDiv.innerHTML = html;
        }
        
        function loadCategoryTeams() {
            const champId = document.getElementById('champIdSelect')?.value;
            if (!champId || !championshipsData[champId]) return;
            
            const categories = categoriesData[champId] || {};
            const categorySelect = document.getElementById('categorySelect');
            
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                    Object.keys(categories).map(cat => 
                        `<option value="${cat}">${cat}</option>`
                    ).join('');
                
                categorySelect.onchange = loadTeams;
            }
            
            loadTeams();
        }
        
        function loadTeams() {
            const champId = document.getElementById('champIdSelect')?.value;
            const category = document.getElementById('categorySelect')?.value;
            
            if (!champId || !category || !categoriesData[champId] || !categoriesData[champId][category]) {
                return;
            }
            
            const teams = categoriesData[champId][category].teams || [];
            const teamOptions = teams.map(team => 
                `<option value="${team.name || team}">${team.name || team}</option>`
            ).join('');
            
            ['teamA', 'teamB', 'teamSelect'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Selecciona equipo</option>' + teamOptions;
                }
            });
        }
        
        // Asegurar que executeAction est√© disponible globalmente
        window.executeAction = async function() {
            try {
                const actionSelect = document.getElementById('actionSelect');
                if (!actionSelect) {
                    showAlert('Error: No se encontr√≥ el selector de acci√≥n. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
                
                const action = actionSelect.value;
                const responseDiv = document.getElementById('response');
                const responseCard = document.getElementById('responseCard');
                
                if (!responseDiv || !responseCard) {
                    showAlert('Error: No se encontraron los elementos de respuesta. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
                
                responseCard.style.display = 'block';
                responseDiv.innerHTML = '<pre>Cargando...</pre>';
                
                // Verificar autenticaci√≥n de administrador
                if (!authToken || !currentUser) {
                    showAlert('‚ö†Ô∏è Debes iniciar sesi√≥n como administrador para crear campeonatos o categor√≠as', 'error');
                    showAuthModal();
                    return;
                }
                
                if (currentUser.role !== 'admin') {
                    showAlert('‚ö†Ô∏è Solo los administradores pueden crear campeonatos y categor√≠as', 'error');
                    return;
                }
                
                // Preparar headers con autenticaci√≥n
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                };
                
                let url = '';
                let options = {};
                switch(action) {
                    case 'createChamp':
                        url = `${API_BASE}/api/championships`;
                        options = {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                id: document.getElementById('champId').value,
                                name: document.getElementById('name').value,
                                rounds: parseInt(document.getElementById('rounds').value),
                                points_per_win: parseInt(document.getElementById('pointsWin').value),
                                points_per_loss: parseInt(document.getElementById('pointsLoss').value)
                            })
                        };
                        break;
                    case 'addCategory':
                        const champId = document.getElementById('champIdSelect')?.value;
                        
                        if (!champId) {
                            showAlert('‚ùå Debe seleccionar un campeonato antes de continuar', 'error');
                            responseDiv.innerHTML = '<div style="color: red; padding: 20px;"><strong>Error:</strong> No se seleccion√≥ ning√∫n campeonato. Por favor, selecciona un campeonato de la lista.</div>';
                            return;
                        }
                        
                        const categoryName = document.getElementById('categoryName')?.value?.trim();
                        if (!categoryName || categoryName.length < 2) {
                            showAlert('‚ùå Debe escribir el nombre de la categor√≠a (m√≠nimo 2 caracteres). Ejemplo: TC, Senior, Super Senior', 'error');
                            responseDiv.innerHTML = '<div style="color: red; padding: 20px;"><strong>Error:</strong> El nombre de la categor√≠a es obligatorio y debe tener al menos 2 caracteres.</div>';
                            return;
                        }
                        
                        url = `${API_BASE}/api/championships/${champId}/categories`;
                        const teamsInput = document.getElementById('teams')?.value?.trim() || '';
                        const numTeamsInput = document.getElementById('numTeams')?.value?.trim() || '';
                        const numTeams = numTeamsInput ? parseInt(numTeamsInput) : 0;
                        
                        const body = {
                            name: categoryName
                        };
                        
                        // Validar y procesar equipos
                        if (teamsInput && teamsInput.length > 0) {
                            const teams = teamsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
                            if (teams.length >= 2) {
                                body.teams = teams;
                            } else {
                                showAlert('‚ùå Debe ingresar al menos 2 equipos. Escriba los nombres separados por comas. Ejemplo: "Equipo A, Equipo B, Equipo C"', 'error');
                                responseDiv.innerHTML = `<div style="color: red; padding: 20px;">
                                    <strong>Error:</strong> Se necesitan al menos 2 equipos para crear una categor√≠a.<br>
                                    <strong>Ingresaste:</strong> ${teams.length} equipo(s)<br>
                                    <strong>Ejemplo correcto:</strong> "Equipo A, Equipo B, Equipo C"
                                </div>`;
                                return;
                            }
                        } else if (numTeams >= 2 && numTeams <= 20) {
                            body.num_teams = numTeams;
                        } else {
                            showAlert('‚ùå Debe ingresar los nombres de los equipos (separados por comas) O el n√∫mero de equipos (entre 2 y 20)', 'error');
                            responseDiv.innerHTML = `<div style="color: red; padding: 20px;">
                                <strong>Error:</strong> Debes proporcionar una de estas opciones:<br><br>
                                <strong>Opci√≥n 1:</strong> Escribe los nombres de los equipos separados por comas<br>
                                &nbsp;&nbsp;&nbsp;&nbsp;Ejemplo: "Los Leones, Los Tigres, Los Osos"<br><br>
                                <strong>Opci√≥n 2:</strong> Escribe el n√∫mero de equipos (entre 2 y 20)<br>
                                &nbsp;&nbsp;&nbsp;&nbsp;Ejemplo: 4 (se crear√°n nombres autom√°ticos)
                            </div>`;
                            return;
                        }
                        
                        // Mostrar indicador de carga
                        responseDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div><div style="font-size: 1.2em;">Creando categor√≠a...</div></div>';
                        
                        options = {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        };
                        break;
                }
                
                const res = await fetch(url, options);
                const data = await res.json();
                
                // Mostrar respuesta detallada para debugging
                console.log('Respuesta del servidor:', data);
                responseDiv.innerHTML = `<pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                
                if (data.success) {
                    if (action === 'createChamp') {
                        responseDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 4em; margin-bottom: 20px;">‚úÖ</div>
                                <div style="font-size: 1.5em; color: #28a745; font-weight: bold; margin-bottom: 10px;">¬°Campeonato Creado!</div>
                                <div style="font-size: 1.2em; color: #666; margin-bottom: 20px;">${data.championship.name}</div>
                                <div style="font-size: 1em; color: #999;">Ahora puedes agregar categor√≠as</div>
                            </div>
                        `;
                        showAlert('¬°Campeonato creado exitosamente!', 'success');
                    } else if (action === 'addCategory') {
                        responseDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 4em; margin-bottom: 20px;">‚úÖ</div>
                                <div style="font-size: 1.5em; color: #28a745; font-weight: bold; margin-bottom: 10px;">¬°Categor√≠a Agregada!</div>
                                <div style="font-size: 1.2em; color: #666; margin-bottom: 20px;">${data.category.name || 'Categor√≠a'}</div>
                                <div style="font-size: 1em; color: #999;">El calendario se ha generado autom√°ticamente</div>
                            </div>
                        `;
                        showAlert('¬°Categor√≠a agregada exitosamente! El calendario de partidos se ha generado autom√°ticamente.', 'success');
                    } else {
                        showAlert('Operaci√≥n completada exitosamente', 'success');
                    }
                    // Guardar en localStorage si se cre√≥ un campeonato
                    // Recargar datos despu√©s de crear/modificar
                    if (action === 'createChamp' || action === 'addCategory') {
                        // Recargar datos inmediatamente y luego de nuevo despu√©s de un segundo
                        showAlert('üîÑ Actualizando lista de campeonatos...', 'info');
                        loadData();
                        setTimeout(() => {
                            loadData();
                            renderChampionships();
                            renderCategories();
                            updateForm(); // Actualizar formularios con nuevos datos
                            showAlert('‚úÖ Lista actualizada. Los campeonatos se guardan en MongoDB y aparecen en "üìä Datos Creados"', 'success');
                        }, 1500);
                    }
                } else {
                    // Mostrar error detallado
                    const errorMessage = data.error || 'Ocurri√≥ un error desconocido';
                    const errorDetails = data.errors ? data.errors.join(', ') : '';
                    
                    responseDiv.innerHTML = `
                        <div style="background: #fee; border: 2px solid #fcc; border-radius: 10px; padding: 20px; color: #c33;">
                            <h3 style="color: #c33; margin-bottom: 15px;">‚ùå Error al ${action === 'addCategory' ? 'agregar categor√≠a' : 'crear campeonato'}</h3>
                            <p style="font-size: 1.1em; margin-bottom: 10px;"><strong>${errorMessage}</strong></p>
                            ${errorDetails ? `<p style="margin-top: 10px; color: #a00;">Detalles: ${errorDetails}</p>` : ''}
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #fcc;">
                                <strong>¬øQu√© hacer?</strong>
                                <ul style="margin-top: 10px; padding-left: 20px;">
                                    <li>Verifica que todos los campos est√©n completos</li>
                                    <li>Verifica que el nombre de la categor√≠a no est√© duplicado</li>
                                    <li>Verifica que hayas ingresado al menos 2 equipos</li>
                                    <li>Intenta nuevamente</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    showAlert(errorMessage + (errorDetails ? ': ' + errorDetails : ''), 'error');
                }
            } catch (error) {
                if (responseDiv) {
                    responseDiv.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
                }
                showAlert('Error de conexi√≥n', 'error');
            }
        };
        
        // Asegurar que loadView est√© disponible globalmente
        window.loadView = function() {
            const view = document.getElementById('viewSelect').value;
            const formDiv = document.getElementById('viewForm');
            const champIds = Object.keys(championshipsData);
            const champOptions = champIds.map(id => `<option value="${id}">${championshipsData[id].name || id}</option>`).join('');
            
            let html = `
                <div class="form-group">
                    <label for="champIdView">Campeonato:</label>
                    <select id="champIdView" onchange="loadViewCategories()">
                        ${champOptions}
                    </select>
                </div>
            `;
            
            if (view === 'standings' || view === 'fixture' || view === 'calendar' || view === 'calendar-week') {
                html += `
                    <div class="form-group">
                        <label for="categoryView">Categor√≠a:</label>
                        <select id="categoryView">
                            <option value="">Selecciona categor√≠a</option>
                        </select>
                    </div>
                `;
                
                if (view === 'fixture') {
                    html += `
                        <div class="form-group">
                            <label for="roundView">Vuelta (opcional):</label>
                            <input type="number" id="roundView" placeholder="Dejar vac√≠o para todas" min="1">
                        </div>
                    `;
                }
            }
            
            formDiv.innerHTML = html;
            if (champIds.length > 0) {
                setTimeout(() => loadViewCategories(), 100);
            }
        }
        
        function loadViewCategories() {
            const champId = document.getElementById('champIdView')?.value;
            if (!champId) {
                const categoryView = document.getElementById('categoryView');
                if (categoryView) {
                    categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>';
                }
                return;
            }
            
            // Intentar obtener categor√≠as de categoriesData primero
            let categories = [];
            if (categoriesData[champId]) {
                categories = Object.keys(categoriesData[champId]);
            } else if (championshipsData[champId] && championshipsData[champId].categories) {
                // Si no est√° en categoriesData, intentar desde championshipsData
                categories = Object.keys(championshipsData[champId].categories);
                // Actualizar categoriesData para futuras referencias
                categoriesData[champId] = championshipsData[champId].categories;
            } else {
                // Si no hay categor√≠as en memoria, intentar cargar desde el servidor
                fetch(`${API_BASE}/api/championships/${champId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.championship && data.championship.categories) {
                            categories = Object.keys(data.championship.categories);
                            // Actualizar datos en memoria
                            if (!categoriesData[champId]) {
                                categoriesData[champId] = data.championship.categories;
                            }
                            if (!championshipsData[champId]) {
                                championshipsData[champId] = {
                                    name: data.championship.name,
                                    rounds: data.championship.rounds,
                                    points_per_win: data.championship.points_per_win,
                                    points_per_loss: data.championship.points_per_loss,
                                    categories: data.championship.categories
                                };
                            } else {
                                championshipsData[champId].categories = data.championship.categories;
                            }
                            
                            // Actualizar el selector
                            const categoryView = document.getElementById('categoryView');
                            if (categoryView) {
                                categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                            }
                        } else {
                            const categoryView = document.getElementById('categoryView');
                            if (categoryView) {
                                categoryView.innerHTML = '<option value="">No hay categor√≠as</option>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando categor√≠as:', error);
                        const categoryView = document.getElementById('categoryView');
                        if (categoryView) {
                            categoryView.innerHTML = '<option value="">Error al cargar categor√≠as</option>';
                        }
                    });
                return; // Salir temprano si estamos cargando desde el servidor
            }
            
            const categoryView = document.getElementById('categoryView');
            if (categoryView) {
                if (categories.length > 0) {
                    categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                } else {
                    categoryView.innerHTML = '<option value="">No hay categor√≠as</option>';
                }
            }
        }
        
        // Asegurar que loadViewData est√© disponible globalmente
        window.loadViewData = async function() {
            try {
                const viewSelect = document.getElementById('viewSelect');
                if (!viewSelect) {
                    showAlert('Error: No se encontr√≥ el selector de vista. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
                
                const view = viewSelect.value;
                const champId = document.getElementById('champIdView')?.value;
                const responseDiv = document.getElementById('response');
                const responseCard = document.getElementById('responseCard');
                
                if (!responseDiv || !responseCard) {
                    showAlert('Error: No se encontraron los elementos de respuesta. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
            
            if (!champId) {
                showAlert('Selecciona un campeonato', 'error');
                return;
            }
            
            responseCard.style.display = 'block';
            responseDiv.innerHTML = '<pre>Cargando...</pre>';
            
            try {
                let url;
                
                if (view === 'standings') {
                    const category = document.getElementById('categoryView').value;
                    if (!category) {
                        showAlert('Selecciona una categor√≠a', 'error');
                        return;
                    }
                    url = `${API_BASE}/api/championships/${champId}/standings/${category}`;
                } else if (view === 'fixture' || view === 'calendar') {
                    const category = document.getElementById('categoryView').value;
                    if (!category) {
                        showAlert('Selecciona una categor√≠a', 'error');
                        return;
                    }
                    const round = document.getElementById('roundView')?.value;
                    url = `${API_BASE}/api/championships/${champId}/fixture/${category}`;
                    if (round) url += `?round=${round}`;
                    window.currentCategory = category; // Guardar para usar en renderFixture
                } else {
                    showAlert('Selecciona una opci√≥n v√°lida', 'error');
                    return;
                }
                
                const res = await fetch(url);
                
                // Si no se encuentra el recurso (404), no mostrar nada
                if (res.status === 404) {
                    console.log(`‚ö†Ô∏è  Recurso no encontrado: ${url}`);
                    showAlert('El campeonato o categor√≠a no fue encontrado', 'warning');
                    responseDiv.innerHTML = '<div class="empty-state">El campeonato o categor√≠a no existe</div>';
                    return;
                }
                
                if (!res.ok) {
                    showAlert(`Error ${res.status}: No se pudo cargar la informaci√≥n`, 'error');
                    responseDiv.innerHTML = `<div class="empty-state">Error al cargar datos (${res.status})</div>`;
                    return;
                }
                
                const data = await res.json();
                
                if (!data.success) {
                    showAlert(data.error || 'Error', 'error');
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    return;
                }
                
                // Renderizar seg√∫n el tipo de vista
                if (view === 'fixture' && data.matches) {
                    const category = document.getElementById('categoryView').value;
                    window.originalMatches = data.matches; // Guardar matches originales para filtrado
                    responseDiv.innerHTML = renderFixture(data.matches, category || 'Categor√≠a');
                } else if (view === 'calendar' && data.matches) {
                    const category = document.getElementById('categoryView').value;
                    window.originalMatches = data.matches; // Guardar matches originales
                    responseDiv.innerHTML = renderCalendarView(data.matches, category || 'Categor√≠a');
                } else if (view === 'calendar-week' && data.matches) {
                    const category = document.getElementById('categoryView').value;
                    window.originalMatches = data.matches; // Guardar matches originales
                    responseDiv.innerHTML = renderCalendarWeekView(data.matches, category || 'Categor√≠a');
                } else if (view === 'standings' && data.standings) {
                    window.currentStandings = data.standings; // Guardar para usar en estad√≠sticas
                    responseDiv.innerHTML = renderStandings(data.standings);
                } else {
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                console.error('Error en loadViewData (interno):', error);
                if (responseDiv) {
                    responseDiv.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
                }
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
            } catch (error) {
                console.error('Error cr√≠tico en loadViewData:', error);
                showAlert('Error cr√≠tico: ' + error.message, 'error');
            }
        };
        
        function renderFixture(matches, categoryName) {
            if (!matches || matches.length === 0) {
                return '<div class="empty-state">No hay partidos en el fixture</div>';
            }
            
            // Guardar matches originales si no est√°n guardados
            if (!window.originalMatches) {
                window.originalMatches = matches;
            }
            
            // Cargar preferencias de filtro despu√©s de un peque√±o delay
            setTimeout(loadFixtureFilterPreferences, 100);
            
            // Agrupar partidos por tipo (ida/vuelta) y luego por jornada
            const matchesByVuelta = {
                'ida': {},
                'vuelta': {}
            };
            
            matches.forEach(match => {
                const matchType = match.match_type || 'ida';
                const matchday = match.matchday || 1;
                
                if (!matchesByVuelta[matchType]) {
                    matchesByVuelta[matchType] = {};
                }
                if (!matchesByVuelta[matchType][matchday]) {
                    matchesByVuelta[matchType][matchday] = [];
                }
                matchesByVuelta[matchType][matchday].push(match);
            });
            
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            // Calcular total de partidos
            const totalPartidos = matches.length;
            const partidosJugados = matches.filter(m => m.played).length;
            const partidosPendientes = totalPartidos - partidosJugados;
            
            let html = `<div class="fixture-container" style="padding: 25px; font-size: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3 class="fixture-title" style="color: #667eea; margin: 0; font-size: 2em; font-weight: 700;">üìÖ Fixture - ${categoryName}</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="exportToICal()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
                                üì• Exportar a Calendario (.ics)
                            </button>
                            <button onclick="exportCalendarToImage()" style="padding: 10px 20px; background: #25d366; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em;">
                                üì§ Exportar a WhatsApp
                            </button>
                        </div>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label for="fixtureSearchTeam" style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea; font-size: 0.9em;">üîç Buscar Equipo</label>
                                <input type="text" id="fixtureSearchTeam" placeholder="Nombre del equipo..." 
                                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;"
                                       onkeyup="filterFixtureMatches()">
                            </div>
                            <div>
                                <label for="fixtureFilterStatus" style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea; font-size: 0.9em;">üìä Estado</label>
                                <select id="fixtureFilterStatus" onchange="filterFixtureMatches()"
                                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;">
                                    <option value="">Todos</option>
                                    <option value="played">Solo jugados</option>
                                    <option value="pending">Solo pendientes</option>
                                </select>
                            </div>
                            <div>
                                <label for="fixtureFilterVuelta" style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea; font-size: 0.9em;">üîÑ Vuelta</label>
                                <select id="fixtureFilterVuelta" onchange="filterFixtureMatches()"
                                        style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;">
                                    <option value="">Todas</option>
                                    <option value="ida">Vuelta Ida</option>
                                    <option value="vuelta">Vuelta Vuelta</option>
                                </select>
                            </div>
                            <div>
                                <label for="fixtureFilterDateFrom" style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea; font-size: 0.9em;">üìÖ Fecha Desde</label>
                                <input type="date" id="fixtureFilterDateFrom" onchange="filterFixtureMatches()"
                                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;">
                            </div>
                            <div>
                                <label for="fixtureFilterDateTo" style="display: block; margin-bottom: 5px; font-weight: 600; color: #667eea; font-size: 0.9em;">üìÖ Fecha Hasta</label>
                                <input type="date" id="fixtureFilterDateTo" onchange="filterFixtureMatches()"
                                       style="width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;">
                            </div>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <button onclick="clearFixtureFilters()" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                üóëÔ∏è Limpiar Filtros
                            </button>
                            <div id="fixtureFilterCount" style="font-weight: 600; color: #667eea;">
                                Mostrando <span id="fixtureVisibleCount">${totalPartidos}</span> de <span id="fixtureTotalCount">${totalPartidos}</span> partidos
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fixture-stats" style="background: linear-gradient(135deg, #f0f8ff 0%, #e0e8f0 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="text-align: center;">
                        <div class="fixture-stat-number" style="font-size: 3.5em; font-weight: bold; color: #667eea; margin-bottom: 8px;">${totalPartidos}</div>
                        <div class="fixture-stat-label" style="font-size: 1.2em; color: #666; font-weight: 600;">Total Partidos</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="fixture-stat-number" style="font-size: 3.5em; font-weight: bold; color: #28a745; margin-bottom: 8px;">${partidosJugados}</div>
                        <div class="fixture-stat-label" style="font-size: 1.2em; color: #666; font-weight: 600;">Jugados</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="fixture-stat-number" style="font-size: 3.5em; font-weight: bold; color: #dc3545; margin-bottom: 8px;">${partidosPendientes}</div>
                        <div class="fixture-stat-label" style="font-size: 1.2em; color: #666; font-weight: 600;">Pendientes</div>
                    </div>
                </div>
            `;
            
            // Mostrar Vuelta 1 (ida) y Vuelta 2 (vuelta)
            const vueltaOrder = ['ida', 'vuelta'];
            
            vueltaOrder.forEach((matchType, index) => {
                const vueltaNum = index + 1;
                const vueltaMatches = matchesByVuelta[matchType];
                
                if (!vueltaMatches || Object.keys(vueltaMatches).length === 0) {
                    return; // Saltar si no hay partidos de este tipo
                }
                
                html += `
                    <div class="fixture-vuelta" style="margin-bottom: 40px; border: 3px solid #e0e0e0; border-radius: 20px; padding: 25px; background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%); box-shadow: 0 6px 20px rgba(0,0,0,0.1);">
                        <h4 class="fixture-vuelta-title" style="color: #667eea; margin-bottom: 25px; font-size: 1.8em; font-weight: 700; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span>Vuelta ${vueltaNum}</span>
                            <span style="font-size: 0.6em; color: #999; font-weight: normal; background: #e9ecef; padding: 6px 12px; border-radius: 10px;">(${matchType})</span>
                        </h4>
                `;
                
                // Ordenar jornadas
                const matchdays = Object.keys(vueltaMatches).sort((a, b) => parseInt(a) - parseInt(b));
                
                // Mostrar jornadas (exactamente 2 partidos por jornada)
                matchdays.forEach(matchday => {
                    const jornadaMatches = vueltaMatches[matchday];
                    
                    // Verificar que solo haya m√°ximo 2 partidos por jornada
                    if (jornadaMatches.length > 2) {
                        console.warn(`Jornada ${matchday} tiene m√°s de 2 partidos: ${jornadaMatches.length}`);
                    }
                    
                    html += `
                        <div class="fixture-jornada" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #fdfdfd 0%, #f0f0f0 100%); border-radius: 15px; border-left: 6px solid #667eea; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <h5 class="fixture-jornada-title" style="color: #667eea; margin-bottom: 20px; font-size: 1.5em; font-weight: 700; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span>Jornada ${matchday}</span>
                                <span style="font-size: 0.6em; color: #999; font-weight: normal; background: #e9ecef; padding: 4px 10px; border-radius: 8px;">(${jornadaMatches.length} partido${jornadaMatches.length > 1 ? 's' : ''})</span>
                            </h5>
                            <div style="display: grid; gap: 20px;">
                    `;
                    
                    // Mostrar solo los primeros 2 partidos de la jornada
                    jornadaMatches.slice(0, 2).forEach((match, idx) => {
                        const matchId = `match_${vueltaNum}_${matchType}_${matchday}_${idx}`;
                        const played = match.played;
                        const scoreA = match.score_a !== null && match.score_a !== undefined ? match.score_a : '';
                        const scoreB = match.score_b !== null && match.score_b !== undefined ? match.score_b : '';
                        const date = match.date || '';
                        const time = match.time || '';
                        const hasResult = played && scoreA !== '' && scoreB !== '';
                        
                        html += `
                            <div class="fixture-match" style="padding: 25px; background: ${hasResult ? '#f0fff4' : 'white'}; border-radius: 12px; border-left: 6px solid ${hasResult ? '#28a745' : '#667eea'}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div class="fixture-match-teams" style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 20px;">
                                    <div style="text-align: right;">
                                        <strong style="font-size: 1.3em; color: #1e3c72; font-weight: 700; word-break: break-word;">${match.team_a}</strong>
                                    </div>
                                    <div class="fixture-match-scores" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                                        <input type="number" id="${matchId}_scoreA" value="${scoreA}" 
                                            placeholder="0" min="0" 
                                            class="fixture-score-input"
                                            style="width: 90px; padding: 15px; text-align: center; border: 3px solid ${played ? '#28a745' : '#e0e0e0'}; border-radius: 10px; font-size: 1.3em; font-weight: 700; background: ${played ? '#f0fff4' : 'white'};"
                                            title="${played ? 'Resultado guardado - Puedes modificarlo' : 'Ingresa el marcador'}">
                                        <span style="font-weight: bold; color: #666; font-size: 1.5em;">-</span>
                                        <input type="number" id="${matchId}_scoreB" value="${scoreB}" 
                                            placeholder="0" min="0" 
                                            class="fixture-score-input"
                                            style="width: 90px; padding: 15px; text-align: center; border: 3px solid ${played ? '#28a745' : '#e0e0e0'}; border-radius: 10px; font-size: 1.3em; font-weight: 700; background: ${played ? '#f0fff4' : 'white'};"
                                            title="${played ? 'Resultado guardado - Puedes modificarlo' : 'Ingresa el marcador'}">
                                    </div>
                                    <div style="text-align: left;">
                                        <strong style="font-size: 1.3em; color: #1e3c72; font-weight: 700; word-break: break-word;">${match.team_b}</strong>
                                    </div>
                                </div>
                                
                                <div class="fixture-match-actions" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: center;">
                                    <div>
                                        <label for="${matchId}_date" style="font-size: 1em; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Fecha:</label>
                                        <input type="date" id="${matchId}_date" value="${date}" 
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <div>
                                        <label for="${matchId}_time" style="font-size: 1em; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Horario:</label>
                                        <input type="time" id="${matchId}_time" value="${time}" 
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <div>
                                        <button onclick="saveMatch('${champId}', '${category}', '${match.team_a}', '${match.team_b}', ${match.round_number}, ${match.matchday}, '${matchId}')" 
                                            class="fixture-action-button"
                                            style="padding: 12px 24px; background: ${hasResult ? 'linear-gradient(135deg, #28a745 0%, #20c997 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'}; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; white-space: nowrap; font-size: 1em; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                            ${hasResult ? 'üíæ Actualizar Resultado' : 'üíæ Guardar Resultado'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            });
            
            html += `</div>`;
            return html;
        }
        
        async function saveMatch(champId, category, teamA, teamB, roundNumber, matchday, matchId) {
            const scoreAInput = document.getElementById(`${matchId}_scoreA`);
            const scoreBInput = document.getElementById(`${matchId}_scoreB`);
            const scoreA = scoreAInput.value ? parseInt(scoreAInput.value) : null;
            const scoreB = scoreBInput.value ? parseInt(scoreBInput.value) : null;
            const date = document.getElementById(`${matchId}_date`).value;
            const time = document.getElementById(`${matchId}_time`).value;
            
            // Validar que si hay un score, haya ambos
            if ((scoreA !== null && scoreB === null) || (scoreA === null && scoreB !== null)) {
                showAlert('‚ö†Ô∏è Debes ingresar ambos marcadores o ninguno', 'error');
                return;
            }
            
            // Validar que no sean empates
            if (scoreA !== null && scoreB !== null && scoreA === scoreB && scoreA > 0) {
                showAlert('‚ö†Ô∏è Los partidos no pueden terminar en empate. Debe haber un ganador.', 'error');
                return;
            }
            
            try {
                // Verificar que el usuario est√© autenticado como administrador
                if (!authToken || !currentUser) {
                    showAlert('‚ö†Ô∏è Debes iniciar sesi√≥n como administrador para registrar resultados', 'error');
                    showAuthModal();
                    return;
                }
                
                if (currentUser.role !== 'admin') {
                    showAlert('‚ö†Ô∏è Solo los administradores pueden registrar resultados de partidos', 'error');
                    return;
                }
                
                // Preparar headers con autenticaci√≥n
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                };
                
                // Guardar fecha y horario
                if (date || time) {
                    const scheduleRes = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}/schedule`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify({
                            team_a: teamA,
                            team_b: teamB,
                            round_number: roundNumber,
                            matchday: matchday,
                            date: date,
                            time: time
                        })
                    });
                    
                    if (!scheduleRes.ok) {
                        const error = await scheduleRes.json();
                        if (scheduleRes.status === 401 || scheduleRes.status === 403) {
                            showAlert('‚ö†Ô∏è ' + (error.error || 'No autorizado. Solo administradores pueden realizar esta acci√≥n.'), 'error');
                            if (scheduleRes.status === 401) {
                                showAuthModal();
                            }
                        } else {
                            showAlert(error.error || 'Error al guardar fecha/horario', 'error');
                        }
                        return;
                    }
                }
                
                // Guardar resultado si hay scores (permite modificar resultados existentes)
                if (scoreA !== null && scoreB !== null && scoreA >= 0 && scoreB >= 0) {
                    const resultRes = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}/result`, {
                        method: 'PUT',
                        headers: headers,
                        body: JSON.stringify({
                            team_a: teamA,
                            team_b: teamB,
                            round_number: roundNumber,
                            matchday: matchday,
                            score_a: scoreA,
                            score_b: scoreB
                        })
                    });
                    
                    const resultData = await resultRes.json();
                    if (resultRes.ok && resultData.success) {
                        showAlert('‚úÖ Resultado guardado exitosamente en MongoDB', 'success');
                        // Recargar vista para mostrar el resultado actualizado
                        setTimeout(() => loadViewData(), 1000);
                    } else {
                        if (resultRes.status === 401 || resultRes.status === 403) {
                            showAlert('‚ö†Ô∏è ' + (resultData.error || 'No autorizado. Solo administradores pueden registrar resultados.'), 'error');
                            if (resultRes.status === 401) {
                                showAuthModal();
                            }
                        } else {
                            showAlert(resultData.error || 'Error al guardar resultado', 'error');
                        }
                    }
                } else if (date || time) {
                    showAlert('‚úÖ Fecha y horario guardados', 'success');
                    setTimeout(() => loadViewData(), 1000);
                } else {
                    showAlert('‚ö†Ô∏è Ingresa al menos fecha/horario o resultado', 'warning');
                }
            } catch (error) {
                showAlert('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        function renderStandings(standings) {
            if (!standings || standings.length === 0) {
                return '<div class="empty-state">No hay datos en la tabla de posiciones</div>';
            }
            
            const champId = document.getElementById('champIdView')?.value || '';
            const category = document.getElementById('categoryView')?.value || '';
            
            // Preparar datos para gr√°ficos
            const top10Teams = standings.slice(0, 10);
            const top10Names = top10Teams.map(t => t.name);
            const top10Points = top10Teams.map(t => t.points || 0);
            const top10Wins = top10Teams.map(t => t.pg || 0);
            const top10Losses = top10Teams.map(t => t.pp || 0);
            
            let html = `
                <div style="padding: 10px; overflow-x: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="color: #667eea; margin: 0;">üìä Tabla de Posiciones</h3>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <input type="text" id="standingsSearch" placeholder="üîç Buscar equipo..." 
                                   style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em; min-width: 200px;"
                                   onkeyup="searchInStandings(this.value)">
                            <button onclick="toggleStandingsCharts()" class="btn" style="background: #667eea; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                                üìà Ver Gr√°ficos
                            </button>
                            <button onclick="showPointsEvolutionChart()" class="btn" style="background: #17a2b8; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                                üìä Evoluci√≥n de Puntos
                            </button>
                            <button onclick="showHeatmapChart()" class="btn" style="background: #ff6b6b; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600;">
                                üî• Heatmap
                            </button>
                        </div>
                    </div>
                    
                    <!-- Gr√°ficos (ocultos inicialmente) -->
                    <div id="standingsCharts" style="display: none; margin-bottom: 30px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                            <!-- Gr√°fico de Puntos (Top 10) -->
                            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <h4 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em; font-weight: 700;">üèÜ Top 10 Equipos por Puntos</h4>
                                <canvas id="pointsChart" style="max-height: 300px;"></canvas>
                            </div>
                            
                            <!-- Gr√°fico de Victorias vs Derrotas -->
                            <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <h4 style="color: #667eea; margin-bottom: 20px; font-size: 1.3em; font-weight: 700;">üìä Victorias vs Derrotas (Top 10)</h4>
                                <canvas id="winsLossesChart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modal de Evoluci√≥n de Puntos -->
                    <div id="evolutionChartModal" class="modal" style="display: none;">
                        <div class="modal-content" style="max-width: 900px;">
                            <span class="close" onclick="document.getElementById('evolutionChartModal').style.display='none'">&times;</span>
                            <h2 style="color: #667eea; margin-bottom: 20px;">üìä Evoluci√≥n de Puntos por Equipo</h2>
                            <div id="evolutionChartContainer" style="padding: 20px;">
                                <div style="text-align: center; padding: 40px;">
                                    <div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div>
                                    <div style="font-size: 1.2em;">Cargando gr√°fico...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th id="th_position" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;" onclick="sortStandings('position')" title="Ordenar por posici√≥n">Pos <span id="sort_position">‚ÜïÔ∏è</span></th>
                                <th id="th_name" style="padding: 12px; text-align: left; cursor: pointer; user-select: none;" onclick="sortStandings('name')" title="Ordenar por nombre">Equipo <span id="sort_name">‚ÜïÔ∏è</span></th>
                                <th id="th_pj" style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="sortStandings('pj')" title="Ordenar por partidos jugados">PJ <span id="sort_pj">‚ÜïÔ∏è</span></th>
                                <th id="th_pg" style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="sortStandings('pg')" title="Ordenar por partidos ganados">PG <span id="sort_pg">‚ÜïÔ∏è</span></th>
                                <th id="th_pp" style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="sortStandings('pp')" title="Ordenar por partidos perdidos">PP <span id="sort_pp">‚ÜïÔ∏è</span></th>
                                <th id="th_pf" style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="sortStandings('pf')" title="Ordenar por puntos a favor">PF <span id="sort_pf">‚ÜïÔ∏è</span></th>
                                <th id="th_pc" style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="sortStandings('pc')" title="Ordenar por puntos en contra">PC <span id="sort_pc">‚ÜïÔ∏è</span></th>
                                <th id="th_difference" style="padding: 12px; text-align: center; cursor: pointer; user-select: none;" onclick="sortStandings('difference')" title="Ordenar por diferencia">Dif <span id="sort_difference">‚ÜïÔ∏è</span></th>
                                <th id="th_points" style="padding: 12px; text-align: center; font-weight: bold; cursor: pointer; user-select: none;" onclick="sortStandings('points')" title="Ordenar por puntos">Pts <span id="sort_points">‚ÜïÔ∏è</span></th>
                                <th style="padding: 12px; text-align: center;">
                                    <div style="display: flex; flex-direction: column; gap: 5px;">
                                        <span>Acciones</span>
                                        <button onclick="showTeamComparison()" style="padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                            Comparar Seleccionados
                                        </button>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Guardar standings originales para ordenamiento y b√∫squeda
            window.currentStandings = standings;
            window.originalStandings = [...standings]; // Copia para b√∫squeda
            window.currentStandingsSort = { field: null, ascending: true };
            
            standings.forEach((team, index) => {
                const position = index + 1;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                const rowColor = position <= 3 ? '#f0f8ff' : index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                
                html += `
                    <tr style="background: ${rowColor};">
                        <td style="padding: 12px; font-weight: bold; color: #667eea;">${position} ${medal}</td>
                        <td style="padding: 12px; font-weight: 600;">${team.name}</td>
                        <td style="padding: 12px; text-align: center;">${team.pj || 0}</td>
                        <td style="padding: 12px; text-align: center; color: #28a745;">${team.pg || 0}</td>
                        <td style="padding: 12px; text-align: center; color: #dc3545;">${team.pp || 0}</td>
                        <td style="padding: 12px; text-align: center;">${team.pf || 0}</td>
                        <td style="padding: 12px; text-align: center;">${team.pc || 0}</td>
                        <td style="padding: 12px; text-align: center; color: ${team.difference >= 0 ? '#28a745' : '#dc3545'};">${team.difference || 0}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea; font-size: 1.1em;">${team.points || 0}</td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: flex; gap: 5px; justify-content: center; flex-wrap: wrap;">
                                <button onclick="showTeamStats('${champId}', '${category}', '${team.name.replace(/'/g, "\\'")}')" 
                                        style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                    üìà Stats
                                </button>
                                <input type="checkbox" class="team-compare-checkbox" value="${team.name.replace(/'/g, "\\'")}" 
                                       style="width: 20px; height: 20px; cursor: pointer;" 
                                       title="Seleccionar para comparar">
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Guardar datos para gr√°ficos
            window.standingsChartData = {
                top10Names: top10Names,
                top10Points: top10Points,
                top10Wins: top10Wins,
                top10Losses: top10Losses
            };
            
            return html;
        }
        
        // Funci√≥n para mostrar/ocultar gr√°ficos
        function toggleStandingsCharts() {
            const chartsDiv = document.getElementById('standingsCharts');
            if (!chartsDiv) return;
            
            if (chartsDiv.style.display === 'none') {
                chartsDiv.style.display = 'block';
                // Crear gr√°ficos si no existen
                setTimeout(() => {
                    createStandingsCharts();
                }, 100);
            } else {
                chartsDiv.style.display = 'none';
            }
        }
        
        // Funci√≥n para actualizar indicadores de ordenamiento
        function updateSortIndicators() {
            const sortState = window.currentStandingsSort || { field: null, ascending: true };
            
            // Resetear todos los indicadores
            ['position', 'name', 'pj', 'pg', 'pp', 'pf', 'pc', 'difference', 'points'].forEach(field => {
                const span = document.getElementById(`sort_${field}`);
                if (span) {
                    span.textContent = '‚ÜïÔ∏è';
                }
            });
            
            // Mostrar indicador en el campo ordenado
            if (sortState.field) {
                const span = document.getElementById(`sort_${sortState.field}`);
                if (span) {
                    span.textContent = sortState.ascending ? '‚Üë' : '‚Üì';
                }
            }
        }
        
        // Funci√≥n para buscar en tabla de posiciones
        function searchInStandings(query) {
            if (!window.originalStandings) {
                window.originalStandings = window.currentStandings || [];
            }
            
            const searchTerm = query.toLowerCase().trim();
            
            if (!searchTerm || searchTerm.length === 0) {
                // Sin b√∫squeda, mostrar todos
                window.currentStandings = [...window.originalStandings];
            } else {
                // Filtrar por nombre de equipo
                window.currentStandings = window.originalStandings.filter(team => {
                    const teamName = (team.name || '').toLowerCase();
                    return teamName.includes(searchTerm);
                });
            }
            
            // Re-renderizar tabla
            const responseDiv = document.getElementById('response');
            if (responseDiv && window.currentStandings) {
                responseDiv.innerHTML = renderStandings(window.currentStandings);
            }
        }
        
        // Crear gr√°ficos de tabla de posiciones
        function createStandingsCharts() {
            if (!window.standingsChartData || typeof Chart === 'undefined') return;
            
            const data = window.standingsChartData;
            
            // Gr√°fico de Puntos (Barras)
            const pointsCtx = document.getElementById('pointsChart');
            if (pointsCtx) {
                // Destruir gr√°fico anterior si existe
                if (window.pointsChartInstance) {
                    window.pointsChartInstance.destroy();
                }
                
                window.pointsChartInstance = new Chart(pointsCtx, {
                    type: 'bar',
                    data: {
                        labels: data.top10Names,
                        datasets: [{
                            label: 'Puntos',
                            data: data.top10Points,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Puntos: ' + context.parsed.y;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico de Victorias vs Derrotas
            const winsLossesCtx = document.getElementById('winsLossesChart');
            if (winsLossesCtx) {
                // Destruir gr√°fico anterior si existe
                if (window.winsLossesChartInstance) {
                    window.winsLossesChartInstance.destroy();
                }
                
                window.winsLossesChartInstance = new Chart(winsLossesCtx, {
                    type: 'bar',
                    data: {
                        labels: data.top10Names,
                        datasets: [
                            {
                                label: 'Victorias',
                                data: data.top10Wins,
                                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 2
                            },
                            {
                                label: 'Derrotas',
                                data: data.top10Losses,
                                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Funci√≥n para ordenar tabla de posiciones
        function sortStandings(field) {
            if (!window.currentStandings) return;
            
            const standings = [...window.currentStandings];
            const sortState = window.currentStandingsSort;
            
            // Si se hace clic en el mismo campo, invertir orden
            if (sortState.field === field) {
                sortState.ascending = !sortState.ascending;
            } else {
                sortState.field = field;
                sortState.ascending = true;
            }
            
            standings.sort((a, b) => {
                let aVal, bVal;
                
                switch(field) {
                    case 'position':
                        // Mantener orden original (ya est√° ordenado por puntos)
                        return sortState.ascending ? 0 : 0;
                    case 'name':
                        aVal = a.name || '';
                        bVal = b.name || '';
                        return sortState.ascending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 'pj':
                        aVal = a.pj || 0;
                        bVal = b.pj || 0;
                        break;
                    case 'pg':
                        aVal = a.pg || 0;
                        bVal = b.pg || 0;
                        break;
                    case 'pp':
                        aVal = a.pp || 0;
                        bVal = b.pp || 0;
                        break;
                    case 'pf':
                        aVal = a.pf || 0;
                        bVal = b.pf || 0;
                        break;
                    case 'pc':
                        aVal = a.pc || 0;
                        bVal = b.pc || 0;
                        break;
                    case 'difference':
                        aVal = a.difference || 0;
                        bVal = b.difference || 0;
                        break;
                    case 'points':
                        aVal = a.points || 0;
                        bVal = b.points || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (sortState.ascending) {
                    return bVal - aVal; // Mayor a menor
                } else {
                    return aVal - bVal; // Menor a mayor
                }
            });
            
            // Actualizar standings actuales
            window.currentStandings = standings;
            
            // Re-renderizar tabla
            const responseDiv = document.getElementById('response');
            if (responseDiv) {
                responseDiv.innerHTML = renderStandings(standings);
            }
            
            // Actualizar indicadores de ordenamiento
            setTimeout(updateSortIndicators, 100);
        }
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            // Agregar iconos seg√∫n el tipo
            let icon = '';
            if (type === 'success') icon = '‚úÖ ';
            else if (type === 'error') icon = '‚ùå ';
            else if (type === 'warning') icon = '‚ö†Ô∏è ';
            else icon = '‚ÑπÔ∏è ';
            
            alert.innerHTML = `<strong>${icon}</strong>${message}`;
            alert.style.position = 'fixed';
            alert.style.top = '30px';
            alert.style.right = '30px';
            alert.style.zIndex = '10000';
            alert.style.minWidth = '400px';
            alert.style.maxWidth = '600px';
            alert.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
            alert.style.fontSize = '1.2em';
            alert.style.padding = '25px';
            document.body.appendChild(alert);
            
            // Scroll suave hacia la alerta
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s';
                setTimeout(() => alert.remove(), 500);
            }, 5000); // Mostrar por m√°s tiempo (5 segundos)
        }
        
        // Funci√≥n para mostrar/ocultar men√∫ m√≥vil
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.querySelector('.mobile-menu-overlay');
            
            if (menu && overlay) {
                menu.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }
        
        // Cerrar men√∫ m√≥vil al hacer clic fuera
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('mobileMenu');
            const overlay = document.querySelector('.mobile-menu-overlay');
            const toggle = document.querySelector('.mobile-menu-toggle');
            
            if (menu && overlay && toggle) {
                if (!menu.contains(event.target) && 
                    !toggle.contains(event.target) && 
                    menu.classList.contains('active')) {
                    menu.classList.remove('active');
                    overlay.classList.remove('active');
                }
            }
        });
        
        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('Inicializando aplicaci√≥n...');
                updateForm();
                loadData();
                console.log('Aplicaci√≥n inicializada correctamente');
            } catch (error) {
                console.error('Error al inicializar:', error);
                showAlert('Error al inicializar la aplicaci√≥n: ' + error.message, 'error');
            }
        });
        
        // Tambi√©n ejecutar inmediatamente si el DOM ya est√° listo
        if (document.readyState !== 'loading') {
            // DOM ya est√° listo
            try {
                console.log('üü° DOM ya est√° listo - Inicializando...');
                if (typeof window.updateForm === 'function') {
                    window.updateForm();
                }
                if (typeof window.loadData === 'function') {
                    window.loadData();
                }
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n inmediata:', error);
            }
        }
        
        // Usar event delegation para los botones de pesta√±as
        // Esto es m√°s confiable que onclick inline
        function setupTabListeners() {
            try {
                console.log('üî¥ Configurando event listeners para pesta√±as...');
                
                // Usar event delegation en el contenedor de pesta√±as
                const mainGrid = document.querySelector('.main-grid');
                if (!mainGrid) {
                    console.error('‚ùå No se encontr√≥ .main-grid');
                    setTimeout(setupTabListeners, 500);
                    return;
                }
                
                const gestionCard = mainGrid.querySelector('.card:first-child');
                if (!gestionCard) {
                    console.error('‚ùå No se encontr√≥ el panel de Gesti√≥n');
                    setTimeout(setupTabListeners, 500);
                    return;
                }
                
                const tabsContainer = gestionCard.querySelector('.tabs');
                if (!tabsContainer) {
                    console.error('‚ùå No se encontr√≥ el contenedor de pesta√±as');
                    setTimeout(setupTabListeners, 500);
                    return;
                }
                
                // Agregar event listener usando delegation
                tabsContainer.addEventListener('click', function(e) {
                    const button = e.target.closest('.tab');
                    if (!button) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const tabName = button.getAttribute('data-tab');
                    if (!tabName) {
                        console.error('‚ùå No se encontr√≥ data-tab en el bot√≥n');
                        return;
                    }
                    
                    console.log('üî¥ Click detectado en pesta√±a:', tabName);
                    
                    if (typeof window.switchTab === 'function') {
                        window.switchTab(tabName);
                    } else {
                        console.error('‚ùå window.switchTab no est√° disponible');
                        alert('Error: La funci√≥n switchTab no est√° disponible. Por favor, recargue la p√°gina.');
                    }
                });
                
                console.log('‚úÖ Event listeners configurados correctamente');
            } catch (error) {
                console.error('‚ùå Error configurando event listeners:', error);
                setTimeout(setupTabListeners, 1000);
            }
        }
        
        // Configurar listeners cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupTabListeners);
        } else {
            setupTabListeners();
        }
        
        // Tambi√©n intentar despu√©s de un peque√±o delay por si acaso
        setTimeout(setupTabListeners, 100);
        
        // ============================================
        // B√öSQUEDA GLOBAL
        // ============================================
        
        let globalSearchDebounceTimer = null;
        
        function performGlobalSearch(query) {
            // Debounce: esperar 300ms antes de buscar
            clearTimeout(globalSearchDebounceTimer);
            globalSearchDebounceTimer = setTimeout(() => {
                if (!query || query.trim().length < 2) {
                    hideGlobalSearchResults();
                    return;
                }
                
                const searchTerm = query.toLowerCase().trim();
                const results = [];
                
                // Buscar en campeonatos
                Object.keys(championshipsData).forEach(champId => {
                    const champ = championshipsData[champId];
                    const champName = (champ?.name || champId).toLowerCase();
                    if (champName.includes(searchTerm)) {
                        results.push({
                            type: 'championship',
                            id: champId,
                            name: champ?.name || champId,
                            category: 'Campeonato',
                            action: () => {
                                selectChampionship(champId);
                                switchTab('data');
                                hideGlobalSearchResults();
                            }
                        });
                    }
                });
                
                // Buscar en equipos (en todas las categor√≠as)
                Object.keys(championshipsData).forEach(champId => {
                    const champ = championshipsData[champId];
                    if (champ?.categories) {
                        Object.keys(champ.categories).forEach(catName => {
                            const category = champ.categories[catName];
                            if (category?.teams) {
                                category.teams.forEach(team => {
                                    const teamName = (typeof team === 'string' ? team : team.name || '').toLowerCase();
                                    if (teamName.includes(searchTerm)) {
                                        results.push({
                                            type: 'team',
                                            id: `${champId}_${catName}_${teamName}`,
                                            name: typeof team === 'string' ? team : team.name || '',
                                            category: `${champ?.name || champId} - ${catName}`,
                                            action: () => {
                                                selectChampionship(champId);
                                                selectCategory(champId, catName);
                                                switchTab('manage');
                                                document.getElementById('viewSelect').value = 'standings';
                                                loadView();
                                                hideGlobalSearchResults();
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
                
                // Buscar en partidos (por equipos participantes)
                // Esto requiere cargar fixtures, as√≠ que lo haremos de forma as√≠ncrona
                searchInMatches(searchTerm, results);
                
                // Mostrar resultados
                displayGlobalSearchResults(results);
            }, 300);
        }
        
        async function searchInMatches(searchTerm, results) {
            // Buscar en partidos de todos los campeonatos
            for (const champId of Object.keys(championshipsData)) {
                const champ = championshipsData[champId];
                if (champ?.categories) {
                    for (const catName of Object.keys(champ.categories)) {
                        try {
                            const res = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${encodeURIComponent(catName)}`);
                            if (res.ok) {
                                const data = await res.json();
                                if (data.success && data.matches) {
                                    data.matches.forEach(match => {
                                        const teamA = (match.team_a || '').toLowerCase();
                                        const teamB = (match.team_b || '').toLowerCase();
                                        if (teamA.includes(searchTerm) || teamB.includes(searchTerm)) {
                                            const matchKey = `${champId}_${catName}_${match.round_number}_${match.team_a}_${match.team_b}`;
                                            if (!results.find(r => r.id === matchKey)) {
                                                results.push({
                                                    type: 'match',
                                                    id: matchKey,
                                                    name: `${match.team_a} vs ${match.team_b}`,
                                                    category: `${champ?.name || champId} - ${catName}`,
                                                    action: () => {
                                                        selectChampionship(champId);
                                                        selectCategory(champId, catName);
                                                        switchTab('manage');
                                                        document.getElementById('viewSelect').value = 'fixture';
                                                        loadView();
                                                        hideGlobalSearchResults();
                                                    }
                                                });
                                            }
                                        }
                                    });
                                }
                            }
                        } catch (error) {
                            console.error(`Error buscando partidos en ${champId}/${catName}:`, error);
                        }
                    }
                }
            }
            
            // Actualizar resultados si ya se mostraron
            const searchInput = document.getElementById('globalSearch');
            if (searchInput && searchInput.value.trim().length >= 2) {
                displayGlobalSearchResults(results);
            }
        }
        
        function displayGlobalSearchResults(results) {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (!resultsDiv) return;
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No se encontraron resultados</div>';
                showGlobalSearchResults();
                return;
            }
            
            let html = '<div style="max-height: 400px; overflow-y: auto;">';
            
            // Agrupar por tipo
            const byType = {
                championship: [],
                team: [],
                match: []
            };
            
            results.forEach(result => {
                if (byType[result.type]) {
                    byType[result.type].push(result);
                }
            });
            
            // Mostrar campeonatos
            if (byType.championship.length > 0) {
                html += '<div style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #667eea; border-bottom: 2px solid #667eea;">üèÜ Campeonatos</div>';
                byType.championship.slice(0, 5).forEach(result => {
                    html += `
                        <div onclick="(${result.action.toString()})()" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                             onmouseover="this.style.background='#f0f0f0'"
                             onmouseout="this.style.background='white'">
                            <div style="font-weight: 600; color: #333;">${highlightText(result.name, document.getElementById('globalSearch').value)}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${result.category}</div>
                        </div>
                    `;
                });
            }
            
            // Mostrar equipos
            if (byType.team.length > 0) {
                html += '<div style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #667eea; border-bottom: 2px solid #667eea; margin-top: 10px;">üë• Equipos</div>';
                byType.team.slice(0, 5).forEach(result => {
                    html += `
                        <div onclick="(${result.action.toString()})()" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                             onmouseover="this.style.background='#f0f0f0'"
                             onmouseout="this.style.background='white'">
                            <div style="font-weight: 600; color: #333;">${highlightText(result.name, document.getElementById('globalSearch').value)}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${result.category}</div>
                        </div>
                    `;
                });
            }
            
            // Mostrar partidos
            if (byType.match.length > 0) {
                html += '<div style="padding: 10px; background: #f8f9fa; font-weight: bold; color: #667eea; border-bottom: 2px solid #667eea; margin-top: 10px;">‚öΩ Partidos</div>';
                byType.match.slice(0, 5).forEach(result => {
                    html += `
                        <div onclick="(${result.action.toString()})()" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                             onmouseover="this.style.background='#f0f0f0'"
                             onmouseout="this.style.background='white'">
                            <div style="font-weight: 600; color: #333;">${highlightText(result.name, document.getElementById('globalSearch').value)}</div>
                            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">${result.category}</div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            showGlobalSearchResults();
        }
        
        function highlightText(text, query) {
            if (!query || query.trim().length === 0) return text;
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark style="background: #ffeb3b; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }
        
        function showGlobalSearchResults() {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (resultsDiv) {
                resultsDiv.style.display = 'block';
            }
        }
        
        function hideGlobalSearchResults() {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (resultsDiv) {
                resultsDiv.style.display = 'none';
            }
        }
        
        // Atajo de teclado Ctrl/Cmd + K para b√∫squeda
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('globalSearch');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }
            
            // Esc para cerrar resultados
            if (e.key === 'Escape') {
                hideGlobalSearchResults();
                const searchInput = document.getElementById('globalSearch');
                if (searchInput && document.activeElement === searchInput) {
                    searchInput.blur();
                }
            }
        });
        
        // Hacer funciones globales
        window.performGlobalSearch = performGlobalSearch;
        window.showGlobalSearchResults = showGlobalSearchResults;
        window.hideGlobalSearchResults = hideGlobalSearchResults;
        window.searchInStandings = searchInStandings;
        window.updateSortIndicators = updateSortIndicators;
        
        // ============================================
        // VISTA DE CALENDARIO
        // ============================================
        
        function renderCalendarView(matches, categoryName) {
            if (!matches || matches.length === 0) {
                return '<div class="empty-state">No hay partidos en el calendario</div>';
            }
            
            // Agrupar partidos por fecha
            const matchesByDate = {};
            matches.forEach(match => {
                const date = match.date || 'Sin fecha';
                if (!matchesByDate[date]) {
                    matchesByDate[date] = [];
                }
                matchesByDate[date].push(match);
            });
            
            // Obtener mes actual
            const now = new Date();
            let currentMonth = now.getMonth();
            let currentYear = now.getFullYear();
            
            // Intentar obtener mes desde localStorage
            const savedMonth = localStorage.getItem('calendarMonth');
            const savedYear = localStorage.getItem('calendarYear');
            if (savedMonth !== null && savedYear !== null) {
                currentMonth = parseInt(savedMonth);
                currentYear = parseInt(savedYear);
            }
            
            // Generar calendario mensual
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            
            let html = `
                <div class="calendar-container" style="padding: 25px; font-size: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="color: #667eea; margin: 0; font-size: 2em; font-weight: 700;">üìÜ Calendario - ${categoryName}</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button onclick="changeCalendarMonth(-1)" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ‚Üê Anterior
                            </button>
                            <span style="font-size: 1.3em; font-weight: 700; color: #667eea; min-width: 200px; text-align: center;">
                                ${monthNames[currentMonth]} ${currentYear}
                            </span>
                            <button onclick="changeCalendarMonth(1)" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Siguiente ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #28a745; border-radius: 4px;"></div>
                                <span>Partido jugado</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #007bff; border-radius: 4px;"></div>
                                <span>Partido programado</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 20px; height: 20px; background: #dc3545; border-radius: 4px;"></div>
                                <span>Sin fecha</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            `;
            
            // Encabezados de d√≠as
            dayNames.forEach(day => {
                html += `<div style="text-align: center; font-weight: 700; color: #667eea; padding: 10px; background: #f0f0f0; border-radius: 6px;">${day}</div>`;
            });
            
            // D√≠as vac√≠os al inicio
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += `<div style="min-height: 100px; border: 1px solid #e0e0e0; border-radius: 6px; background: #f8f9fa;"></div>`;
            }
            
            // D√≠as del mes
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayMatches = matchesByDate[dateStr] || [];
                const isToday = currentYear === now.getFullYear() && currentMonth === now.getMonth() && day === now.getDate();
                
                let dayStyle = 'min-height: 100px; border: 2px solid #e0e0e0; border-radius: 6px; padding: 8px; background: white; cursor: pointer; transition: all 0.2s;';
                
                if (dayMatches.length > 0) {
                    const hasPlayed = dayMatches.some(m => m.played);
                    const hasScheduled = dayMatches.some(m => m.date && !m.played);
                    const hasUnscheduled = dayMatches.some(m => !m.date);
                    
                    if (hasPlayed) {
                        dayStyle += ' background: #d4edda; border-color: #28a745;';
                    } else if (hasScheduled) {
                        dayStyle += ' background: #d1ecf1; border-color: #007bff;';
                    } else if (hasUnscheduled) {
                        dayStyle += ' background: #f8d7da; border-color: #dc3545;';
                    }
                }
                
                if (isToday) {
                    dayStyle += ' border: 3px solid #ffc107; box-shadow: 0 0 10px rgba(255, 193, 7, 0.5);';
                }
                
                const matchesJson = JSON.stringify(dayMatches).replace(/"/g, '&quot;');
                html += `
                    <div onclick="showDayMatches('${dateStr}', ${matchesJson})" 
                         style="${dayStyle}"
                         onmouseover="this.style.transform='scale(1.05)'; this.style.zIndex='10';"
                         onmouseout="this.style.transform='scale(1)'; this.style.zIndex='1';">
                        <div style="font-weight: 700; color: ${isToday ? '#ffc107' : '#333'}; margin-bottom: 5px; font-size: 1.1em;">${day}</div>
                        ${dayMatches.length > 0 ? `<div style="font-size: 0.85em; color: #666;">${dayMatches.length} partido${dayMatches.length > 1 ? 's' : ''}</div>` : ''}
                    </div>
                `;
            }
            
            // D√≠as vac√≠os al final
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    html += `<div style="min-height: 100px; border: 1px solid #e0e0e0; border-radius: 6px; background: #f8f9fa;"></div>`;
                }
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Guardar mes actual
            window.calendarCurrentMonth = currentMonth;
            window.calendarCurrentYear = currentYear;
            
            return html;
        }
        
        function changeCalendarMonth(delta) {
            const currentMonth = window.calendarCurrentMonth !== undefined ? window.calendarCurrentMonth : new Date().getMonth();
            const currentYear = window.calendarCurrentYear !== undefined ? window.calendarCurrentYear : new Date().getFullYear();
            
            let newMonth = currentMonth + delta;
            let newYear = currentYear;
            
            if (newMonth < 0) {
                newMonth = 11;
                newYear--;
            } else if (newMonth > 11) {
                newMonth = 0;
                newYear++;
            }
            
            // Guardar en localStorage
            localStorage.setItem('calendarMonth', newMonth);
            localStorage.setItem('calendarYear', newYear);
            
            // Recargar vista de calendario
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (champId && category) {
                loadViewData();
            }
        }
        
        function showDayMatches(date, matches) {
            if (!matches || matches.length === 0) {
                showAlert('No hay partidos programados para esta fecha', 'info');
                return;
            }
            
            const dateObj = new Date(date + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            let html = `
                <div style="padding: 20px;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìÖ Partidos del ${dateStr}</h3>
                    <div style="display: grid; gap: 15px;">
            `;
            
            matches.forEach((match) => {
                const played = match.played;
                const scoreA = match.score_a !== null ? match.score_a : '-';
                const scoreB = match.score_b !== null ? match.score_b : '-';
                const time = match.time || 'Sin horario';
                const status = played ? 'Jugado' : 'Programado';
                const statusColor = played ? '#28a745' : '#007bff';
                
                html += `
                    <div style="padding: 15px; background: ${played ? '#d4edda' : '#d1ecf1'}; border-left: 4px solid ${statusColor}; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 5px;">
                                    ${match.team_a} <span style="color: ${statusColor};">${scoreA}</span> - 
                                    <span style="color: ${statusColor};">${scoreB}</span> ${match.team_b}
                                </div>
                                <div style="font-size: 0.9em; color: #666;">
                                    üïê ${time} | ${status}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            // Mostrar en modal
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    ${html}
                </div>
            `;
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function renderCalendarWeekView(matches, categoryName) {
            if (!matches || matches.length === 0) {
                return '<div class="empty-state">No hay partidos en el calendario</div>';
            }
            
            // Obtener semana actual
            const now = new Date();
            let currentWeekStart = new Date(now);
            currentWeekStart.setDate(now.getDate() - now.getDay()); // Domingo de la semana
            currentWeekStart.setHours(0, 0, 0, 0);
            
            // Intentar obtener semana desde localStorage
            const savedWeek = localStorage.getItem('calendarWeekStart');
            if (savedWeek) {
                currentWeekStart = new Date(savedWeek);
            }
            
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(currentWeekStart.getDate() + 6);
            weekEnd.setHours(23, 59, 59, 999);
            
            // Agrupar partidos por d√≠a de la semana
            const matchesByDay = {};
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentWeekStart);
                day.setDate(currentWeekStart.getDate() + i);
                const dateStr = day.toISOString().split('T')[0];
                matchesByDay[dateStr] = matches.filter(m => {
                    if (!m.date) return false;
                    return m.date === dateStr;
                });
            }
            
            let html = `
                <div class="calendar-week-container" style="padding: 25px; font-size: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;">
                        <h3 style="color: #667eea; margin: 0; font-size: 2em; font-weight: 700;">üìÖ Calendario Semanal - ${categoryName}</h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button onclick="changeCalendarWeek(-1)" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ‚Üê Semana Anterior
                            </button>
                            <span style="font-size: 1.1em; font-weight: 700; color: #667eea; min-width: 250px; text-align: center;">
                                ${currentWeekStart.toLocaleDateString('es-ES', { day: 'numeric', month: 'long' })} - ${weekEnd.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}
                            </span>
                            <button onclick="changeCalendarWeek(1)" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Semana Siguiente ‚Üí
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
            `;
            
            // Mostrar cada d√≠a de la semana
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentWeekStart);
                day.setDate(currentWeekStart.getDate() + i);
                const dateStr = day.toISOString().split('T')[0];
                const dayMatches = matchesByDay[dateStr] || [];
                const isToday = dateStr === now.toISOString().split('T')[0];
                
                html += `
                    <div style="background: ${isToday ? '#fff3cd' : 'white'}; border: 2px solid ${isToday ? '#ffc107' : '#e0e0e0'}; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="font-weight: 700; font-size: 1.3em; color: #667eea; margin-bottom: 15px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">
                            ${dayNames[day.getDay()]} ${day.getDate()}/${day.getMonth() + 1}
                        </div>
                        <div style="min-height: 200px;">
                `;
                
                if (dayMatches.length === 0) {
                    html += '<div style="text-align: center; color: #999; padding: 20px;">No hay partidos programados</div>';
                } else {
                    dayMatches.forEach(match => {
                        const played = match.played;
                        const scoreA = match.score_a !== null ? match.score_a : '-';
                        const scoreB = match.score_b !== null ? match.score_b : '-';
                        const time = match.time || 'Sin horario';
                        const statusColor = played ? '#28a745' : '#007bff';
                        
                        html += `
                            <div style="padding: 12px; background: ${played ? '#d4edda' : '#d1ecf1'}; border-left: 4px solid ${statusColor}; border-radius: 8px; margin-bottom: 10px;">
                                <div style="font-weight: 600; margin-bottom: 5px;">
                                    ${match.team_a} <span style="color: ${statusColor};">${scoreA}</span> - 
                                    <span style="color: ${statusColor};">${scoreB}</span> ${match.team_b}
                                </div>
                                <div style="font-size: 0.85em; color: #666;">
                                    üïê ${time}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
            
            // Guardar semana actual
            window.calendarWeekStart = currentWeekStart;
            
            return html;
        }
        
        function changeCalendarWeek(delta) {
            const currentWeekStart = window.calendarWeekStart || new Date();
            const newWeekStart = new Date(currentWeekStart);
            newWeekStart.setDate(currentWeekStart.getDate() + (delta * 7));
            
            // Guardar en localStorage
            localStorage.setItem('calendarWeekStart', newWeekStart.toISOString());
            
            // Recargar vista de calendario semanal
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (champId && category) {
                loadViewData();
            }
        }
        
        function generateICSFile(matches, championshipName, categoryName) {
            if (!matches || matches.length === 0) {
                showAlert('No hay partidos para exportar', 'warning');
                return null;
            }
            
            let icsContent = 'BEGIN:VCALENDAR\r\n';
            icsContent += 'VERSION:2.0\r\n';
            icsContent += 'PRODID:-//ABALA//Campeonato de Basquetbol//ES\r\n';
            icsContent += 'CALSCALE:GREGORIAN\r\n';
            icsContent += 'METHOD:PUBLISH\r\n';
            
            matches.forEach((match, index) => {
                if (!match.date) return; // Saltar partidos sin fecha
                
                const dateStr = match.date; // Formato YYYY-MM-DD
                const timeStr = match.time || '18:00'; // Hora por defecto
                const [hours, minutes] = timeStr.split(':');
                
                // Crear fecha de inicio
                const startDate = new Date(`${dateStr}T${hours}:${minutes}:00`);
                const endDate = new Date(startDate);
                endDate.setHours(endDate.getHours() + 2); // Duraci√≥n de 2 horas
                
                // Formato iCal: YYYYMMDDTHHMMSS
                const formatDate = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const min = String(date.getMinutes()).padStart(2, '0');
                    const sec = String(date.getSeconds()).padStart(2, '0');
                    return `${year}${month}${day}T${hour}${min}${sec}`;
                };
                
                const dtStart = formatDate(startDate);
                const dtEnd = formatDate(endDate);
                const dtStamp = formatDate(new Date());
                
                // T√≠tulo del evento
                const summary = `${match.team_a} vs ${match.team_b}`;
                const description = `Partido de ${categoryName} - ${championshipName}`;
                
                // Estado del partido
                let status = 'CONFIRMED';
                if (match.played) {
                    status = 'COMPLETED';
                }
                
                icsContent += 'BEGIN:VEVENT\r\n';
                icsContent += `UID:abala-${match.team_a}-${match.team_b}-${match.round_number || index}@abala.local\r\n`;
                icsContent += `DTSTAMP:${dtStamp}\r\n`;
                icsContent += `DTSTART:${dtStart}\r\n`;
                icsContent += `DTEND:${dtEnd}\r\n`;
                icsContent += `SUMMARY:${summary}\r\n`;
                icsContent += `DESCRIPTION:${description}\r\n`;
                icsContent += `STATUS:${status}\r\n`;
                if (match.played && match.score_a !== null && match.score_b !== null) {
                    icsContent += `COMMENT:Resultado: ${match.team_a} ${match.score_a} - ${match.score_b} ${match.team_b}\r\n`;
                }
                icsContent += 'END:VEVENT\r\n';
            });
            
            icsContent += 'END:VCALENDAR\r\n';
            
            return icsContent;
        }
        
        function exportToICal() {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a', 'error');
                return;
            }
            
            if (!window.originalMatches || window.originalMatches.length === 0) {
                showAlert('No hay partidos para exportar', 'warning');
                return;
            }
            
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            const icsContent = generateICSFile(window.originalMatches, champName, category);
            
            if (!icsContent) return;
            
            // Crear blob y descargar
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Fixture_${category}_${champId}_${new Date().toISOString().split('T')[0]}.ics`;
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('‚úÖ Calendario exportado exitosamente. Puedes importarlo en Google Calendar, Outlook o Apple Calendar.', 'success');
        }
        
        // Hacer funciones globales
        window.renderCalendarView = renderCalendarView;
        window.renderCalendarWeekView = renderCalendarWeekView;
        window.changeCalendarMonth = changeCalendarMonth;
        window.changeCalendarWeek = changeCalendarWeek;
        window.showDayMatches = showDayMatches;
        window.exportToICal = exportToICal;
        window.generateICSFile = generateICSFile;
        
        // ============================================
        // EXPORTACI√ìN A WHATSAPP (IM√ÅGENES)
        // ============================================
        
        async function exportStandingsToImage() {
            if (typeof html2canvas === 'undefined') {
                showAlert('La librer√≠a html2canvas no est√° cargada. Por favor, recarga la p√°gina.', 'error');
                return;
            }
            
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Buscar el contenedor de la tabla de posiciones
            const responseDiv = document.getElementById('response');
            if (!responseDiv) {
                showAlert('No se encontr√≥ la tabla de posiciones. Por favor, carga la tabla primero.', 'error');
                return;
            }
            
            // Crear un contenedor temporal para la exportaci√≥n
            const exportContainer = document.createElement('div');
            exportContainer.style.position = 'absolute';
            exportContainer.style.left = '-9999px';
            exportContainer.style.width = '1400px';
            exportContainer.style.background = 'white';
            exportContainer.style.padding = '40px';
            exportContainer.style.fontFamily = 'Arial, sans-serif';
            
            // Agregar encabezado
            const header = document.createElement('div');
            header.style.marginBottom = '30px';
            header.style.borderBottom = '3px solid #667eea';
            header.style.paddingBottom = '20px';
            header.innerHTML = `
                <h1 style="color: #667eea; margin: 0 0 10px 0; font-size: 2.5em; font-weight: 700;">${champName}</h1>
                <h2 style="color: #333; margin: 0 0 10px 0; font-size: 1.8em; font-weight: 600;">Tabla de Posiciones - ${category}</h2>
                <p style="color: #666; margin: 0; font-size: 1.1em;">Fecha: ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
            `;
            exportContainer.appendChild(header);
            
            // Clonar la tabla de posiciones
            const standingsTable = responseDiv.querySelector('table');
            if (!standingsTable) {
                showAlert('No se encontr√≥ la tabla de posiciones. Por favor, carga la tabla primero.', 'error');
                return;
            }
            
            const clonedTable = standingsTable.cloneNode(true);
            clonedTable.style.width = '100%';
            clonedTable.style.fontSize = '1.2em';
            exportContainer.appendChild(clonedTable);
            
            document.body.appendChild(exportContainer);
            
            try {
                showAlert('‚è≥ Generando imagen...', 'info');
                
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    width: 1400,
                    useCORS: true,
                    allowTaint: true
                });
                
                // Convertir a blob y descargar
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showAlert('Error al generar la imagen', 'error');
                        return;
                    }
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const dateStr = new Date().toISOString().split('T')[0];
                    link.download = `Tabla_Posiciones_${category}_${dateStr}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showAlert('‚úÖ Imagen exportada exitosamente. Lista para compartir en WhatsApp!', 'success');
                }, 'image/png', 0.95);
                
            } catch (error) {
                console.error('Error exportando imagen:', error);
                showAlert('Error al generar la imagen: ' + error.message, 'error');
            } finally {
                document.body.removeChild(exportContainer);
            }
        }
        
        async function exportCalendarToImage() {
            if (typeof html2canvas === 'undefined') {
                showAlert('La librer√≠a html2canvas no est√° cargada. Por favor, recarga la p√°gina.', 'error');
                return;
            }
            
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Buscar el contenedor del calendario
            const responseDiv = document.getElementById('response');
            if (!responseDiv) {
                showAlert('No se encontr√≥ el calendario. Por favor, carga el calendario primero.', 'error');
                return;
            }
            
            const calendarContainer = responseDiv.querySelector('.calendar-container') || responseDiv.querySelector('.calendar-week-container');
            if (!calendarContainer) {
                showAlert('No se encontr√≥ el calendario. Por favor, carga la vista de calendario primero.', 'error');
                return;
            }
            
            // Crear un contenedor temporal para la exportaci√≥n
            const exportContainer = document.createElement('div');
            exportContainer.style.position = 'absolute';
            exportContainer.style.left = '-9999px';
            exportContainer.style.width = '1400px';
            exportContainer.style.background = 'white';
            exportContainer.style.padding = '40px';
            exportContainer.style.fontFamily = 'Arial, sans-serif';
            
            // Agregar encabezado
            const header = document.createElement('div');
            header.style.marginBottom = '30px';
            header.style.borderBottom = '3px solid #667eea';
            header.style.paddingBottom = '20px';
            header.innerHTML = `
                <h1 style="color: #667eea; margin: 0 0 10px 0; font-size: 2.5em; font-weight: 700;">${champName}</h1>
                <h2 style="color: #333; margin: 0 0 10px 0; font-size: 1.8em; font-weight: 600;">Calendario de Partidos - ${category}</h2>
                <p style="color: #666; margin: 0; font-size: 1.1em;">Fecha: ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
            `;
            exportContainer.appendChild(header);
            
            // Clonar el calendario
            const clonedCalendar = calendarContainer.cloneNode(true);
            clonedCalendar.style.width = '100%';
            exportContainer.appendChild(clonedCalendar);
            
            document.body.appendChild(exportContainer);
            
            try {
                showAlert('‚è≥ Generando imagen del calendario...', 'info');
                
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    width: 1400,
                    useCORS: true,
                    allowTaint: true
                });
                
                // Convertir a blob y descargar
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showAlert('Error al generar la imagen', 'error');
                        return;
                    }
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const dateStr = new Date().toISOString().split('T')[0];
                    link.download = `Calendario_${category}_${dateStr}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showAlert('‚úÖ Imagen del calendario exportada exitosamente. Lista para compartir en WhatsApp!', 'success');
                }, 'image/png', 0.95);
                
            } catch (error) {
                console.error('Error exportando imagen:', error);
                showAlert('Error al generar la imagen: ' + error.message, 'error');
            } finally {
                document.body.removeChild(exportContainer);
            }
        }
        
        async function exportBothToImage() {
            if (typeof html2canvas === 'undefined') {
                showAlert('La librer√≠a html2canvas no est√° cargada. Por favor, recarga la p√°gina.', 'error');
                return;
            }
            
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Verificar que ambos est√©n disponibles
            const responseDiv = document.getElementById('response');
            if (!responseDiv) {
                showAlert('No se encontr√≥ la informaci√≥n. Por favor, carga primero la tabla y el calendario.', 'error');
                return;
            }
            
            // Buscar tabla de posiciones
            let standingsTable = responseDiv.querySelector('table');
            
            // Si no hay tabla visible, intentar cargarla
            if (!standingsTable) {
                showAlert('Cargando tabla de posiciones...', 'info');
                const viewSelect = document.getElementById('viewSelect');
                if (viewSelect) {
                    const originalView = viewSelect.value;
                    viewSelect.value = 'standings';
                    await loadViewData();
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    standingsTable = responseDiv.querySelector('table');
                    viewSelect.value = originalView;
                    if (originalView !== 'standings') {
                        await loadViewData();
                    }
                }
            }
            
            if (!standingsTable) {
                showAlert('No se pudo cargar la tabla de posiciones. Por favor, aseg√∫rate de tener un campeonato y categor√≠a seleccionados.', 'error');
                return;
            }
            
            // Buscar fixture/calendario (puede estar en diferentes vistas)
            let calendarContainer = responseDiv.querySelector('.fixture-container') || 
                                   responseDiv.querySelector('.calendar-container') || 
                                   responseDiv.querySelector('.calendar-week-container');
            
            // Si no est√° visible, intentar cargar el fixture
            if (!calendarContainer) {
                showAlert('Cargando fixture...', 'info');
                const viewSelect = document.getElementById('viewSelect');
                if (viewSelect) {
                    const originalView = viewSelect.value;
                    // Intentar cargar fixture primero
                    viewSelect.value = 'fixture';
                    await loadViewData();
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    // Buscar de nuevo
                    calendarContainer = responseDiv.querySelector('.fixture-container') || 
                                      responseDiv.querySelector('.calendar-container') || 
                                      responseDiv.querySelector('.calendar-week-container');
                    
                    // Restaurar vista original
                    viewSelect.value = originalView;
                    if (originalView !== 'fixture') {
                        await loadViewData();
                    }
                }
            }
            
            if (!calendarContainer) {
                showAlert('No se pudo cargar el fixture. Por favor, aseg√∫rate de tener un campeonato y categor√≠a seleccionados.', 'error');
                return;
            }
            
            // Crear un contenedor temporal para la exportaci√≥n combinada
            const exportContainer = document.createElement('div');
            exportContainer.style.position = 'absolute';
            exportContainer.style.left = '-9999px';
            exportContainer.style.width = '1400px';
            exportContainer.style.background = 'white';
            exportContainer.style.padding = '40px';
            exportContainer.style.fontFamily = 'Arial, sans-serif';
            
            // Agregar encabezado
            const header = document.createElement('div');
            header.style.marginBottom = '30px';
            header.style.borderBottom = '3px solid #667eea';
            header.style.paddingBottom = '20px';
            header.innerHTML = `
                <h1 style="color: #667eea; margin: 0 0 10px 0; font-size: 2.5em; font-weight: 700;">${champName}</h1>
                <h2 style="color: #333; margin: 0 0 10px 0; font-size: 1.8em; font-weight: 600;">${category}</h2>
                <p style="color: #666; margin: 0; font-size: 1.1em;">Fecha: ${new Date().toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
            `;
            exportContainer.appendChild(header);
            
            // Agregar tabla de posiciones
            const standingsSection = document.createElement('div');
            standingsSection.style.marginBottom = '50px';
            const standingsTitle = document.createElement('h2');
            standingsTitle.style.color = '#667eea';
            standingsTitle.style.marginBottom = '20px';
            standingsTitle.style.fontSize = '2em';
            standingsTitle.textContent = 'üìä Tabla de Posiciones';
            standingsSection.appendChild(standingsTitle);
            
            const clonedTable = standingsTable.cloneNode(true);
            clonedTable.style.width = '100%';
            clonedTable.style.fontSize = '1.2em';
            clonedTable.style.marginBottom = '30px';
            standingsSection.appendChild(clonedTable);
            exportContainer.appendChild(standingsSection);
            
            // Agregar calendario
            const calendarSection = document.createElement('div');
            const calendarTitle = document.createElement('h2');
            calendarTitle.style.color = '#667eea';
            calendarTitle.style.marginBottom = '20px';
            calendarTitle.style.fontSize = '2em';
            calendarTitle.textContent = 'üìÖ Calendario de Partidos';
            calendarSection.appendChild(calendarTitle);
            
            const clonedCalendar = calendarContainer.cloneNode(true);
            clonedCalendar.style.width = '100%';
            calendarSection.appendChild(clonedCalendar);
            exportContainer.appendChild(calendarSection);
            
            document.body.appendChild(exportContainer);
            
            try {
                showAlert('‚è≥ Generando imagen combinada...', 'info');
                
                const canvas = await html2canvas(exportContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    logging: false,
                    width: 1400,
                    useCORS: true,
                    allowTaint: true,
                    height: exportContainer.scrollHeight
                });
                
                // Convertir a blob y descargar
                canvas.toBlob((blob) => {
                    if (!blob) {
                        showAlert('Error al generar la imagen', 'error');
                        return;
                    }
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    const dateStr = new Date().toISOString().split('T')[0];
                    link.download = `Campeonato_${champName.replace(/\s+/g, '_')}_${category}_${dateStr}.png`;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    showAlert('‚úÖ Imagen combinada exportada exitosamente. Lista para compartir en WhatsApp!', 'success');
                }, 'image/png', 0.95);
                
            } catch (error) {
                console.error('Error exportando imagen:', error);
                showAlert('Error al generar la imagen: ' + error.message, 'error');
            } finally {
                document.body.removeChild(exportContainer);
            }
        }
        
        // Hacer funciones globales
        window.exportStandingsToImage = exportStandingsToImage;
        window.exportCalendarToImage = exportCalendarToImage;
        window.exportBothToImage = exportBothToImage;
        
        // Asegurar que el bot√≥n ultra visible tenga acceso a la funci√≥n
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                const ultraVisibleButton = document.getElementById('ultraVisibleExportButton');
                if (ultraVisibleButton) {
                    console.log('‚úÖ Bot√≥n ultra visible encontrado y configurado');
                    ultraVisibleButton.onclick = function() {
                        console.log('üî¥ CLICK EN BOT√ìN EXPORTAR (ULTRA VISIBLE)');
                        if (typeof window.exportBothToImage === 'function') {
                            window.exportBothToImage();
                        } else if (typeof exportBothToImage === 'function') {
                            exportBothToImage();
                        } else {
                            alert('Error: La funci√≥n exportBothToImage no est√° disponible. Por favor, recarga la p√°gina.');
                            console.error('exportBothToImage no disponible');
                        }
                    };
                } else {
                    console.error('‚ùå Bot√≥n ultra visible NO encontrado');
                }
            });
        } else {
            // DOM ya est√° cargado
            setTimeout(function() {
                const ultraVisibleButton = document.getElementById('ultraVisibleExportButton');
                if (ultraVisibleButton) {
                    console.log('‚úÖ Bot√≥n ultra visible encontrado y configurado (DOM ya cargado)');
                    ultraVisibleButton.onclick = function() {
                        console.log('üî¥ CLICK EN BOT√ìN EXPORTAR (ULTRA VISIBLE)');
                        if (typeof window.exportBothToImage === 'function') {
                            window.exportBothToImage();
                        } else if (typeof exportBothToImage === 'function') {
                            exportBothToImage();
                        } else {
                            alert('Error: La funci√≥n exportBothToImage no est√° disponible. Por favor, recarga la p√°gina.');
                            console.error('exportBothToImage no disponible');
                        }
                    };
                } else {
                    console.error('‚ùå Bot√≥n ultra visible NO encontrado (DOM ya cargado)');
                }
            }, 100);
        }
        
        // ============================================
        // GR√ÅFICOS AVANZADOS
        // ============================================
        
        async function showPointsEvolutionChart() {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a', 'error');
                return;
            }
            
            const modal = document.getElementById('evolutionChartModal');
            const container = document.getElementById('evolutionChartContainer');
            
            if (!modal || !container) {
                // Crear modal si no existe
                const newModal = document.createElement('div');
                newModal.id = 'evolutionChartModal';
                newModal.className = 'modal';
                newModal.style.display = 'block';
                newModal.innerHTML = `
                    <div class="modal-content" style="max-width: 900px;">
                        <span class="close" onclick="document.getElementById('evolutionChartModal').style.display='none'">&times;</span>
                        <h2 style="color: #667eea; margin-bottom: 20px;">üìä Evoluci√≥n de Puntos por Equipo</h2>
                        <div id="evolutionChartContainer" style="padding: 20px;">
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div>
                                <div style="font-size: 1.2em;">Cargando gr√°fico...</div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(newModal);
                newModal.addEventListener('click', (e) => {
                    if (e.target === newModal) {
                        newModal.remove();
                    }
                });
                return showPointsEvolutionChart();
            }
            
            modal.style.display = 'block';
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div><div style="font-size: 1.2em;">Cargando gr√°fico...</div></div>';
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}/standings/${encodeURIComponent(category)}/evolution`);
                const data = await res.json();
                
                if (!data.success || !data.evolution) {
                    container.innerHTML = '<div class="alert alert-error">Error al cargar la evoluci√≥n de puntos</div>';
                    return;
                }
                
                renderPointsEvolutionChart(data.evolution, container);
            } catch (error) {
                console.error('Error cargando evoluci√≥n:', error);
                container.innerHTML = '<div class="alert alert-error">Error de conexi√≥n al cargar la evoluci√≥n</div>';
            }
        }
        
        function renderPointsEvolutionChart(evolution, container) {
            if (typeof Chart === 'undefined') {
                container.innerHTML = '<div class="alert alert-error">Chart.js no est√° cargado. Por favor, recarga la p√°gina.</div>';
                return;
            }
            
            const teams = Object.keys(evolution);
            if (teams.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No hay datos de evoluci√≥n disponibles</div>';
                return;
            }
            
            const allRounds = new Set();
            teams.forEach(team => {
                evolution[team].forEach(point => {
                    allRounds.add(point.round);
                });
            });
            const rounds = Array.from(allRounds).sort((a, b) => a - b);
            
            const colors = [
                'rgba(102, 126, 234, 1)', 'rgba(40, 167, 69, 1)', 'rgba(220, 53, 69, 1)', 'rgba(255, 193, 7, 1)',
                'rgba(23, 162, 184, 1)', 'rgba(108, 117, 125, 1)', 'rgba(255, 87, 34, 1)', 'rgba(156, 39, 176, 1)',
            ];
            
            const datasets = teams.map((team, index) => {
                const teamData = evolution[team];
                let lastValue = 0;
                const interpolatedPoints = rounds.map(round => {
                    const point = teamData.find(p => p.round === round);
                    if (point !== null && point !== undefined) {
                        lastValue = point.points;
                        return point.points;
                    }
                    return lastValue;
                });
                
                return {
                    label: team,
                    data: interpolatedPoints,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length].replace('1)', '0.1)'),
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4
                };
            });
            
            container.innerHTML = '<canvas id="evolutionChart" style="max-height: 500px;"></canvas>';
            
            setTimeout(() => {
                const ctx = document.getElementById('evolutionChart');
                if (ctx) {
                    if (window.evolutionChartInstance) {
                        window.evolutionChartInstance.destroy();
                    }
                    
                    window.evolutionChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: rounds.map(r => `Jornada ${r}`),
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { position: 'top', labels: { boxWidth: 12, padding: 10 } },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Puntos' } },
                                x: { title: { display: true, text: 'Jornada' } }
                            },
                            interaction: { mode: 'nearest', axis: 'x', intersect: false }
                        }
                    });
                }
            }, 100);
        }
        
        function showTeamComparison() {
            const checkboxes = document.querySelectorAll('.team-compare-checkbox:checked');
            const selectedTeams = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedTeams.length < 2) {
                showAlert('Selecciona al menos 2 equipos para comparar', 'warning');
                return;
            }
            
            if (selectedTeams.length > 4) {
                showAlert('M√°ximo 4 equipos para comparar', 'warning');
                return;
            }
            
            const standings = window.currentStandings || [];
            const teamsData = selectedTeams.map(teamName => standings.find(t => t.name === teamName)).filter(t => t !== undefined);
            
            if (teamsData.length === 0) {
                showAlert('No se encontraron datos de los equipos seleccionados', 'error');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    <h2 style="color: #667eea; margin-bottom: 20px;">üìä Comparativa de Equipos</h2>
                    <div id="comparisonChartContainer" style="padding: 20px;">
                        <canvas id="comparisonChart" style="max-height: 500px;"></canvas>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            setTimeout(() => {
                renderTeamComparisonChart(teamsData);
            }, 100);
        }
        
        function renderTeamComparisonChart(teamsData) {
            if (typeof Chart === 'undefined') {
                const container = document.getElementById('comparisonChartContainer');
                if (container) {
                    container.innerHTML = '<div class="alert alert-error">Chart.js no est√° cargado. Por favor, recarga la p√°gina.</div>';
                }
                return;
            }
            
            const ctx = document.getElementById('comparisonChart');
            if (!ctx) return;
            
            if (window.comparisonChartInstance) {
                window.comparisonChartInstance.destroy();
            }
            
            const teamNames = teamsData.map(t => t.name);
            const metrics = ['PJ', 'PG', 'PP', 'PF', 'PC', 'Puntos'];
            const metricKeys = ['pj', 'pg', 'pp', 'pf', 'pc', 'points'];
            
            const datasets = teamNames.map((teamName, index) => {
                const team = teamsData.find(t => t.name === teamName);
                const colors = ['rgba(102, 126, 234, 0.8)', 'rgba(40, 167, 69, 0.8)', 'rgba(220, 53, 69, 0.8)', 'rgba(255, 193, 7, 0.8)'];
                return {
                    label: teamName,
                    data: metricKeys.map(key => team[key] || 0),
                    backgroundColor: colors[index % colors.length],
                    borderColor: colors[index % colors.length].replace('0.8', '1'),
                    borderWidth: 2
                };
            });
            
            window.comparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: metrics, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Valor' } },
                        x: { title: { display: true, text: 'M√©trica' } }
                    }
                }
            });
        }
        
        async function showHeatmapChart() {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${encodeURIComponent(category)}`);
                const data = await res.json();
                
                if (!data.success || !data.matches) {
                    showAlert('Error al cargar partidos para el heatmap', 'error');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 1000px;">
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                        <h2 style="color: #667eea; margin-bottom: 20px;">üî• Heatmap de Densidad de Partidos</h2>
                        <div id="heatmapChartContainer" style="padding: 20px;">
                            <canvas id="heatmapChart" style="max-height: 600px;"></canvas>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                setTimeout(() => {
                    renderHeatmapChart(data.matches);
                }, 100);
            } catch (error) {
                console.error('Error cargando heatmap:', error);
                showAlert('Error de conexi√≥n al cargar el heatmap', 'error');
            }
        }
        
        function renderHeatmapChart(matches) {
            if (typeof Chart === 'undefined') {
                const container = document.getElementById('heatmapChartContainer');
                if (container) {
                    container.innerHTML = '<div class="alert alert-error">Chart.js no est√° cargado. Por favor, recarga la p√°gina.</div>';
                }
                return;
            }
            
            const ctx = document.getElementById('heatmapChart');
            if (!ctx) return;
            
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const heatmapData = [];
            const weekLabels = [];
            const matchesByWeek = {};
            
            matches.forEach(match => {
                if (!match.date) return;
                
                const date = new Date(match.date + 'T00:00:00');
                const dayOfWeek = date.getDay();
                let week = 1;
                
                if (match.roundNumber) {
                    week = Math.ceil(match.roundNumber / 2) || 1;
                } else {
                    const firstMatch = matches.find(m => m.date);
                    if (firstMatch) {
                        const firstDate = new Date(firstMatch.date + 'T00:00:00');
                        const diffTime = date.getTime() - firstDate.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        week = Math.ceil(diffDays / 7) || 1;
                    }
                }
                
                if (!matchesByWeek[week]) {
                    matchesByWeek[week] = {};
                }
                if (!matchesByWeek[week][dayOfWeek]) {
                    matchesByWeek[week][dayOfWeek] = 0;
                }
                matchesByWeek[week][dayOfWeek]++;
            });
            
            const weeks = Object.keys(matchesByWeek).map(Number).sort((a, b) => a - b);
            weeks.forEach(week => {
                weekLabels.push(`Semana ${week}`);
                const weekData = matchesByWeek[week];
                const row = dayNames.map((_, dayIndex) => weekData[dayIndex] || 0);
                heatmapData.push(row);
            });
            
            if (window.heatmapChartInstance) {
                window.heatmapChartInstance.destroy();
            }
            
            const datasets = dayNames.map((dayName, dayIndex) => {
                const dayData = heatmapData.map(row => row[dayIndex]);
                const maxValue = Math.max(...heatmapData.flat(), 1);
                
                return {
                    label: dayName,
                    data: dayData,
                    backgroundColor: dayData.map(value => {
                        const intensity = value / maxValue;
                        return `rgba(102, 126, 234, ${0.3 + intensity * 0.7})`;
                    }),
                    borderColor: dayData.map(value => {
                        const intensity = value / maxValue;
                        return `rgba(102, 126, 234, ${0.5 + intensity * 0.5})`;
                    }),
                    borderWidth: 1
                };
            });
            
            window.heatmapChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: weekLabels, datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${value} partido${value !== 1 ? 's' : ''}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, title: { display: true, text: 'Semana del Campeonato' } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Cantidad de Partidos' }, ticks: { stepSize: 1 } }
                    }
                }
            });
        }
        
        // Hacer funciones globales
        window.showPointsEvolutionChart = showPointsEvolutionChart;
        window.renderPointsEvolutionChart = renderPointsEvolutionChart;
        window.showTeamComparison = showTeamComparison;
        window.renderTeamComparisonChart = renderTeamComparisonChart;
        window.showHeatmapChart = showHeatmapChart;
        window.renderHeatmapChart = renderHeatmapChart;
    </script>
</body>
</html>
