<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ABALA - Gesti√≥n de Campeonatos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-size: 18px; /* Tama√±o base m√°s grande para mejor legibilidad */
            transition: background 0.3s ease;
        }
        
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-mode .card {
            background: #2d3748;
            color: #e2e8f0;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        body.dark-mode .card h2 {
            color: #90cdf4;
        }
        
        body.dark-mode .btn {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: #e2e8f0;
        }
        
        body.dark-mode .btn:hover {
            background: linear-gradient(135deg, #5a6578 0%, #3d4758 100%);
        }
        
        body.dark-mode input, 
        body.dark-mode select, 
        body.dark-mode textarea {
            background: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        
        body.dark-mode .tab {
            color: #cbd5e0;
        }
        
        body.dark-mode .tab.active {
            color: #90cdf4;
            border-bottom-color: #90cdf4;
        }
        
        body.dark-mode table {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        body.dark-mode table thead {
            background: #4a5568;
        }
        
        body.dark-mode table tbody tr:hover {
            background: #374151;
        }
        
        body.dark-mode table tbody tr {
            border-bottom: 1px solid #4a5568;
        }
        
        body.dark-mode .empty-state {
            color: #cbd5e0;
        }
        
        body.dark-mode .alert {
            background: #2d3748;
            color: #e2e8f0;
            border-left-color: #90cdf4;
        }
        
        body.dark-mode .alert-success {
            background: #22543d;
            color: #9ae6b4;
        }
        
        body.dark-mode .alert-error {
            background: #742a2a;
            color: #feb2b2;
        }
        
        body.dark-mode .alert-warning {
            background: #744210;
            color: #fbd38d;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 3em; /* M√°s grande */
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            font-weight: 700;
        }
        
        .header p {
            font-size: 1.3em; /* Subt√≠tulo m√°s grande */
            opacity: 0.95;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* ============================================
           RESPONSIVE DESIGN - MEDIA QUERIES
           ============================================ */
        
        /* Tablets y pantallas medianas */
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2.5em;
            }
            
            .header p {
                font-size: 1.1em;
            }
            
            .card {
                padding: 20px;
            }
            
            .card h2 {
                font-size: 1.8em;
            }
        }
        
        /* M√≥viles grandes y tablets peque√±as */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .header {
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 2em;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .header > div {
                flex-direction: column;
                gap: 15px;
            }
            
            #themeToggle {
                width: 100%;
                font-size: 1em;
            }
            
            .card {
                padding: 15px;
                border-radius: 10px;
            }
            
            .card h2 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            
            .tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .tab {
                padding: 12px 20px;
                font-size: 1.1em;
                min-height: 45px;
                flex: 1;
                min-width: calc(50% - 5px);
            }
            
            .form-group label {
                font-size: 1.1em;
            }
            
            .form-group input,
            .form-group select {
                padding: 15px;
                font-size: 16px; /* Evita zoom en iOS */
            }
            
            .btn {
                padding: 16px 30px;
                font-size: 1.1em;
                min-height: 55px;
            }
            
            .btn-large {
                padding: 18px 35px;
                font-size: 1.2em;
                min-height: 60px;
            }
            
            .help-text {
                padding: 15px;
                font-size: 1em;
            }
            
            .data-section {
                max-height: 500px;
            }
            
            .data-item {
                padding: 12px;
            }
            
            .data-item strong {
                font-size: 1.1em;
            }
            
            .alert {
                padding: 15px;
                font-size: 1em;
            }
            
            .response {
                padding: 12px;
                max-height: 400px;
            }
            
            /* Tablas responsive */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            table thead,
            table tbody,
            table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            
            table th,
            table td {
                padding: 10px 8px;
                font-size: 0.9em;
            }
            
            /* Fixture responsive */
            .fixture-container {
                padding: 15px !important;
                font-size: 14px !important;
            }
            
            .fixture-title {
                font-size: 1.5em !important;
                margin-bottom: 15px !important;
            }
            
            .fixture-stats {
                padding: 15px !important;
                gap: 15px !important;
                flex-direction: column !important;
            }
            
            .fixture-stat-number {
                font-size: 2.5em !important;
            }
            
            .fixture-stat-label {
                font-size: 1em !important;
            }
            
            .fixture-vuelta {
                padding: 15px !important;
                margin-bottom: 25px !important;
            }
            
            .fixture-vuelta-title {
                font-size: 1.4em !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 8px !important;
            }
            
            .fixture-jornada {
                padding: 15px !important;
                margin-bottom: 20px !important;
            }
            
            .fixture-jornada-title {
                font-size: 1.2em !important;
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 5px !important;
            }
            
            .fixture-match {
                padding: 15px !important;
            }
            
            .fixture-match-teams {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
                text-align: center !important;
            }
            
            .fixture-match-scores {
                flex-direction: column !important;
                gap: 10px !important;
                margin: 15px 0 !important;
            }
            
            .fixture-score-input {
                width: 100% !important;
                max-width: 120px !important;
                margin: 0 auto !important;
            }
            
            .fixture-match-actions {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            .fixture-action-button {
                width: 100% !important;
                padding: 14px !important;
                font-size: 1em !important;
            }
        }
        
        /* M√≥viles peque√±os */
        @media (max-width: 480px) {
            body {
                padding: 8px;
                font-size: 14px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .card {
                padding: 12px;
            }
            
            .card h2 {
                font-size: 1.3em;
                margin-bottom: 12px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 1em;
                min-height: 40px;
                min-width: 100%;
            }
            
            .form-group label {
                font-size: 1em;
                margin-bottom: 8px;
            }
            
            .form-group input,
            .form-group select {
                padding: 12px;
                font-size: 16px;
            }
            
            .btn {
                padding: 14px 25px;
                font-size: 1em;
                min-height: 50px;
            }
            
            .btn-large {
                padding: 16px 30px;
                font-size: 1.1em;
                min-height: 55px;
            }
            
            .help-text {
                padding: 12px;
                font-size: 0.95em;
            }
            
            .data-item {
                padding: 10px;
            }
            
            .data-item strong {
                font-size: 1em;
            }
            
            .data-item .info {
                font-size: 0.8em;
            }
            
            .alert {
                padding: 12px;
                font-size: 0.95em;
            }
            
            table th,
            table td {
                padding: 8px 5px;
                font-size: 0.85em;
            }
            
            /* Botones en data-item en m√≥vil */
            .data-item > div:last-child {
                width: 100% !important;
                max-width: 100% !important;
                flex-direction: row !important;
            }
            
            .data-item button {
                padding: 10px 15px;
                font-size: 0.9em;
                flex: 1;
                min-height: 45px;
            }
            
            .data-item > div:first-child {
                width: 100% !important;
                min-width: 100% !important;
            }
            
            /* Chips m√°s peque√±os */
            .chip {
                padding: 3px 8px;
                font-size: 0.75em;
            }
        }
        
        /* Pantallas muy peque√±as (menos de 360px) */
        @media (max-width: 360px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .card h2 {
                font-size: 1.2em;
            }
            
            .tab {
                font-size: 0.9em;
                padding: 8px 12px;
            }
            
            .btn {
                font-size: 0.95em;
                padding: 12px 20px;
            }
        }
        
        /* Orientaci√≥n landscape en m√≥viles */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .data-section {
                max-height: 300px;
            }
        }
        
        /* Impresi√≥n */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header,
            .tabs,
            .btn,
            #themeToggle {
                display: none;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .card h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 2em; /* M√°s grande */
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        
        /* Instrucciones de ayuda */
        .help-text {
            background: #e7f3ff;
            border-left: 5px solid #2196F3;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            font-size: 1.15em;
            line-height: 1.7;
            color: #1565C0;
        }
        
        .help-text strong {
            display: block;
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #0d47a1;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 12px; /* M√°s espacio */
            color: #333;
            font-weight: 700;
            font-size: 1.2em; /* M√°s grande */
        }
        
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 18px; /* M√°s padding para mejor toque */
            border: 3px solid #e0e0e0; /* Borde m√°s grueso */
            border-radius: 10px;
            font-size: 18px; /* M√°s grande */
            transition: all 0.3s;
            background: #fff;
        }
        
        /* Etiquetas de ayuda para campos */
        .field-help {
            font-size: 1em;
            color: #666;
            margin-top: 8px;
            font-style: italic;
            line-height: 1.5;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 40px; /* Botones m√°s grandes */
            border-radius: 10px;
            font-size: 1.2em; /* Texto m√°s grande */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
            min-height: 65px; /* Altura m√≠nima para mejor toque */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-large {
            padding: 24px 50px;
            font-size: 1.3em;
            min-height: 75px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: #6c757d;
            margin-top: 5px;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .data-section {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .data-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .data-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        
        .data-item .info {
            font-size: 0.85em;
            color: #666;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab {
            padding: 15px 30px; /* M√°s grande */
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1.3em; /* M√°s grande */
            color: #666;
            font-weight: 700;
            border-bottom: 4px solid transparent; /* M√°s grueso */
            transition: all 0.3s;
            min-height: 50px;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .response {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .response pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state::before {
            content: "üìã";
            font-size: 3em;
            display: block;
            margin-bottom: 10px;
        }
        
        .chips {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }
        
        .chip {
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .alert {
            padding: 20px; /* M√°s padding */
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 1.2em; /* M√°s grande */
            line-height: 1.6;
            font-weight: 500;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h1 style="margin: 0;">üèÄ ABALA</h1>
                <button id="themeToggle" onclick="toggleTheme()" style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 700;">
                    üåô Modo Oscuro
                </button>
            </div>
            <p style="font-size: 1.4em; opacity: 0.95; margin-top: 10px;">Sistema Simple para Administrar Campeonatos de B√°squetbol</p>
        </div>
        
        <div class="main-grid">
            <!-- Panel Izquierdo: Crear/Gestionar -->
            <div class="card">
                <h2>‚öôÔ∏è Gesti√≥n del Campeonato</h2>
                
                <div class="help-text" id="helpContent">
                    <strong>üí° Bienvenido</strong>
                    <span id="helpText">Seleccione una opci√≥n en las pesta√±as de arriba para comenzar. Use "Crear" para crear nuevos campeonatos o categor√≠as, y "Gestionar" para ver la informaci√≥n existente.</span>
                </div>
                
                <div class="tabs">
                    <button class="tab active" data-tab="dashboard">üìä Dashboard</button>
                    <button class="tab" data-tab="create">‚ûï Crear Nuevo</button>
                    <button class="tab" data-tab="manage">üëÅÔ∏è Ver y Gestionar</button>
                </div>
                
                <!-- Tab: Dashboard -->
                <div id="dashboardTab" class="tab-content active">
                    <div class="help-text">
                        <strong>üìä Resumen General</strong>
                        Vista general de todos los campeonatos, pr√≥ximos partidos y resultados recientes.
                    </div>
                    <button class="btn btn-large" onclick="loadDashboard()" style="width: 100%; margin-top: 20px;">
                        üîÑ Actualizar Dashboard
                    </button>
                    <div id="dashboardContent" style="margin-top: 30px;"></div>
                </div>
                
                <!-- Tab: Crear -->
                <div id="createTab" class="tab-content">
                    <div class="form-group">
                        <label>üìã ¬øQu√© desea crear?</label>
                        <select id="actionSelect" onchange="updateForm()" style="font-size: 1.1em; padding: 18px;">
                            <option value="createChamp" selected>üèÜ Crear un Nuevo Campeonato</option>
                            <option value="addCategory">üìÅ Agregar una Categor√≠a a un Campeonato</option>
                        </select>
                        <div class="field-help">Seleccione qu√© desea crear en el men√∫ de arriba</div>
                    </div>
                    
                    <div id="dynamicForm"></div>
                    
                    <button class="btn btn-large" onclick="executeAction()">‚úÖ Crear Ahora</button>
                    <button class="btn btn-secondary" onclick="loadData()">üîÑ Actualizar Lista</button>
                </div>
                
                <!-- Tab: Gestionar -->
                <div id="manageTab" class="tab-content">
                    <div class="help-text">
                        <strong>üëÅÔ∏è Ver Informaci√≥n del Campeonato</strong>
                        Seleccione qu√© desea ver y el campeonato correspondiente. Luego haga clic en "Ver Informaci√≥n" para mostrar los datos.
                    </div>
                    
                    <div class="form-group">
                        <label>üìä ¬øQu√© desea ver?</label>
                        <select id="viewSelect" onchange="loadView()" style="font-size: 1.1em; padding: 18px;">
                            <option value="standings">üìà Ver Tabla de Posiciones</option>
                            <option value="fixture">üìÖ Ver Calendario de Partidos (Fixture)</option>
                        </select>
                        <div class="field-help">Elija qu√© informaci√≥n desea ver del campeonato</div>
                    </div>
                    
                    <div id="viewForm"></div>
                    <button class="btn btn-large" onclick="loadViewData()">üëÅÔ∏è Ver Informaci√≥n</button>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <h3 style="color: #667eea; font-size: 1.1em; margin-bottom: 15px;">üíæ Guardar y Exportar</h3>
                        
                        <div class="form-group">
                            <label>Campeonato:</label>
                            <select id="exportChampSelect">
                                <option value="">Selecciona campeonato</option>
                            </select>
                        </div>
                        
                        <button class="btn" onclick="saveChampionship()" style="background: #28a745; margin-bottom: 10px;">
                            üíæ Guardar Campeonato (JSON)
                        </button>
                        
                        <button class="btn btn-secondary" onclick="loadChampionship()" style="background: #17a2b8; margin-bottom: 10px;">
                            üìÇ Cargar Campeonato Guardado
                        </button>
                        
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="exportFixture('pdf')" style="background: #ffc107; color: #000; flex: 1; min-width: 150px;">
                                    üìÑ PDF
                                </button>
                                <button class="btn btn-secondary" onclick="exportFixture('csv')" style="background: #28a745; color: white; flex: 1; min-width: 150px;">
                                    üìä CSV
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;">
                                <button class="btn btn-secondary" onclick="exportStandings('pdf')" style="background: #ffc107; color: #000; flex: 1; min-width: 120px;">
                                    üìÑ PDF
                                </button>
                                <button class="btn btn-secondary" onclick="exportStandings('csv')" style="background: #28a745; color: white; flex: 1; min-width: 120px;">
                                    üìä CSV
                                </button>
                                <button class="btn btn-secondary" onclick="exportStandings('excel')" style="background: #007bff; color: white; flex: 1; min-width: 120px;">
                                    üìó Excel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Panel Derecho: Datos Creados -->
            <div class="card">
                <h2>üìä Datos Creados</h2>
                
                <!-- Barra de b√∫squeda -->
                <div style="margin-bottom: 20px;">
                    <input type="text" id="searchInput" placeholder="üîç Buscar campeonatos..." 
                           style="width: 100%; padding: 12px; font-size: 1.1em; border-radius: 8px; border: 2px solid #667eea;"
                           onkeyup="filterChampionships()">
                </div>
                
                <div class="tabs">
                    <button class="tab active" onclick="window.switchDataTab('championships')">Campeonatos</button>
                    <button class="tab" onclick="window.switchDataTab('categories')">Categor√≠as</button>
                </div>
                
                <div id="championshipsTab" class="tab-content active data-section">
                    <div id="championshipsList"></div>
                </div>
                
                <div id="categoriesTab" class="tab-content data-section">
                    <div id="categoriesList"></div>
                </div>
            </div>
        </div>
        
        <!-- Respuesta -->
        <div class="card" id="responseCard" style="display: none;">
            <h2>üì§ Respuesta</h2>
            <div id="response" class="response"></div>
        </div>
    </div>
    
    <script>
        // Asegurar que las funciones est√©n en el scope global
        window.API_BASE = window.location.origin;
        const API_BASE = window.API_BASE;
        let championshipsData = {};
        let categoriesData = {};
        
        // Funci√≥n de utilidad para mostrar alertas
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); max-width: 400px; font-size: 1.1em;';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }
        
        // Asegurar que showAlert est√© disponible globalmente
        window.showAlert = showAlert;
        
        // Sistema de temas (modo oscuro/claro)
        function initTheme() {
            try {
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                    updateThemeButton('dark');
                } else {
                    document.body.classList.remove('dark-mode');
                    updateThemeButton('light');
                }
            } catch (error) {
                console.error('Error inicializando tema:', error);
            }
        }
        
        function toggleTheme() {
            try {
                const isDark = document.body.classList.contains('dark-mode');
                if (isDark) {
                    document.body.classList.remove('dark-mode');
                    localStorage.setItem('theme', 'light');
                    updateThemeButton('light');
                } else {
                    document.body.classList.add('dark-mode');
                    localStorage.setItem('theme', 'dark');
                    updateThemeButton('dark');
                }
            } catch (error) {
                console.error('Error cambiando tema:', error);
                showAlert('Error al cambiar el tema', 'error');
            }
        }
        
        function updateThemeButton(theme) {
            try {
                const button = document.getElementById('themeToggle');
                if (button) {
                    if (theme === 'dark') {
                        button.textContent = '‚òÄÔ∏è Modo Claro';
                        button.style.background = 'rgba(255,255,255,0.3)';
                    } else {
                        button.textContent = 'üåô Modo Oscuro';
                        button.style.background = 'rgba(255,255,255,0.2)';
                    }
                } else {
                    console.warn('Bot√≥n themeToggle no encontrado');
                }
            } catch (error) {
                console.error('Error actualizando bot√≥n de tema:', error);
            }
        }
        
        window.toggleTheme = toggleTheme;
        window.initTheme = initTheme;
        
        // Inicializar tema al cargar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTheme);
        } else {
            // DOM ya est√° cargado
            setTimeout(initTheme, 100);
        }
        
        // Asegurar que switchTab est√© disponible globalmente ANTES de cualquier otra cosa
        window.switchTab = function(tab) {
            try {
                console.log('üîµ switchTab llamado con:', tab);
                console.log('üîµ window.switchTab existe?', typeof window.switchTab);
                
                // Obtener el panel de Gesti√≥n espec√≠ficamente (primer .card dentro de .main-grid)
                const mainGrid = document.querySelector('.main-grid');
                if (!mainGrid) {
                    console.error('No se encontr√≥ .main-grid');
                    return;
                }
                
                const gestionCard = mainGrid.querySelector('.card:first-child');
                if (!gestionCard) {
                    console.error('No se encontr√≥ el panel de Gesti√≥n');
                    return;
                }
                
                const tabs = gestionCard.querySelectorAll('.tabs .tab');
                const tabContents = gestionCard.querySelectorAll('.tab-content');
                
                console.log('Pesta√±as encontradas:', tabs.length);
                
                // Remover active de todos
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Activar seg√∫n el tab seleccionado
                if (tab === 'dashboard') {
                    const dashboardTab = document.getElementById('dashboardTab');
                    if (dashboardTab && tabs[0]) {
                        tabs[0].classList.add('active');
                        dashboardTab.classList.add('active');
                        console.log('Dashboard activado');
                        setTimeout(() => loadDashboard(), 100); // Cargar autom√°ticamente al cambiar a dashboard
                    } else {
                        console.error('Dashboard tab no encontrado');
                    }
                } else if (tab === 'create') {
                    const createTab = document.getElementById('createTab');
                    if (createTab && tabs[1]) {
                        tabs[1].classList.add('active');
                        createTab.classList.add('active');
                        console.log('Crear tab activado');
                        // Asegurar que el formulario se actualice
                        setTimeout(() => {
                            try {
                                updateForm();
                            } catch (e) {
                                console.error('Error en updateForm:', e);
                            }
                        }, 100);
                    } else {
                        console.error('Create tab no encontrado');
                    }
                } else if (tab === 'manage') {
                    const manageTab = document.getElementById('manageTab');
                    if (manageTab && tabs[2]) {
                        tabs[2].classList.add('active');
                        manageTab.classList.add('active');
                        console.log('Gestionar tab activado');
                        // Asegurar que el formulario de vista se actualice
                        setTimeout(() => {
                            try {
                                loadView();
                            } catch (e) {
                                console.error('Error en loadView:', e);
                            }
                        }, 100);
                    } else {
                        console.error('Manage tab no encontrado');
                    }
                }
            } catch (error) {
                console.error('Error en switchTab:', error);
                showAlert('Error al cambiar de pesta√±a: ' + error.message, 'error');
            }
        };
        
        // Asegurar que loadDashboard est√© disponible globalmente
        window.loadDashboard = async function() {
            const dashboardContent = document.getElementById('dashboardContent');
            if (!dashboardContent) {
                console.error('dashboardContent no encontrado');
                return;
            }
            
            dashboardContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div><div style="font-size: 1.2em;">Cargando dashboard...</div></div>';
            
            try {
                const res = await fetch(`${API_BASE}/api/dashboard`);
                
                if (!res.ok) {
                    throw new Error(`Error HTTP: ${res.status}`);
                }
                
                const data = await res.json();
                
                if (!data.success) {
                    dashboardContent.innerHTML = `<div class="alert alert-error">Error al cargar el dashboard: ${data.error || 'Error desconocido'}</div>`;
                    return;
                }
                
                if (!data.dashboard) {
                    dashboardContent.innerHTML = `<div class="alert alert-error">Error: Datos del dashboard no disponibles</div>`;
                    return;
                }
                
                const dashboard = data.dashboard;
                renderDashboard(dashboard);
                // Verificar notificaciones despu√©s de renderizar
                setTimeout(() => checkNotifications(dashboard), 500);
            } catch (error) {
                console.error('Error cargando dashboard:', error);
                if (dashboardContent) {
                    dashboardContent.innerHTML = `<div class="alert alert-error">Error de conexi√≥n: ${error.message || 'Error desconocido'}. Por favor, intente nuevamente.</div>`;
                }
            }
        };
        
        function checkNotifications(dashboard) {
            const notifications = [];
            const now = new Date();
            
            // Verificar partidos pr√≥ximos (pr√≥ximas 24 horas)
            if (dashboard.upcoming_matches && dashboard.upcoming_matches.length > 0) {
                dashboard.upcoming_matches.forEach(match => {
                    if (match.date) {
                        try {
                            const matchDate = new Date(match.date + 'T' + (match.time || '20:00'));
                            const hoursUntil = (matchDate - now) / (1000 * 60 * 60);
                            if (hoursUntil > 0 && hoursUntil <= 24) {
                                notifications.push({
                                    type: 'upcoming',
                                    message: `‚è∞ Partido pr√≥ximo: ${match.team_a} vs ${match.team_b} en ${Math.round(hoursUntil)} horas`,
                                    match: match
                                });
                            }
                        } catch (e) {
                            console.error('Error procesando fecha de partido:', e);
                        }
                    }
                });
            }
            
            // Verificar partidos sin fecha programada
            if (dashboard.summary && dashboard.summary.matches_pending > 0) {
                const totalPending = dashboard.summary.matches_pending;
                if (totalPending > 5) {
                    notifications.push({
                        type: 'warning',
                        message: `‚ö†Ô∏è Hay ${totalPending} partidos pendientes sin fecha programada`
                    });
                }
            }
            
            // Mostrar notificaciones
            if (notifications.length > 0) {
                showNotifications(notifications);
            }
        }
        
        function showNotifications(notifications) {
            // Remover notificaciones anteriores
            const existing = document.getElementById('notifications');
            if (existing) existing.remove();
            
            const notificationDiv = document.createElement('div');
            notificationDiv.id = 'notifications';
            notificationDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; max-width: 400px;';
            
            let html = '';
            notifications.forEach((notif) => {
                const bgColor = notif.type === 'upcoming' ? '#ffc107' : '#ff9800';
                html += `
                    <div style="background: ${bgColor}; color: #000; padding: 15px; margin-bottom: 10px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: slideIn 0.3s ease;">
                        <div style="font-weight: bold; margin-bottom: 5px; font-size: 1.1em;">${notif.message}</div>
                        ${notif.match && notif.match.date ? `<div style="font-size: 0.9em; opacity: 0.8;">${notif.match.date} a las ${notif.match.time || 'TBD'}</div>` : ''}
                    </div>
                `;
            });
            
            notificationDiv.innerHTML = html;
            document.body.appendChild(notificationDiv);
            
            // Auto-ocultar despu√©s de 10 segundos
            setTimeout(() => {
                if (notificationDiv.parentNode) {
                    notificationDiv.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        if (notificationDiv.parentNode) {
                            notificationDiv.remove();
                        }
                    }, 300);
                }
            }, 10000);
        }
        
        function renderDashboard(dashboard) {
            const dashboardContent = document.getElementById('dashboardContent');
            if (!dashboardContent) {
                console.error('dashboardContent no encontrado en renderDashboard');
                return;
            }
            
            if (!dashboard) {
                dashboardContent.innerHTML = '<div class="alert alert-error">Error: Datos del dashboard no disponibles</div>';
                return;
            }
            
            const { summary, championships, upcoming_matches, recent_results } = dashboard;
            
            // Validar que los datos existan
            if (!summary) {
                dashboardContent.innerHTML = '<div class="alert alert-error">Error: Resumen no disponible</div>';
                return;
            }
            
            let html = `
                <!-- Resumen General -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 8px 25px rgba(0,0,0,0.2);">
                    <h3 style="margin-bottom: 25px; font-size: 2em; text-align: center;">üìä Resumen General</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.total_championships || 0}</div>
                            <div style="font-size: 1.2em;">Campeonatos</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.total_teams || 0}</div>
                            <div style="font-size: 1.2em;">Equipos</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.total_matches || 0}</div>
                            <div style="font-size: 1.2em;">Partidos Totales</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 10px; text-align: center; backdrop-filter: blur(10px);">
                            <div style="font-size: 3em; font-weight: bold; margin-bottom: 10px;">${summary.overall_progress || 0}%</div>
                            <div style="font-size: 1.2em;">Progreso General</div>
                        </div>
                    </div>
                    <div style="margin-top: 25px; padding-top: 25px; border-top: 2px solid rgba(255,255,255,0.3); display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 2em; font-weight: bold; color: #28a745;">${summary.matches_played || 0}</div>
                            <div style="font-size: 1em; opacity: 0.9;">Jugados</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: bold; color: #ffc107;">${summary.matches_pending || 0}</div>
                            <div style="font-size: 1em; opacity: 0.9;">Pendientes</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: bold;">${summary.total_categories || 0}</div>
                            <div style="font-size: 1em; opacity: 0.9;">Categor√≠as</div>
                        </div>
                    </div>
                </div>
                
                <!-- Campeonatos -->
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.8em; font-weight: 700;">üèÜ Campeonatos Activos</h3>
                    <div style="display: grid; gap: 20px;">
            `;
            
            if (!championships || championships.length === 0) {
                html += '<div class="empty-state">No hay campeonatos creados</div>';
            } else {
                championships.forEach((champ) => {
                    html += `
                        <div style="background: white; padding: 25px; border-radius: 12px; border-left: 5px solid #667eea; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <h4 style="color: #667eea; font-size: 1.5em; margin-bottom: 10px; font-weight: 700;">${champ.name || 'Sin nombre'}</h4>
                                    <div style="color: #666; font-size: 1.1em; line-height: 1.8;">
                                        <div>üìÅ <strong>Categor√≠as:</strong> ${champ.categories_count || 0}</div>
                                        <div>üë• <strong>Equipos:</strong> ${champ.teams_count || 0}</div>
                                        <div>üîÑ <strong>Vueltas:</strong> ${champ.rounds || 0}</div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 2.5em; font-weight: bold; color: #667eea; margin-bottom: 5px;">${champ.progress_percentage || 0}%</div>
                                    <div style="color: #666; font-size: 0.9em;">Progreso</div>
                                </div>
                            </div>
                            <div style="background: #f0f0f0; border-radius: 10px; padding: 15px; margin-top: 15px;">
                                <div style="display: flex; justify-content: space-around; text-align: center;">
                                    <div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #28a745;">${champ.matches_played || 0}</div>
                                        <div style="font-size: 0.9em; color: #666;">Jugados</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #dc3545;">${champ.matches_pending || 0}</div>
                                        <div style="font-size: 0.9em; color: #666;">Pendientes</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.8em; font-weight: bold; color: #667eea;">${champ.matches_total || 0}</div>
                                        <div style="font-size: 0.9em; color: #666;">Total</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `</div></div>`;
            
            // Pr√≥ximos Partidos
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.8em; font-weight: 700;">üìÖ Pr√≥ximos Partidos</h3>
            `;
            
            if (!upcoming_matches || upcoming_matches.length === 0) {
                html += '<div class="empty-state">No hay partidos programados pr√≥ximamente</div>';
            } else {
                html += '<div style="display: grid; gap: 15px;">';
                upcoming_matches.forEach((match) => {
                    let dateStr = 'Fecha por definir';
                    if (match.date) {
                        try {
                            const dateObj = new Date(match.date);
                            dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) {
                            dateStr = match.date;
                        }
                    }
                    html += `
                        <div style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 20px; border-radius: 12px; border-left: 5px solid #ffc107; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #856404; margin-bottom: 8px; font-size: 1.1em;">${match.championship_name || 'Sin nombre'} - ${match.category || 'Sin categor√≠a'}</div>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #333; margin-bottom: 5px;">
                                        ${match.team_a || 'Equipo A'} <span style="color: #666;">vs</span> ${match.team_b || 'Equipo B'}
                                    </div>
                                    <div style="color: #666; font-size: 1em;">
                                        üìÖ ${dateStr} üïê ${match.time || 'Por definir'}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="background: #ffc107; color: #000; padding: 8px 15px; border-radius: 8px; font-weight: bold; font-size: 1.1em;">
                                        ${match.match_type === 'ida' ? 'Vuelta 1' : match.match_type === 'vuelta' ? 'Vuelta 2' : 'Vuelta'} - Jornada ${match.matchday || 'N/A'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `</div>`;
            
            // Resultados Recientes
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="color: #667eea; margin-bottom: 20px; font-size: 1.8em; font-weight: 700;">‚öΩ Resultados Recientes</h3>
            `;
            
            if (!recent_results || recent_results.length === 0) {
                html += '<div class="empty-state">No hay resultados recientes</div>';
            } else {
                html += '<div style="display: grid; gap: 15px;">';
                recent_results.forEach((result) => {
                    let dateStr = 'Fecha no disponible';
                    if (result.date) {
                        try {
                            const dateObj = new Date(result.date);
                            dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                        } catch (e) {
                            dateStr = result.date;
                        }
                    }
                    html += `
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #28a745; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 1.1em;">${result.championship_name || 'Sin nombre'} - ${result.category || 'Sin categor√≠a'}</div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 5px;">${result.team_a || 'Equipo A'}</div>
                                    <div style="font-size: 2em; font-weight: bold; color: ${result.winner === result.team_a ? '#28a745' : '#666'};">
                                        ${result.score_a !== null && result.score_a !== undefined ? result.score_a : '-'}
                                    </div>
                                </div>
                                <div style="font-size: 1.5em; font-weight: bold; color: #666; margin: 0 20px;">-</div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="font-size: 1.2em; font-weight: bold; color: #333; margin-bottom: 5px;">${result.team_b || 'Equipo B'}</div>
                                    <div style="font-size: 2em; font-weight: bold; color: ${result.winner === result.team_b ? '#28a745' : '#666'};">
                                        ${result.score_b !== null && result.score_b !== undefined ? result.score_b : '-'}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; color: #666; font-size: 0.95em; margin-top: 10px;">
                                üìÖ ${dateStr} | Ganador: <strong style="color: #28a745;">${result.winner || 'Empate'}</strong>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `</div>`;
            
            dashboardContent.innerHTML = html;
        }
        
        // Asegurar que switchDataTab est√© disponible globalmente
        window.switchDataTab = function(tab) {
            document.querySelectorAll('#championshipsTab, #categoriesTab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach((t, i) => {
                if ((tab === 'championships' && i === 0) || (tab === 'categories' && i === 1)) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            
            if (tab === 'championships') {
                document.getElementById('championshipsTab').classList.add('active');
            } else {
                document.getElementById('categoriesTab').classList.add('active');
            }
        };
        
        // Asegurar que loadData est√© disponible globalmente
        window.loadData = async function() {
            try {
                console.log('üîÑ Cargando campeonatos desde el servidor (MongoDB)...');
                // Obtener la lista de campeonatos del servidor PRIMERO
                const res = await fetch(`${API_BASE}/api/championships`);
                const data = await res.json();
                
                if (data.success) {
                    const champList = data.championships || {};
                    console.log(`‚úÖ Encontrados ${Object.keys(champList).length} campeonato(s) en el servidor (MongoDB)`);
                    
                    // Limpiar datos de campeonatos que ya no existen en el servidor
                    const serverIds = new Set(Object.keys(champList));
                    Object.keys(championshipsData).forEach(id => {
                        if (!serverIds.has(id)) {
                            console.log(`Eliminando campeonato ${id} que ya no existe en el servidor`);
                            delete championshipsData[id];
                            delete categoriesData[id];
                            removeChampionshipFromLocal(id);
                        }
                    });
                    
                    // Cargar datos completos de cada campeonato
                    const loadPromises = Object.keys(champList).map(async (id) => {
                        try {
                            const champRes = await fetch(`${API_BASE}/api/championships/${id}`);
                            const champData = await champRes.json();
                            
                            if (champData.success && champData.championship) {
                                championshipsData[id] = {
                                    name: champData.championship.name,
                                    rounds: champData.championship.rounds,
                                    points_per_win: champData.championship.points_per_win,
                                    points_per_loss: champData.championship.points_per_loss,
                                    categories: champData.championship.categories || {}
                                };
                                
                                // Extraer categor√≠as con equipos
                                if (champData.championship.categories) {
                                    categoriesData[id] = champData.championship.categories;
                                }
                                
                                // Guardar en localStorage como backup
                                saveToLocalStorage(id, championshipsData[id]);
                                console.log(`‚úÖ Cargado campeonato: ${champData.championship.name} (${id})`);
                            } else {
                                // Si falla, usar datos del resumen
                                championshipsData[id] = champList[id];
                                saveToLocalStorage(id, championshipsData[id]);
                            }
                        } catch (error) {
                            console.error(`Error cargando campeonato ${id}:`, error);
                            championshipsData[id] = champList[id];
                            saveToLocalStorage(id, championshipsData[id]);
                        }
                    });
                    
                    await Promise.all(loadPromises);
                    
                    // Cargar desde localStorage solo los que no est√°n en el servidor (para datos offline)
                    loadFromLocalStorage();
                    
                    renderChampionships();
                    renderCategories();
                    updateForm(); // Actualizar formularios con datos disponibles
                    console.log(`‚úÖ Renderizados ${Object.keys(championshipsData).length} campeonato(s) en "üìä Datos Creados"`);
                } else {
                    console.warn('‚ö†Ô∏è El servidor no respondi√≥ con success');
                    // Si el servidor no responde con success, cargar desde localStorage
                    loadFromLocalStorage();
                    renderChampionships();
                    renderCategories();
                    updateForm();
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                // Si falla el servidor, cargar desde localStorage
                loadFromLocalStorage();
                renderChampionships();
                renderCategories();
                updateForm(); // Actualizar formularios con datos cargados
                showAlert('‚ö†Ô∏è Cargando desde almacenamiento local (servidor no disponible). Los campeonatos se guardan en MongoDB cuando el servidor est√° disponible.', 'warning');
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                Object.entries(saved).forEach(([id, champ]) => {
                    // Solo cargar si no existe en memoria y tiene datos v√°lidos
                    if (!championshipsData[id] && champ && champ.name) {
                        championshipsData[id] = champ;
                        // Tambi√©n actualizar categoriesData si hay categor√≠as
                        if (champ.categories) {
                            categoriesData[id] = champ.categories;
                        }
                    }
                });
            } catch (error) {
                console.error('Error cargando desde localStorage:', error);
            }
        }
        
        function saveToLocalStorage(champId, champData) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                saved[champId] = {
                    ...champData,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('savedChampionships', JSON.stringify(saved));
            } catch (error) {
                console.error('Error guardando en localStorage:', error);
            }
        }
        
        function renderChampionships() {
            const list = document.getElementById('championshipsList');
            
            if (!list) {
                console.error('championshipsList no encontrado');
                return;
            }
            
            // Filtrar solo campeonatos que realmente existen y tienen datos v√°lidos
            let validChampionships = Object.entries(championshipsData).filter(([id, champ]) => {
                return champ && champ.name && id;
            });
            
            // Aplicar b√∫squeda si hay t√©rmino de b√∫squeda
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.toLowerCase();
                validChampionships = validChampionships.filter(([id, champ]) => {
                    const name = (champ.name || '').toLowerCase();
                    const idLower = id.toLowerCase();
                    const categories = champ.categories ? Object.keys(champ.categories).join(' ').toLowerCase() : '';
                    return name.includes(searchTerm) || idLower.includes(searchTerm) || categories.includes(searchTerm);
                });
            }
            
            console.log(`Renderizando ${validChampionships.length} campeonatos:`, validChampionships.map(([id]) => id));
            
            if (validChampionships.length === 0) {
                const searchInput = document.getElementById('searchInput');
                const hasSearch = searchInput && searchInput.value.trim();
                list.innerHTML = `<div class="empty-state">${hasSearch ? 'No se encontraron campeonatos que coincidan con la b√∫squeda' : 'No hay campeonatos creados'}</div>`;
                return;
            }
            
            list.innerHTML = validChampionships.map(([id, champ]) => `
                <div class="data-item" style="border: 2px solid #667eea; border-radius: 8px; padding: 15px; margin-bottom: 15px; background: #f8f9fa; cursor: pointer; transition: all 0.3s;" 
                     onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';" 
                     onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';"
                     onclick="loadChampionshipDetails('${id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <strong style="font-size: 1.2em; color: #667eea;">${champ.name || id}</strong>
                            <div class="info" style="margin-top: 8px; color: #666; font-size: 0.9em;">
                                <div>ID: <code>${id}</code></div>
                                <div>Vueltas: ${champ.rounds || 'N/A'}</div>
                                <div>Categor√≠as: ${champ.categories ? Object.keys(champ.categories).length : 0}</div>
                                <div>Puntos por Victoria: ${champ.points_per_win || 2} | Derrota: ${champ.points_per_loss || 0}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; flex-direction: column; width: 100%; max-width: 150px;">
                            <button onclick="event.stopPropagation(); loadChampionshipDetails('${id}')" 
                                style="padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; min-height: 40px;">
                                üëÅÔ∏è Ver
                            </button>
                            <button onclick="event.stopPropagation(); deleteChampionship('${id}')" 
                                style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; width: 100%; min-height: 40px;">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                    ${champ.categories ? `<div class="chips" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;">${Object.keys(champ.categories).map(cat => `<span class="chip" style="background: #667eea; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${cat}</span>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }
        
        async function loadChampionshipDetails(champId) {
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}`);
                const data = await res.json();
                
                if (data.success) {
                    // Mostrar detalles en el panel de respuesta
                    const responseCard = document.getElementById('responseCard');
                    const responseDiv = document.getElementById('response');
                    
                    responseCard.style.display = 'block';
                    responseDiv.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="color: #667eea; margin-bottom: 15px;">üìã Detalles del Campeonato: ${data.championship.name}</h3>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p><strong>ID:</strong> <code>${champId}</code></p>
                                <p><strong>Vueltas:</strong> ${data.championship.rounds}</p>
                                <p><strong>Puntos por Victoria:</strong> ${data.championship.points_per_win}</p>
                                <p><strong>Puntos por Derrota:</strong> ${data.championship.points_per_loss}</p>
                            </div>
                            
                            <h4 style="color: #667eea; margin-top: 20px; margin-bottom: 10px;">Categor√≠as:</h4>
                            ${Object.keys(data.championship.categories || {}).length > 0 
                                ? Object.entries(data.championship.categories || {}).map(([catName, cat]) => `
                                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                                        <strong>${catName}</strong>
                                        <div style="margin-top: 8px;">
                                            <strong>Equipos (${cat.teams?.length || 0}):</strong>
                                            <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                                ${cat.teams?.map(t => `<span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">${t.name || t}</span>`).join('') || 'Sin equipos'}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')
                                : '<p style="color: #666;">No hay categor√≠as creadas</p>'
                            }
                            
                            <div style="margin-top: 20px; display: flex; gap: 10px;">
                                <button onclick="saveChampionshipToLocal('${champId}')" 
                                    style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üíæ Guardar Localmente
                                </button>
                                <button onclick="loadChampionshipFromLocal('${champId}')" 
                                    style="padding: 10px 20px; background: #17a2b8; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                    üìÇ Cargar desde Local
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Scroll a la respuesta
                    responseCard.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                showAlert('Error al cargar detalles: ' + error.message, 'error');
            }
        }
        
        async function deleteChampionship(champId) {
            // Confirmaci√≥n antes de eliminar
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar el campeonato "${champName}"?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }
            if (!confirm(`¬øEst√°s seguro de eliminar el campeonato "${championshipsData[champId]?.name || champId}"? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }
            
            try {
                // Eliminar del servidor
                const res = await fetch(`${API_BASE}/api/championships/${champId}`, {
                    method: 'DELETE'
                });
                
                const data = await res.json();
                
                if (data.success || res.status === 200 || res.ok) {
                    // Eliminar del localStorage PRIMERO
                    removeChampionshipFromLocal(champId);
                    
                    // Eliminar de los datos en memoria
                    delete championshipsData[champId];
                    delete categoriesData[champId];
                    
                    console.log(`‚úÖ Campeonato ${champId} eliminado de memoria`);
                    console.log(`Campeonatos restantes:`, Object.keys(championshipsData));
                    
                    // Renderizar inmediatamente para actualizar la vista
                    renderChampionships();
                    renderCategories();
                    updateForm();
                    updateExportSelect();
                    
                    showAlert('Campeonato eliminado exitosamente', 'success');
                    
                    // NO recargar datos desde el servidor/localStorage porque podr√≠a restaurar el eliminado
                    // Solo sincronizar despu√©s de un delay m√°s largo si es necesario
                } else {
                    showAlert(data.error || 'Error al eliminar', 'error');
                }
            } catch (error) {
                console.error('Error eliminando campeonato:', error);
                // Si falla el servidor, eliminar solo del localStorage
                removeChampionshipFromLocal(champId);
                delete championshipsData[champId];
                delete categoriesData[champId];
                
                console.log(`‚úÖ Campeonato ${champId} eliminado de memoria (servidor no disponible)`);
                console.log(`Campeonatos restantes:`, Object.keys(championshipsData));
                
                // Renderizar inmediatamente
                renderChampionships();
                renderCategories();
                updateForm();
                updateExportSelect();
                
                showAlert('Campeonato eliminado del almacenamiento local (servidor no disponible)', 'warning');
                // NO recargar datos porque podr√≠a restaurar el eliminado
            }
        }
        
        function saveChampionshipToLocal(champId) {
            try {
                const champ = championshipsData[champId];
                if (!champ) {
                    showAlert('Campeonato no encontrado', 'error');
                    return;
                }
                
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                saved[champId] = {
                    ...champ,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('savedChampionships', JSON.stringify(saved));
                showAlert('Campeonato guardado localmente', 'success');
            } catch (error) {
                showAlert('Error al guardar: ' + error.message, 'error');
            }
        }
        
        function loadChampionshipFromLocal(champId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                const champ = saved[champId];
                
                if (!champ) {
                    showAlert('Campeonato no encontrado en almacenamiento local', 'error');
                    return;
                }
            
                showAlert('Campeonato cargado desde almacenamiento local', 'success');
                // Los datos ya est√°n en championshipsData, solo recargamos la vista
                renderChampionships();
            } catch (error) {
                showAlert('Error al cargar: ' + error.message, 'error');
            }
        }
        
        function removeChampionshipFromLocal(champId) {
            try {
                const saved = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                if (saved[champId]) {
                    delete saved[champId];
                    localStorage.setItem('savedChampionships', JSON.stringify(saved));
                    console.log(`‚úÖ Campeonato ${champId} eliminado de localStorage`);
                    
                    // Verificar que realmente se elimin√≥
                    const verify = JSON.parse(localStorage.getItem('savedChampionships') || '{}');
                    if (verify[champId]) {
                        console.error(`‚ùå ERROR: Campeonato ${champId} todav√≠a existe en localStorage despu√©s de eliminar`);
                    } else {
                        console.log(`‚úÖ Verificado: Campeonato ${champId} eliminado correctamente de localStorage`);
                    }
                } else {
                    console.log(`‚ö†Ô∏è Campeonato ${champId} no encontrado en localStorage`);
                }
            } catch (error) {
                console.error('Error al eliminar del localStorage:', error);
            }
        }
        
        function renderCategories() {
            const list = document.getElementById('categoriesList');
            
            if (Object.keys(categoriesData).length === 0) {
                list.innerHTML = '<div class="empty-state">No hay categor√≠as creadas</div>';
                return;
            }
            
            let html = '';
            for (const [champId, categories] of Object.entries(categoriesData)) {
                for (const [catName, cat] of Object.entries(categories)) {
                    html += `
                        <div class="data-item" onclick="selectCategory('${champId}', '${catName}')">
                            <strong>${catName}</strong>
                            <div class="info">
                                Campeonato: ${championshipsData[champId]?.name || champId}<br>
                                Equipos: ${cat.teams ? cat.teams.length : 0}<br>
                                Partidos: ${cat.matches ? cat.matches.length : 0}
                            </div>
                        </div>
                    `;
                }
            }
            list.innerHTML = html || '<div class="empty-state">No hay categor√≠as</div>';
        }
        
        function selectChampionship(id) {
            const champ = championshipsData[id];
            if (!champ) return;
            
            // Auto-rellenar formularios
            document.getElementById('champId')?.setAttribute('value', id);
            document.getElementById('champIdSelect')?.setAttribute('value', id);
            document.getElementById('champIdView')?.setAttribute('value', id);
            
            // Mostrar alerta
            showAlert(`Campeonato "${champ.name || id}" seleccionado`, 'success');
        }
        
        function selectCategory(champId, catName) {
            // Auto-rellenar formularios
            document.getElementById('categoryName')?.setAttribute('value', catName);
            document.getElementById('categorySelect')?.setAttribute('value', catName);
            document.getElementById('categoryView')?.setAttribute('value', catName);
            document.getElementById('champId')?.setAttribute('value', champId);
            
            showAlert(`Categor√≠a "${catName}" seleccionada`, 'success');
        }
        
        // Asegurar que updateForm est√© disponible globalmente
        window.updateForm = function() {
            const action = document.getElementById('actionSelect').value;
            const formDiv = document.getElementById('dynamicForm');
            let html = '';
            
            // Obtener IDs de campeonatos disponibles
            const champIds = Object.keys(championshipsData);
            const champOptions = champIds.length > 0 
                ? champIds.map(id => `<option value="${id}">${championshipsData[id].name || id}</option>`).join('')
                : '<option value="">No hay campeonatos</option>';
            
            switch(action) {
                case 'createChamp':
                    html = `
                        <div class="help-text" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">
                            <strong>üìù Crear un Nuevo Campeonato</strong>
                            Complete todos los campos a continuaci√≥n. Todos los campos son obligatorios.
                        </div>
                        <div class="form-group">
                            <label>üîë C√≥digo del Campeonato (ID):</label>
                            <input type="text" id="champId" placeholder="champ1" value="champ${champIds.length + 1}" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Ingrese un c√≥digo √∫nico para identificar este campeonato (por ejemplo: champ1, torneo2024)</div>
                        </div>
                        <div class="form-group">
                            <label>üìõ Nombre del Campeonato:</label>
                            <input type="text" id="name" placeholder="Campeonato 2024" value="Campeonato ${new Date().getFullYear()}" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Escriba el nombre completo del campeonato (por ejemplo: "Campeonato de B√°squetbol 2024")</div>
                        </div>
                        <div class="form-group">
                            <label>üîÑ N√∫mero de Vueltas:</label>
                            <input type="number" id="rounds" value="2" min="1" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Ingrese cu√°ntas vueltas tendr√° el campeonato. Normalmente son 2 vueltas (ida y vuelta).</div>
                        </div>
                        <div class="form-group">
                            <label>‚≠ê Puntos por Victoria:</label>
                            <input type="number" id="pointsWin" value="2" min="0" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Cuantos puntos gana un equipo cuando gana un partido (normalmente 2 puntos)</div>
                        </div>
                        <div class="form-group">
                            <label>üìâ Puntos por Derrota:</label>
                            <input type="number" id="pointsLoss" value="0" min="0" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Cuantos puntos gana un equipo cuando pierde un partido (normalmente 0 puntos)</div>
                        </div>
                    `;
                    // Actualizar texto de ayuda
                    document.getElementById('helpText').textContent = 'Complete todos los campos del formulario y luego haga clic en "Crear Ahora" para crear el campeonato.';
                    break;
                case 'addCategory':
                    html = `
                        <div class="help-text" style="background: #fff3cd; border-left-color: #ffc107; color: #856404;">
                            <strong>üìÅ Agregar una Categor√≠a</strong>
                            Primero seleccione el campeonato al que desea agregar la categor√≠a, luego complete los datos de la categor√≠a.
                        </div>
                        <div class="form-group">
                            <label>üèÜ Seleccione el Campeonato:</label>
                            <select id="champIdSelect" onchange="loadCategoryTeams()" style="font-size: 1.1em; padding: 18px;">
                                ${champOptions}
                            </select>
                            <div class="field-help">Elija el campeonato al que desea agregar esta categor√≠a</div>
                        </div>
                        <div class="form-group">
                            <label>üìõ Nombre de la Categor√≠a:</label>
                            <input type="text" id="categoryName" placeholder="TC" list="categorySuggestions" style="font-size: 1.1em; padding: 18px;">
                            <datalist id="categorySuggestions">
                                <option value="TC">
                                <option value="Senior">
                                <option value="Super Senior">
                            </datalist>
                            <div class="field-help">Escriba el nombre de la categor√≠a (por ejemplo: TC, Senior, Super Senior)</div>
                        </div>
                        <div class="form-group">
                            <label>üë• Nombres de los Equipos (separados por comas):</label>
                            <input type="text" id="teams" placeholder="Equipo A, Equipo B, Equipo C" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Escriba los nombres de los equipos separados por comas. Ejemplo: "Los Leones, Los Tigres, Los Osos"</div>
                        </div>
                        <div class="form-group">
                            <label>üî¢ O ingrese el n√∫mero de equipos (se crear√°n nombres autom√°ticos):</label>
                            <input type="number" id="numTeams" placeholder="4" min="2" style="font-size: 1.1em; padding: 18px;">
                            <div class="field-help">Si prefiere, puede ingresar solo el n√∫mero de equipos y se crear√°n nombres autom√°ticos (Equipo 1, Equipo 2, etc.)</div>
                        </div>
                    `;
                    // Actualizar texto de ayuda
                    document.getElementById('helpText').textContent = 'Seleccione el campeonato y complete los datos de la categor√≠a. Puede ingresar los nombres de los equipos o solo el n√∫mero de equipos.';
                    break;
            }
            
            formDiv.innerHTML = html;
        }
        
        function loadCategoryTeams() {
            const champId = document.getElementById('champIdSelect')?.value;
            if (!champId || !championshipsData[champId]) return;
            
            const categories = categoriesData[champId] || {};
            const categorySelect = document.getElementById('categorySelect');
            
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                    Object.keys(categories).map(cat => 
                        `<option value="${cat}">${cat}</option>`
                    ).join('');
                
                categorySelect.onchange = loadTeams;
            }
            
            loadTeams();
        }
        
        function loadTeams() {
            const champId = document.getElementById('champIdSelect')?.value;
            const category = document.getElementById('categorySelect')?.value;
            
            if (!champId || !category || !categoriesData[champId] || !categoriesData[champId][category]) {
                return;
            }
            
            const teams = categoriesData[champId][category].teams || [];
            const teamOptions = teams.map(team => 
                `<option value="${team.name || team}">${team.name || team}</option>`
            ).join('');
            
            ['teamA', 'teamB', 'teamSelect'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Selecciona equipo</option>' + teamOptions;
                }
            });
        }
        
        // Asegurar que executeAction est√© disponible globalmente
        window.executeAction = async function() {
            try {
                const actionSelect = document.getElementById('actionSelect');
                if (!actionSelect) {
                    showAlert('Error: No se encontr√≥ el selector de acci√≥n. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
                
                const action = actionSelect.value;
                const responseDiv = document.getElementById('response');
                const responseCard = document.getElementById('responseCard');
                
                if (!responseDiv || !responseCard) {
                    showAlert('Error: No se encontraron los elementos de respuesta. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
                
                responseCard.style.display = 'block';
                responseDiv.innerHTML = '<pre>Cargando...</pre>';
                
                let url = '';
                let options = {};
                switch(action) {
                    case 'createChamp':
                        url = `${API_BASE}/api/championships`;
                        options = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                id: document.getElementById('champId').value,
                                name: document.getElementById('name').value,
                                rounds: parseInt(document.getElementById('rounds').value),
                                points_per_win: parseInt(document.getElementById('pointsWin').value),
                                points_per_loss: parseInt(document.getElementById('pointsLoss').value)
                            })
                        };
                        break;
                    case 'addCategory':
                        const champId = document.getElementById('champIdSelect')?.value;
                        
                        if (!champId) {
                            showAlert('‚ùå Debe seleccionar un campeonato antes de continuar', 'error');
                            responseDiv.innerHTML = '<div style="color: red; padding: 20px;"><strong>Error:</strong> No se seleccion√≥ ning√∫n campeonato. Por favor, selecciona un campeonato de la lista.</div>';
                            return;
                        }
                        
                        const categoryName = document.getElementById('categoryName')?.value?.trim();
                        if (!categoryName || categoryName.length < 2) {
                            showAlert('‚ùå Debe escribir el nombre de la categor√≠a (m√≠nimo 2 caracteres). Ejemplo: TC, Senior, Super Senior', 'error');
                            responseDiv.innerHTML = '<div style="color: red; padding: 20px;"><strong>Error:</strong> El nombre de la categor√≠a es obligatorio y debe tener al menos 2 caracteres.</div>';
                            return;
                        }
                        
                        url = `${API_BASE}/api/championships/${champId}/categories`;
                        const teamsInput = document.getElementById('teams')?.value?.trim() || '';
                        const numTeamsInput = document.getElementById('numTeams')?.value?.trim() || '';
                        const numTeams = numTeamsInput ? parseInt(numTeamsInput) : 0;
                        
                        const body = {
                            name: categoryName
                        };
                        
                        // Validar y procesar equipos
                        if (teamsInput && teamsInput.length > 0) {
                            const teams = teamsInput.split(',').map(t => t.trim()).filter(t => t.length > 0);
                            if (teams.length >= 2) {
                                body.teams = teams;
                            } else {
                                showAlert('‚ùå Debe ingresar al menos 2 equipos. Escriba los nombres separados por comas. Ejemplo: "Equipo A, Equipo B, Equipo C"', 'error');
                                responseDiv.innerHTML = `<div style="color: red; padding: 20px;">
                                    <strong>Error:</strong> Se necesitan al menos 2 equipos para crear una categor√≠a.<br>
                                    <strong>Ingresaste:</strong> ${teams.length} equipo(s)<br>
                                    <strong>Ejemplo correcto:</strong> "Equipo A, Equipo B, Equipo C"
                                </div>`;
                                return;
                            }
                        } else if (numTeams >= 2 && numTeams <= 20) {
                            body.num_teams = numTeams;
                        } else {
                            showAlert('‚ùå Debe ingresar los nombres de los equipos (separados por comas) O el n√∫mero de equipos (entre 2 y 20)', 'error');
                            responseDiv.innerHTML = `<div style="color: red; padding: 20px;">
                                <strong>Error:</strong> Debes proporcionar una de estas opciones:<br><br>
                                <strong>Opci√≥n 1:</strong> Escribe los nombres de los equipos separados por comas<br>
                                &nbsp;&nbsp;&nbsp;&nbsp;Ejemplo: "Los Leones, Los Tigres, Los Osos"<br><br>
                                <strong>Opci√≥n 2:</strong> Escribe el n√∫mero de equipos (entre 2 y 20)<br>
                                &nbsp;&nbsp;&nbsp;&nbsp;Ejemplo: 4 (se crear√°n nombres autom√°ticos)
                            </div>`;
                            return;
                        }
                        
                        // Mostrar indicador de carga
                        responseDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 2em; margin-bottom: 20px;">‚è≥</div><div style="font-size: 1.2em;">Creando categor√≠a...</div></div>';
                        
                        options = {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(body)
                        };
                        break;
                }
                
                const res = await fetch(url, options);
                const data = await res.json();
                
                // Mostrar respuesta detallada para debugging
                console.log('Respuesta del servidor:', data);
                responseDiv.innerHTML = `<pre style="background: #f8f9fa; padding: 15px; border-radius: 8px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                
                if (data.success) {
                    if (action === 'createChamp') {
                        responseDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 4em; margin-bottom: 20px;">‚úÖ</div>
                                <div style="font-size: 1.5em; color: #28a745; font-weight: bold; margin-bottom: 10px;">¬°Campeonato Creado!</div>
                                <div style="font-size: 1.2em; color: #666; margin-bottom: 20px;">${data.championship.name}</div>
                                <div style="font-size: 1em; color: #999;">Ahora puedes agregar categor√≠as</div>
                            </div>
                        `;
                        showAlert('¬°Campeonato creado exitosamente!', 'success');
                    } else if (action === 'addCategory') {
                        responseDiv.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 4em; margin-bottom: 20px;">‚úÖ</div>
                                <div style="font-size: 1.5em; color: #28a745; font-weight: bold; margin-bottom: 10px;">¬°Categor√≠a Agregada!</div>
                                <div style="font-size: 1.2em; color: #666; margin-bottom: 20px;">${data.category.name || 'Categor√≠a'}</div>
                                <div style="font-size: 1em; color: #999;">El calendario se ha generado autom√°ticamente</div>
                            </div>
                        `;
                        showAlert('¬°Categor√≠a agregada exitosamente! El calendario de partidos se ha generado autom√°ticamente.', 'success');
                    } else {
                        showAlert('Operaci√≥n completada exitosamente', 'success');
                    }
                    // Guardar en localStorage si se cre√≥ un campeonato
                    if (action === 'createChamp' && data.id) {
                        const champId = data.id;
                        setTimeout(async () => {
                            try {
                                const champRes = await fetch(`${API_BASE}/api/championships/${champId}`);
                                const champData = await champRes.json();
                                if (champData.success) {
                                    saveToLocalStorage(champId, {
                                        name: champData.championship.name,
                                        rounds: champData.championship.rounds,
                                        points_per_win: champData.championship.points_per_win,
                                        points_per_loss: champData.championship.points_per_loss,
                                        categories: champData.championship.categories || {}
                                    });
                                }
                            } catch (error) {
                                console.error('Error guardando en localStorage:', error);
                            }
                        }, 500);
                    }
                    // Recargar datos despu√©s de crear/modificar
                    if (action === 'createChamp' || action === 'addCategory') {
                        // Recargar datos inmediatamente y luego de nuevo despu√©s de un segundo
                        showAlert('üîÑ Actualizando lista de campeonatos...', 'info');
                        loadData();
                        setTimeout(() => {
                            loadData();
                            renderChampionships();
                            renderCategories();
                            updateForm(); // Actualizar formularios con nuevos datos
                            showAlert('‚úÖ Lista actualizada. Los campeonatos se guardan en MongoDB y aparecen en "üìä Datos Creados"', 'success');
                        }, 1500);
                    }
                } else {
                    // Mostrar error detallado
                    const errorMessage = data.error || 'Ocurri√≥ un error desconocido';
                    const errorDetails = data.errors ? data.errors.join(', ') : '';
                    
                    responseDiv.innerHTML = `
                        <div style="background: #fee; border: 2px solid #fcc; border-radius: 10px; padding: 20px; color: #c33;">
                            <h3 style="color: #c33; margin-bottom: 15px;">‚ùå Error al ${action === 'addCategory' ? 'agregar categor√≠a' : 'crear campeonato'}</h3>
                            <p style="font-size: 1.1em; margin-bottom: 10px;"><strong>${errorMessage}</strong></p>
                            ${errorDetails ? `<p style="margin-top: 10px; color: #a00;">Detalles: ${errorDetails}</p>` : ''}
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #fcc;">
                                <strong>¬øQu√© hacer?</strong>
                                <ul style="margin-top: 10px; padding-left: 20px;">
                                    <li>Verifica que todos los campos est√©n completos</li>
                                    <li>Verifica que el nombre de la categor√≠a no est√© duplicado</li>
                                    <li>Verifica que hayas ingresado al menos 2 equipos</li>
                                    <li>Intenta nuevamente</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    showAlert(errorMessage + (errorDetails ? ': ' + errorDetails : ''), 'error');
                }
            } catch (error) {
                if (responseDiv) {
                    responseDiv.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
                }
                showAlert('Error de conexi√≥n', 'error');
            }
        };
        
        // Asegurar que loadView est√© disponible globalmente
        window.loadView = function() {
            const view = document.getElementById('viewSelect').value;
            const formDiv = document.getElementById('viewForm');
            const champIds = Object.keys(championshipsData);
            const champOptions = champIds.map(id => `<option value="${id}">${championshipsData[id].name || id}</option>`).join('');
            
            let html = `
                <div class="form-group">
                    <label>Campeonato:</label>
                    <select id="champIdView" onchange="loadViewCategories()">
                        ${champOptions}
                    </select>
                </div>
            `;
            
            if (view === 'standings' || view === 'fixture') {
                html += `
                    <div class="form-group">
                        <label>Categor√≠a:</label>
                        <select id="categoryView">
                            <option value="">Selecciona categor√≠a</option>
                        </select>
                    </div>
                `;
                
                if (view === 'fixture') {
                    html += `
                        <div class="form-group">
                            <label>Vuelta (opcional):</label>
                            <input type="number" id="roundView" placeholder="Dejar vac√≠o para todas" min="1">
                        </div>
                    `;
                }
            }
            
            formDiv.innerHTML = html;
            if (champIds.length > 0) {
                setTimeout(() => loadViewCategories(), 100);
            }
        }
        
        function loadViewCategories() {
            const champId = document.getElementById('champIdView')?.value;
            if (!champId) {
                const categoryView = document.getElementById('categoryView');
                if (categoryView) {
                    categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>';
                }
                return;
            }
            
            // Intentar obtener categor√≠as de categoriesData primero
            let categories = [];
            if (categoriesData[champId]) {
                categories = Object.keys(categoriesData[champId]);
            } else if (championshipsData[champId] && championshipsData[champId].categories) {
                // Si no est√° en categoriesData, intentar desde championshipsData
                categories = Object.keys(championshipsData[champId].categories);
                // Actualizar categoriesData para futuras referencias
                categoriesData[champId] = championshipsData[champId].categories;
            } else {
                // Si no hay categor√≠as en memoria, intentar cargar desde el servidor
                fetch(`${API_BASE}/api/championships/${champId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success && data.championship && data.championship.categories) {
                            categories = Object.keys(data.championship.categories);
                            // Actualizar datos en memoria
                            if (!categoriesData[champId]) {
                                categoriesData[champId] = data.championship.categories;
                            }
                            if (!championshipsData[champId]) {
                                championshipsData[champId] = {
                                    name: data.championship.name,
                                    rounds: data.championship.rounds,
                                    points_per_win: data.championship.points_per_win,
                                    points_per_loss: data.championship.points_per_loss,
                                    categories: data.championship.categories
                                };
                            } else {
                                championshipsData[champId].categories = data.championship.categories;
                            }
                            
                            // Actualizar el selector
                            const categoryView = document.getElementById('categoryView');
                            if (categoryView) {
                                categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                            }
                        } else {
                            const categoryView = document.getElementById('categoryView');
                            if (categoryView) {
                                categoryView.innerHTML = '<option value="">No hay categor√≠as</option>';
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error cargando categor√≠as:', error);
                        const categoryView = document.getElementById('categoryView');
                        if (categoryView) {
                            categoryView.innerHTML = '<option value="">Error al cargar categor√≠as</option>';
                        }
                    });
                return; // Salir temprano si estamos cargando desde el servidor
            }
            
            const categoryView = document.getElementById('categoryView');
            if (categoryView) {
                if (categories.length > 0) {
                    categoryView.innerHTML = '<option value="">Selecciona categor√≠a</option>' +
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                } else {
                    categoryView.innerHTML = '<option value="">No hay categor√≠as</option>';
                }
            }
        }
        
        // Asegurar que loadViewData est√© disponible globalmente
        window.loadViewData = async function() {
            try {
                const viewSelect = document.getElementById('viewSelect');
                if (!viewSelect) {
                    showAlert('Error: No se encontr√≥ el selector de vista. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
                
                const view = viewSelect.value;
                const champId = document.getElementById('champIdView')?.value;
                const responseDiv = document.getElementById('response');
                const responseCard = document.getElementById('responseCard');
                
                if (!responseDiv || !responseCard) {
                    showAlert('Error: No se encontraron los elementos de respuesta. Por favor, recargue la p√°gina.', 'error');
                    return;
                }
            
            if (!champId) {
                showAlert('Selecciona un campeonato', 'error');
                return;
            }
            
            responseCard.style.display = 'block';
            responseDiv.innerHTML = '<pre>Cargando...</pre>';
            
            try {
                let url;
                
                if (view === 'standings') {
                    const category = document.getElementById('categoryView').value;
                    if (!category) {
                        showAlert('Selecciona una categor√≠a', 'error');
                        return;
                    }
                    url = `${API_BASE}/api/championships/${champId}/standings/${category}`;
                } else if (view === 'fixture') {
                    const category = document.getElementById('categoryView').value;
                    if (!category) {
                        showAlert('Selecciona una categor√≠a', 'error');
                        return;
                    }
                    const round = document.getElementById('roundView').value;
                    url = `${API_BASE}/api/championships/${champId}/fixture/${category}`;
                    if (round) url += `?round=${round}`;
                    window.currentCategory = category; // Guardar para usar en renderFixture
                } else {
                    showAlert('Selecciona una opci√≥n v√°lida', 'error');
                    return;
                }
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (!data.success) {
                    showAlert(data.error || 'Error', 'error');
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    return;
                }
                
                // Renderizar seg√∫n el tipo de vista
                if (view === 'fixture' && data.matches) {
                    const category = document.getElementById('categoryView').value;
                    responseDiv.innerHTML = renderFixture(data.matches, category || 'Categor√≠a');
                } else if (view === 'standings' && data.standings) {
                    window.currentStandings = data.standings; // Guardar para usar en estad√≠sticas
                    responseDiv.innerHTML = renderStandings(data.standings);
                } else {
                    responseDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            } catch (error) {
                console.error('Error en loadViewData (interno):', error);
                if (responseDiv) {
                    responseDiv.innerHTML = `<pre style="color: red;">Error: ${error.message}</pre>`;
                }
                showAlert('Error de conexi√≥n: ' + error.message, 'error');
            }
            } catch (error) {
                console.error('Error cr√≠tico en loadViewData:', error);
                showAlert('Error cr√≠tico: ' + error.message, 'error');
            }
        };
        
        function renderFixture(matches, categoryName) {
            if (!matches || matches.length === 0) {
                return '<div class="empty-state">No hay partidos en el fixture</div>';
            }
            
            // Agrupar partidos por tipo (ida/vuelta) y luego por jornada
            const matchesByVuelta = {
                'ida': {},
                'vuelta': {}
            };
            
            matches.forEach(match => {
                const matchType = match.match_type || 'ida';
                const matchday = match.matchday || 1;
                
                if (!matchesByVuelta[matchType]) {
                    matchesByVuelta[matchType] = {};
                }
                if (!matchesByVuelta[matchType][matchday]) {
                    matchesByVuelta[matchType][matchday] = [];
                }
                matchesByVuelta[matchType][matchday].push(match);
            });
            
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            // Calcular total de partidos
            const totalPartidos = matches.length;
            const partidosJugados = matches.filter(m => m.played).length;
            const partidosPendientes = totalPartidos - partidosJugados;
            
            let html = `<div class="fixture-container" style="padding: 25px; font-size: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h3 class="fixture-title" style="color: #667eea; margin: 0; font-size: 2em; font-weight: 700;">üìÖ Fixture - ${categoryName}</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="fixtureSearchTeam" placeholder="üîç Buscar equipo..." 
                               style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em; min-width: 200px;"
                               onkeyup="filterFixtureMatches()">
                        <select id="fixtureFilterStatus" onchange="filterFixtureMatches()"
                                style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;">
                            <option value="">Todos los estados</option>
                            <option value="played">Solo jugados</option>
                            <option value="pending">Solo pendientes</option>
                        </select>
                        <input type="date" id="fixtureFilterDate" onchange="filterFixtureMatches()"
                               style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 1em;">
                    </div>
                </div>
                <div class="fixture-stats" style="background: linear-gradient(135deg, #f0f8ff 0%, #e0e8f0 100%); padding: 25px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <div style="text-align: center;">
                        <div class="fixture-stat-number" style="font-size: 3.5em; font-weight: bold; color: #667eea; margin-bottom: 8px;">${totalPartidos}</div>
                        <div class="fixture-stat-label" style="font-size: 1.2em; color: #666; font-weight: 600;">Total Partidos</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="fixture-stat-number" style="font-size: 3.5em; font-weight: bold; color: #28a745; margin-bottom: 8px;">${partidosJugados}</div>
                        <div class="fixture-stat-label" style="font-size: 1.2em; color: #666; font-weight: 600;">Jugados</div>
                    </div>
                    <div style="text-align: center;">
                        <div class="fixture-stat-number" style="font-size: 3.5em; font-weight: bold; color: #dc3545; margin-bottom: 8px;">${partidosPendientes}</div>
                        <div class="fixture-stat-label" style="font-size: 1.2em; color: #666; font-weight: 600;">Pendientes</div>
                    </div>
                </div>
            `;
            
            // Mostrar Vuelta 1 (ida) y Vuelta 2 (vuelta)
            const vueltaOrder = ['ida', 'vuelta'];
            
            vueltaOrder.forEach((matchType, index) => {
                const vueltaNum = index + 1;
                const vueltaMatches = matchesByVuelta[matchType];
                
                if (!vueltaMatches || Object.keys(vueltaMatches).length === 0) {
                    return; // Saltar si no hay partidos de este tipo
                }
                
                html += `
                    <div class="fixture-vuelta" style="margin-bottom: 40px; border: 3px solid #e0e0e0; border-radius: 20px; padding: 25px; background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%); box-shadow: 0 6px 20px rgba(0,0,0,0.1);">
                        <h4 class="fixture-vuelta-title" style="color: #667eea; margin-bottom: 25px; font-size: 1.8em; font-weight: 700; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span>Vuelta ${vueltaNum}</span>
                            <span style="font-size: 0.6em; color: #999; font-weight: normal; background: #e9ecef; padding: 6px 12px; border-radius: 10px;">(${matchType})</span>
                        </h4>
                `;
                
                // Ordenar jornadas
                const matchdays = Object.keys(vueltaMatches).sort((a, b) => parseInt(a) - parseInt(b));
                
                // Mostrar jornadas (exactamente 2 partidos por jornada)
                matchdays.forEach(matchday => {
                    const jornadaMatches = vueltaMatches[matchday];
                    
                    // Verificar que solo haya m√°ximo 2 partidos por jornada
                    if (jornadaMatches.length > 2) {
                        console.warn(`Jornada ${matchday} tiene m√°s de 2 partidos: ${jornadaMatches.length}`);
                    }
                    
                    html += `
                        <div class="fixture-jornada" style="margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #fdfdfd 0%, #f0f0f0 100%); border-radius: 15px; border-left: 6px solid #667eea; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                            <h5 class="fixture-jornada-title" style="color: #667eea; margin-bottom: 20px; font-size: 1.5em; font-weight: 700; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                <span>Jornada ${matchday}</span>
                                <span style="font-size: 0.6em; color: #999; font-weight: normal; background: #e9ecef; padding: 4px 10px; border-radius: 8px;">(${jornadaMatches.length} partido${jornadaMatches.length > 1 ? 's' : ''})</span>
                            </h5>
                            <div style="display: grid; gap: 20px;">
                    `;
                    
                    // Mostrar solo los primeros 2 partidos de la jornada
                    jornadaMatches.slice(0, 2).forEach((match, idx) => {
                        const matchId = `match_${vueltaNum}_${matchType}_${matchday}_${idx}`;
                        const played = match.played;
                        const scoreA = match.score_a !== null ? match.score_a : '';
                        const scoreB = match.score_b !== null ? match.score_b : '';
                        const date = match.date || '';
                        const time = match.time || '';
                        
                        html += `
                            <div class="fixture-match" style="padding: 25px; background: white; border-radius: 12px; border-left: 6px solid ${played ? '#28a745' : '#667eea'}; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                                <div class="fixture-match-teams" style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: center; margin-bottom: 20px;">
                                    <div style="text-align: right;">
                                        <strong style="font-size: 1.3em; color: #1e3c72; font-weight: 700; word-break: break-word;">${match.team_a}</strong>
                                    </div>
                                    <div class="fixture-match-scores" style="display: flex; gap: 15px; align-items: center; justify-content: center;">
                                        <input type="number" id="${matchId}_scoreA" value="${scoreA}" 
                                            placeholder="0" min="0" 
                                            class="fixture-score-input"
                                            style="width: 90px; padding: 15px; text-align: center; border: 3px solid #e0e0e0; border-radius: 10px; font-size: 1.3em; font-weight: 700;"
                                            ${played ? 'readonly' : ''}>
                                        <span style="font-weight: bold; color: #666; font-size: 1.5em;">-</span>
                                        <input type="number" id="${matchId}_scoreB" value="${scoreB}" 
                                            placeholder="0" min="0" 
                                            class="fixture-score-input"
                                            style="width: 90px; padding: 15px; text-align: center; border: 3px solid #e0e0e0; border-radius: 10px; font-size: 1.3em; font-weight: 700;"
                                            ${played ? 'readonly' : ''}>
                                    </div>
                                    <div style="text-align: left;">
                                        <strong style="font-size: 1.3em; color: #1e3c72; font-weight: 700; word-break: break-word;">${match.team_b}</strong>
                                    </div>
                                </div>
                                
                                <div class="fixture-match-actions" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: center;">
                                    <div>
                                        <label style="font-size: 1em; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Fecha:</label>
                                        <input type="date" id="${matchId}_date" value="${date}" 
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <div>
                                        <label style="font-size: 1em; color: #666; display: block; margin-bottom: 8px; font-weight: 600;">Horario:</label>
                                        <input type="time" id="${matchId}_time" value="${time}" 
                                            style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                    </div>
                                    <div>
                                        <button onclick="saveMatch('${champId}', '${category}', '${match.team_a}', '${match.team_b}', ${match.round_number}, ${match.matchday}, '${matchId}')" 
                                            class="fixture-action-button"
                                            style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; white-space: nowrap; font-size: 1em; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                            ${played ? 'Actualizar' : 'Guardar'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            });
            
            html += `</div>`;
            return html;
        }
        
        async function saveMatch(champId, category, teamA, teamB, roundNumber, matchday, matchId) {
            const scoreA = parseInt(document.getElementById(`${matchId}_scoreA`).value) || 0;
            const scoreB = parseInt(document.getElementById(`${matchId}_scoreB`).value) || 0;
            const date = document.getElementById(`${matchId}_date`).value;
            const time = document.getElementById(`${matchId}_time`).value;
            
            try {
                // Guardar fecha y horario
                if (date || time) {
                    const scheduleRes = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}/schedule`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team_a: teamA,
                            team_b: teamB,
                            round_number: roundNumber,
                            matchday: matchday,
                            date: date,
                            time: time
                        })
                    });
                    
                    if (!scheduleRes.ok) {
                        const error = await scheduleRes.json();
                        showAlert(error.error || 'Error al guardar fecha/horario', 'error');
                    }
                }
                
                // Guardar resultado si hay scores
                if (scoreA >= 0 && scoreB >= 0) {
                    const resultRes = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}/result`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            team_a: teamA,
                            team_b: teamB,
                            round_number: roundNumber,
                            matchday: matchday,
                            score_a: scoreA,
                            score_b: scoreB
                        })
                    });
                    
                    const resultData = await resultRes.json();
                    if (resultData.success) {
                        showAlert('Partido guardado exitosamente', 'success');
                        // Recargar vista
                        setTimeout(() => loadViewData(), 1000);
                    } else {
                        showAlert(resultData.error || 'Error al guardar resultado', 'error');
                    }
                } else if (date || time) {
                    showAlert('Fecha y horario guardados', 'success');
                    setTimeout(() => loadViewData(), 1000);
                } else {
                    showAlert('Ingresa al menos fecha/horario o resultado', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function renderStandings(standings) {
            if (!standings || standings.length === 0) {
                return '<div class="empty-state">No hay datos en la tabla de posiciones</div>';
            }
            
            let html = `
                <div style="padding: 10px; overflow-x: auto;">
                    <h3 style="color: #667eea; margin-bottom: 20px;">üìä Tabla de Posiciones</h3>
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #667eea; color: white;">
                                <th style="padding: 12px; text-align: left;">Pos</th>
                                <th style="padding: 12px; text-align: left;">Equipo</th>
                                <th style="padding: 12px; text-align: center;">PJ</th>
                                <th style="padding: 12px; text-align: center;">PG</th>
                                <th style="padding: 12px; text-align: center;">PP</th>
                                <th style="padding: 12px; text-align: center;">PF</th>
                                <th style="padding: 12px; text-align: center;">PC</th>
                                <th style="padding: 12px; text-align: center;">Dif</th>
                                <th style="padding: 12px; text-align: center; font-weight: bold;">Pts</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            const champId = document.getElementById('champIdView')?.value || '';
            const category = document.getElementById('categoryView')?.value || '';
            
            standings.forEach((team, index) => {
                const position = index + 1;
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : '';
                const rowColor = position <= 3 ? '#f0f8ff' : index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                
                html += `
                    <tr style="background: ${rowColor};">
                        <td style="padding: 12px; font-weight: bold; color: #667eea;">${position} ${medal}</td>
                        <td style="padding: 12px; font-weight: 600;">${team.name}</td>
                        <td style="padding: 12px; text-align: center;">${team.pj || 0}</td>
                        <td style="padding: 12px; text-align: center; color: #28a745;">${team.pg || 0}</td>
                        <td style="padding: 12px; text-align: center; color: #dc3545;">${team.pp || 0}</td>
                        <td style="padding: 12px; text-align: center;">${team.pf || 0}</td>
                        <td style="padding: 12px; text-align: center;">${team.pc || 0}</td>
                        <td style="padding: 12px; text-align: center; color: ${team.difference >= 0 ? '#28a745' : '#dc3545'};">${team.difference || 0}</td>
                        <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea; font-size: 1.1em;">${team.points || 0}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="showTeamStats('${champId}', '${category}', '${team.name.replace(/'/g, "\\'")}')" 
                                    style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                üìà Stats
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            
            // Agregar iconos seg√∫n el tipo
            let icon = '';
            if (type === 'success') icon = '‚úÖ ';
            else if (type === 'error') icon = '‚ùå ';
            else if (type === 'warning') icon = '‚ö†Ô∏è ';
            else icon = '‚ÑπÔ∏è ';
            
            alert.innerHTML = `<strong>${icon}</strong>${message}`;
            alert.style.position = 'fixed';
            alert.style.top = '30px';
            alert.style.right = '30px';
            alert.style.zIndex = '10000';
            alert.style.minWidth = '400px';
            alert.style.maxWidth = '600px';
            alert.style.boxShadow = '0 8px 25px rgba(0,0,0,0.3)';
            alert.style.fontSize = '1.2em';
            alert.style.padding = '25px';
            document.body.appendChild(alert);
            
            // Scroll suave hacia la alerta
            alert.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s';
                setTimeout(() => alert.remove(), 500);
            }, 5000); // Mostrar por m√°s tiempo (5 segundos)
        }
        
        function updateExportSelect() {
            const select = document.getElementById('exportChampSelect');
            if (!select) return;
            
            const champIds = Object.keys(championshipsData);
            select.innerHTML = '<option value="">Selecciona campeonato</option>' +
                champIds.map(id => 
                    `<option value="${id}">${championshipsData[id].name || id}</option>`
                ).join('');
        }
        
        async function saveChampionship() {
            const champId = document.getElementById('exportChampSelect').value;
            if (!champId) {
                showAlert('Selecciona un campeonato', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}`);
                const data = await res.json();
                
                if (data.success) {
                    const jsonData = JSON.stringify(data.championship, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `campeonato_${champId}_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showAlert('Campeonato guardado exitosamente', 'success');
                } else {
                    showAlert('Error al obtener el campeonato', 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function loadChampionship() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Crear campeonato desde JSON
                    const res = await fetch(`${API_BASE}/api/championships`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: data.name?.toLowerCase().replace(/\s+/g, '_') + '_imported',
                            name: data.name,
                            rounds: data.rounds,
                            points_per_win: data.points_per_win,
                            points_per_loss: data.points_per_loss
                        })
                    });
                    
                    const result = await res.json();
                    if (result.success) {
                        // Agregar categor√≠as
                        for (const [catName, category] of Object.entries(data.categories || {})) {
                            const teams = category.teams?.map(t => t.name || t) || [];
                            await fetch(`${API_BASE}/api/championships/${result.id}/categories`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    name: catName,
                                    teams: teams
                                })
                            });
                        }
                        
                        showAlert('Campeonato cargado exitosamente', 'success');
                        setTimeout(() => loadData(), 1000);
                    }
                } catch (error) {
                    showAlert('Error al cargar: ' + error.message, 'error');
                }
            };
            input.click();
        }
        
        async function exportFixture(format = 'pdf') {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a en la vista de Fixture', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}/fixture/${category}`);
                const data = await res.json();
                
                if (data.success) {
                    if (format === 'csv') {
                        exportFixtureToCSV(data.matches, category, champId);
                    } else {
                        const html = generateFixtureHTML(data.matches, category, champId);
                        printHTML(html, `Fixture_${category}_${champId}`);
                    }
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        async function exportStandings(format = 'pdf') {
            const champId = document.getElementById('champIdView')?.value;
            const category = document.getElementById('categoryView')?.value;
            
            if (!champId || !category) {
                showAlert('Primero selecciona campeonato y categor√≠a en la vista de Tabla de Posiciones', 'error');
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/championships/${champId}/standings/${category}`);
                const data = await res.json();
                
                if (data.success) {
                    if (format === 'csv') {
                        exportStandingsToCSV(data.standings, category, champId);
                    } else {
                        const html = generateStandingsHTML(data.standings, category, champId);
                        printHTML(html, `Tabla_Posiciones_${category}_${champId}`);
                    }
                }
            } catch (error) {
                showAlert('Error: ' + error.message, 'error');
            }
        }
        
        function exportFixtureToCSV(matches, categoryName, champId) {
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Encabezados CSV
            let csv = `Fixture - ${categoryName} - ${champName}\n`;
            csv += `Fecha de exportaci√≥n: ${new Date().toLocaleDateString('es-ES')}\n\n`;
            csv += `Vuelta,Tipo,Jornada,Fecha,Hora,Local,Visitante,Marcador Local,Marcador Visitante,Ganador,Estado\n`;
            
            // Agrupar por vuelta y jornada
            const matchesByVuelta = { 'ida': {}, 'vuelta': {} };
            matches.forEach(match => {
                const matchType = match.match_type || 'ida';
                const matchday = match.matchday || 1;
                if (!matchesByVuelta[matchType][matchday]) {
                    matchesByVuelta[matchType][matchday] = [];
                }
                matchesByVuelta[matchType][matchday].push(match);
            });
            
            // Agregar partidos
            ['ida', 'vuelta'].forEach(matchType => {
                const vueltaNum = matchType === 'ida' ? 1 : 2;
                const vueltaMatches = matchesByVuelta[matchType];
                const matchdays = Object.keys(vueltaMatches).sort((a, b) => parseInt(a) - parseInt(b));
                
                matchdays.forEach(matchday => {
                    vueltaMatches[matchday].forEach(match => {
                        const fecha = match.date || 'Por definir';
                        const hora = match.time || 'Por definir';
                        const estado = match.played ? 'Jugado' : 'Pendiente';
                        const marcadorLocal = match.played ? (match.score_a || '') : '';
                        const marcadorVisitante = match.played ? (match.score_b || '') : '';
                        const ganador = match.played ? (match.winner || 'Empate') : '';
                        
                        csv += `${vueltaNum},${matchType},${matchday},${fecha},${hora},${match.team_a},${match.team_b},${marcadorLocal},${marcadorVisitante},${ganador},${estado}\n`;
                    });
                });
            });
            
            // Descargar CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Fixture_${categoryName}_${champId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('Fixture exportado a CSV exitosamente', 'success');
        }
        
        function exportStandingsToCSV(standings, categoryName, champId) {
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Encabezados CSV
            let csv = `Tabla de Posiciones - ${categoryName} - ${champName}\n`;
            csv += `Fecha de exportaci√≥n: ${new Date().toLocaleDateString('es-ES')}\n\n`;
            csv += `Posici√≥n,Equipo,PJ,PG,PP,PF,PC,Diferencia,Puntos\n`;
            
            // Agregar equipos
            standings.forEach((team, index) => {
                const pos = index + 1;
                csv += `${pos},${team.name},${team.pj || 0},${team.pg || 0},${team.pp || 0},${team.pf || 0},${team.pc || 0},${team.difference || 0},${team.points || 0}\n`;
            });
            
            // Descargar CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `Tabla_Posiciones_${categoryName}_${champId}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('Tabla de posiciones exportada a CSV exitosamente', 'success');
        }
        
        function generateFixtureHTML(matches, categoryName, champId) {
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            // Agrupar por vuelta y jornada
            const matchesByVuelta = { 'ida': {}, 'vuelta': {} };
            matches.forEach(match => {
                const matchType = match.match_type || 'ida';
                const matchday = match.matchday || 1;
                if (!matchesByVuelta[matchType][matchday]) {
                    matchesByVuelta[matchType][matchday] = [];
                }
                matchesByVuelta[matchType][matchday].push(match);
            });
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Fixture - ${categoryName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; }
                        .vuelta { margin-bottom: 30px; page-break-inside: avoid; }
                        .jornada { margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; }
                        .match { padding: 10px; border-bottom: 1px solid #eee; }
                        .match:last-child { border-bottom: none; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üìÖ Fixture - ${categoryName}</h1>
                    <p><strong>Campeonato:</strong> ${champName}</p>
                    <p><strong>Total Partidos:</strong> ${matches.length}</p>
                    <hr>
            `;
            
            ['ida', 'vuelta'].forEach((matchType, index) => {
                const vueltaNum = index + 1;
                const vueltaMatches = matchesByVuelta[matchType];
                if (!vueltaMatches || Object.keys(vueltaMatches).length === 0) return;
                
                html += `<div class="vuelta"><h2>Vuelta ${vueltaNum} (${matchType})</h2>`;
                
                Object.keys(vueltaMatches).sort((a, b) => parseInt(a) - parseInt(b)).forEach(matchday => {
                    const jornadaMatches = vueltaMatches[matchday];
                    html += `<div class="jornada"><h3>Vuelta ${vueltaNum}, Jornada ${matchday}</h3>`;
                    
                    jornadaMatches.slice(0, 2).forEach(match => {
                        const scoreA = match.score_a !== null ? match.score_a : '-';
                        const scoreB = match.score_b !== null ? match.score_b : '-';
                        const date = match.date || 'Por definir';
                        const time = match.time || 'Por definir';
                        const status = match.played ? '‚úì Jugado' : 'Pendiente';
                        
                        html += `
                            <div class="match">
                                <strong>${match.team_a}</strong> ${scoreA} - ${scoreB} <strong>${match.team_b}</strong><br>
                                <small>Fecha: ${date} | Horario: ${time} | ${status}</small>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            });
            
            html += `
                    <hr>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        Generado el ${new Date().toLocaleDateString('es-ES')}
                    </p>
                </body>
                </html>
            `;
            
            return html;
        }
        
        function generateStandingsHTML(standings, categoryName, champId) {
            const champ = championshipsData[champId];
            const champName = champ?.name || champId;
            
            let html = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Tabla de Posiciones - ${categoryName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th { background: #667eea; color: white; padding: 12px; text-align: left; }
                        td { padding: 10px; border-bottom: 1px solid #ddd; }
                        tr:nth-child(even) { background: #f8f9fa; }
                        .pos-1, .pos-2, .pos-3 { font-weight: bold; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1>üìä Tabla de Posiciones - ${categoryName}</h1>
                    <p><strong>Campeonato:</strong> ${champName}</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Equipo</th>
                                <th>PJ</th>
                                <th>PG</th>
                                <th>PP</th>
                                <th>PF</th>
                                <th>PC</th>
                                <th>Dif</th>
                                <th>Pts</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            standings.forEach((team, index) => {
                const pos = index + 1;
                html += `
                    <tr class="pos-${pos <= 3 ? pos : ''}">
                        <td>${pos}</td>
                        <td><strong>${team.name}</strong></td>
                        <td>${team.pj || 0}</td>
                        <td>${team.pg || 0}</td>
                        <td>${team.pp || 0}</td>
                        <td>${team.pf || 0}</td>
                        <td>${team.pc || 0}</td>
                        <td>${team.difference || 0}</td>
                        <td><strong>${team.points || 0}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    <hr>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        Generado el ${new Date().toLocaleDateString('es-ES')}
                    </p>
                </body>
                </html>
            `;
            
            return html;
        }
        
        function printHTML(html, filename) {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.focus();
            
            // Esperar a que cargue y luego imprimir
            setTimeout(() => {
                printWindow.print();
            }, 250);
        }
        
        // Actualizar select de exportaci√≥n cuando se cargan datos
        const originalLoadData = loadData;
        loadData = async function() {
            await originalLoadData();
            updateExportSelect();
        };
        
        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('Inicializando aplicaci√≥n...');
                updateForm();
                loadData();
                console.log('Aplicaci√≥n inicializada correctamente');
            } catch (error) {
                console.error('Error al inicializar:', error);
                showAlert('Error al inicializar la aplicaci√≥n: ' + error.message, 'error');
            }
        });
        
        // Tambi√©n ejecutar inmediatamente si el DOM ya est√° listo
        if (document.readyState !== 'loading') {
            // DOM ya est√° listo
            try {
                console.log('üü° DOM ya est√° listo - Inicializando...');
                if (typeof window.updateForm === 'function') {
                    window.updateForm();
                }
                if (typeof window.loadData === 'function') {
                    window.loadData();
                }
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n inmediata:', error);
            }
        }
        
        // Usar event delegation para los botones de pesta√±as
        // Esto es m√°s confiable que onclick inline
        function setupTabListeners() {
            try {
                console.log('üî¥ Configurando event listeners para pesta√±as...');
                
                // Usar event delegation en el contenedor de pesta√±as
                const mainGrid = document.querySelector('.main-grid');
                if (!mainGrid) {
                    console.error('‚ùå No se encontr√≥ .main-grid');
                    setTimeout(setupTabListeners, 500);
                    return;
                }
                
                const gestionCard = mainGrid.querySelector('.card:first-child');
                if (!gestionCard) {
                    console.error('‚ùå No se encontr√≥ el panel de Gesti√≥n');
                    setTimeout(setupTabListeners, 500);
                    return;
                }
                
                const tabsContainer = gestionCard.querySelector('.tabs');
                if (!tabsContainer) {
                    console.error('‚ùå No se encontr√≥ el contenedor de pesta√±as');
                    setTimeout(setupTabListeners, 500);
                    return;
                }
                
                // Agregar event listener usando delegation
                tabsContainer.addEventListener('click', function(e) {
                    const button = e.target.closest('.tab');
                    if (!button) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const tabName = button.getAttribute('data-tab');
                    if (!tabName) {
                        console.error('‚ùå No se encontr√≥ data-tab en el bot√≥n');
                        return;
                    }
                    
                    console.log('üî¥ Click detectado en pesta√±a:', tabName);
                    
                    if (typeof window.switchTab === 'function') {
                        window.switchTab(tabName);
                    } else {
                        console.error('‚ùå window.switchTab no est√° disponible');
                        alert('Error: La funci√≥n switchTab no est√° disponible. Por favor, recargue la p√°gina.');
                    }
                });
                
                console.log('‚úÖ Event listeners configurados correctamente');
            } catch (error) {
                console.error('‚ùå Error configurando event listeners:', error);
                setTimeout(setupTabListeners, 1000);
            }
        }
        
        // Configurar listeners cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupTabListeners);
        } else {
            setupTabListeners();
        }
        
        // Tambi√©n intentar despu√©s de un peque√±o delay por si acaso
        setTimeout(setupTabListeners, 100);
    </script>
</body>
</html>
